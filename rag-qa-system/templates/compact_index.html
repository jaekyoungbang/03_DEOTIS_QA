<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🤖 RAG QA System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header-title {
            color: white;
            text-align: center;
            margin: 0;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .content-grid {
            display: flex;
            height: calc(100vh - 120px);
            gap: 0;
            position: relative;
        }
        
        .left-panel {
            width: 320px;
            min-width: 320px;
            background: #f7f7f8;
            border-right: 1px solid #e5e5e7;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: fixed;
            left: 0;
            top: 120px;
            height: calc(100vh - 120px);
            z-index: 100;
        }
        
        .left-panel-header {
            padding: 20px 16px 16px;
            border-bottom: 1px solid #e5e5e7;
            background: white;
        }
        
        .left-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .right-panel {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
            margin-left: 320px;
        }
        
        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid #e5e5e7;
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .chat-settings {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .section-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 8px;
            width: 16px;
        }
        
        .chat-container {
            flex: 1;
            background: white;
            overflow-y: auto;
            padding: 24px;
            scroll-behavior: smooth;
        }
        
        .chat-input-area {
            padding: 16px 24px;
            border-top: 1px solid #e5e5e7;
            background: white;
        }
        
        .chat-input-container {
            max-width: 768px;
            margin: 0 auto;
            position: relative;
        }
        
        .chat-input {
            width: 100%;
            min-height: 52px;
            max-height: 200px;
            padding: 14px 50px 14px 16px;
            border: 1px solid #d1d5db;
            border-radius: 26px;
            resize: none;
            font-size: 16px;
            line-height: 1.5;
            outline: none;
            transition: all 0.2s;
        }
        
        .chat-input:focus {
            border-color: #10a37f;
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }
        
        .send-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 18px;
            background: #10a37f;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .send-button:hover {
            background: #0d8c6b;
        }
        
        .send-button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        
        .message {
            margin-bottom: 32px;
            width: 100%;
        }
        
        .message-content {
            max-width: 768px;
            margin: 0 auto;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .user-avatar {
            background: #10a37f;
            color: white;
        }
        
        .ai-avatar {
            background: #f7f7f8;
            color: #374151;
            border: 1px solid #e5e5e7;
        }
        
        .message-text {
            flex: 1;
            padding: 0;
            line-height: 1.75;
            color: #374151;
        }
        
        .user-message .message-text {
            color: white;
            background: #10a37f;
            padding: 12px 16px;
            border-radius: 18px;
            margin-left: auto;
            max-width: fit-content;
        }
        
        .ai-message .message-text {
            color: #374151;
            background: transparent;
        }
        
        .ai-message h3 {
            color: #495057;
            font-size: 18px;
            margin-bottom: 12px;
        }
        
        .ai-message table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 13px;
        }
        
        .ai-message table th,
        .ai-message table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
        }
        
        .ai-message table th {
            background: #e7f3ff;
            font-weight: 600;
        }
        
        .ai-message strong {
            color: #0066cc;
        }
        
        .ai-message ul {
            padding-left: 20px;
        }
        
        .ai-message .list-check {
            list-style: none;
            padding-left: 0;
        }
        
        .ai-message .list-check li {
            padding-left: 25px;
            position: relative;
            margin-bottom: 5px;
        }
        
        .source-doc {
            font-size: 11px;
            color: #6c757d;
            background: #f1f3f5;
            padding: 8px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            border-top: 1px solid #e9ecef;
        }
        
        .compact-form-group {
            margin-bottom: 10px;
        }
        
        .compact-form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .btn-compact {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }
        
        .btn-action {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.4);
        }
        
        .btn-secondary-action {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            border: none;
            color: white;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #e7f3ff;
            color: #0066cc;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin: 2px;
        }
        
        .model-selector {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            border-radius: 8px;
        }
        
        .model-selector option {
            background: white;
            color: #495057;
        }
        
        /* Enhanced checkbox styling */
        .form-check-input {
            width: 1.2em;
            height: 1.2em;
            margin-top: 0.1em;
            background-color: #fff;
            border: 2px solid #007bff;
            border-radius: 0.25em;
            transition: all 0.15s ease-in-out;
        }
        
        .form-check-input:checked {
            background-color: #007bff;
            border-color: #007bff;
        }
        
        .form-check-input:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .form-check-label {
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            margin-left: 0.5rem;
            cursor: pointer;
        }
        
        /* FAQ buttons styling */
        .faq-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .btn-faq {
            font-size: 11px;
            padding: 6px 8px;
            text-align: left;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .btn-faq:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }
        
        /* Error message styling */
        .error-message {
            background: #fff5f5 !important;
            border-left: 4px solid #e53e3e !important;
            border-radius: 12px !important;
        }
        
        .error-message h3 {
            color: #c53030 !important;
            margin-bottom: 10px;
        }
        
        .error-code {
            background: #fed7d7;
            color: #c53030;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .error-solution {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .error-solution strong {
            color: #2f855a;
        }
        
        /* Success message styling */
        .success-message {
            background: #f0fff4 !important;
            border-left: 4px solid #38a169 !important;
            border-radius: 12px !important;
        }
        
        .success-message h3 {
            color: #2f855a !important;
            margin-bottom: 10px;
        }
        
        .progress-thin {
            height: 3px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .document-list {
            max-height: 120px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .document-item {
            padding: 6px 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Document status styling */
        .document-status {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .document-status.empty {
            background: #fff5f5;
            border: 1px solid #fed7d7;
        }
        
        .document-status.loaded {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
        }
        
        .status-icon {
            font-size: 16px;
            margin-right: 10px;
        }
        
        .status-text strong {
            font-size: 12px;
            display: block;
        }
        
        .status-text small {
            font-size: 10px;
            color: #666;
        }
        
        .document-section {
            margin-bottom: 10px;
        }
        
        .section-header {
            font-size: 11px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            padding-bottom: 3px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .s3-file {
            border-left: 3px solid #17a2b8;
        }
        
        .s3-badge {
            background: #17a2b8;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
        }
        
        .api-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #fd7e14, #e8590c);
            color: white;
            padding: 12px 16px;
            border-radius: 25px;
            text-decoration: none;
            box-shadow: 0 4px 20px rgba(253,126,20,0.4);
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .api-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(253,126,20,0.6);
            color: white;
        }
        
        @media (max-width: 1200px) {
            .left-panel {
                position: relative !important;
                width: 100%;
                height: auto;
                top: auto;
                left: auto;
                border-right: none;
                border-bottom: 1px solid #e5e5e7;
            }
            
            .right-panel {
                margin-left: 0;
            }
            
            .content-grid {
                flex-direction: column;
                height: auto;
            }
            
            .chat-container {
                height: 50vh;
            }
            
            .faq-buttons {
                flex-wrap: wrap;
                gap: 4px;
            }
            
            .faq-button {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            .settings-dropdown {
                right: 0;
                left: auto;
                min-width: 250px;
            }
        }
        
        /* Loading animation */
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        .loading-message {
            background: #e3f2fd !important;
            border-left: 4px solid #2196f3 !important;
            border-radius: 12px !important;
        }
        
        .loading-message h3 {
            color: #1976d2 !important;
            display: flex;
            align-items: center;
        }
        
        .loading-progress {
            margin-top: 10px;
            background: #e0e0e0;
            border-radius: 10px;
            height: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #2196f3, #21cbf3, #2196f3);
            height: 100%;
            width: 0%;
            animation: progressLoad 2s ease-in-out infinite;
            background-size: 200% 100%;
        }
        
        .completion-animation {
            font-size: 24px;
            display: inline-block;
            animation: bounce 0.6s ease-in-out;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes progressLoad {
            0% { width: 0%; background-position: 0% 50%; }
            50% { width: 70%; background-position: 100% 50%; }
            100% { width: 100%; background-position: 0% 50%; }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        /* Similarity Score Display */
        .similarity-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            border: 2px solid #e9ecef;
        }
        
        .similarity-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .similarity-header i {
            margin-right: 8px;
            color: #007bff;
        }
        
        .similarity-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
            position: relative;
        }
        
        .similarity-rank {
            position: absolute;
            top: -5px;
            left: -5px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }
        
        .similarity-score {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .score-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .score-bar {
            flex: 1;
            margin: 0 10px;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .score-progress {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 3px;
            transition: width 0.8s ease;
        }
        
        .similarity-preview {
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
            margin-bottom: 8px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .similarity-source {
            font-size: 11px;
            color: #007bff;
            font-weight: 500;
        }
        
        .similarity-meta {
            display: flex;
            justify-content: between;
            align-items: center;
            font-size: 10px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .query-highlight {
            background: rgba(0, 123, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            color: #007bff;
            border-left: 3px solid #007bff;
            margin-bottom: 10px;
        }
        
        .similarity-collapse {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .similarity-collapse.expanded {
            max-height: 500px;
        }
        
        .similarity-toggle {
            background: transparent;
            border: none;
            color: #007bff;
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
        }
        
        /* Cache indicator */
        .cache-indicator {
            display: inline-block;
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
            animation: fadeIn 0.3s ease;
        }
        
        .cache-indicator i {
            margin-right: 4px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* FAQ Buttons */
        .faq-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 8px 0;
        }
        
        .faq-button {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 16px;
            padding: 8px 14px;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .faq-button:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        /* Chat Header Styles */
        .chat-title h3 {
            margin: 0;
            color: #374151;
            font-size: 18px;
            font-weight: 600;
        }
        
        .chat-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        /* Settings Toggle */
        .settings-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 14px;
            color: #374151;
        }
        
        .settings-toggle:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        .settings-toggle i:last-child {
            transition: transform 0.2s;
        }
        
        .settings-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 12px;
            min-width: 280px;
            z-index: 1000;
            display: none;
            animation: fadeInDown 0.2s ease;
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .settings-row:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            font-size: 14px;
            color: #374151;
        }
        
        .setting-control {
            font-size: 14px;
        }
        
        .setting-control select {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 8px;
        }
        
        /* Admin Settings Button */
        .admin-settings-btn {
            position: fixed;
            bottom: 20px;
            right: 100px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102,126,234,0.4);
            transition: all 0.3s ease;
            font-size: 20px;
        }
        
        .admin-settings-btn:hover {
            transform: translateY(-3px) rotate(90deg);
            box-shadow: 0 6px 25px rgba(102,126,234,0.6);
        }
        
        /* Admin Modal */
        .admin-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        
        .admin-modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .admin-close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        
        .admin-close:hover {
            color: #000;
        }
        
        .admin-form {
            text-align: center;
            padding: 20px;
        }
        
        .admin-form input[type="password"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .admin-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }
        
        .admin-btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .admin-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        .admin-tab {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .admin-tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .admin-tab:hover {
            color: #667eea;
        }
        
        .admin-tab-content {
            display: none;
            padding: 20px 0;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        .admin-setting-group {
            margin-bottom: 20px;
        }
        
        .admin-setting-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .admin-setting-group input,
        .admin-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .admin-select {
            cursor: pointer;
        }
        
        .cache-status {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .admin-actions {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
        }
        
        .admin-save {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .admin-logout {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        #redisTestResult {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .test-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .cache-info {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .cache-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .admin-actions-inline {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .cache-stats-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #e9ecef;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .stats-card {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        
        .stats-card h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: #495057;
        }
        
        .stats-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        /* New Chat Button */
        .new-chat-section {
            padding: 16px;
            border-bottom: 1px solid #e5e5e7;
        }
        
        .btn-new-chat {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, #10a37f, #0d8c6b);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-new-chat:hover {
            background: linear-gradient(135deg, #0d8c6b, #0a7c5a);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }
        
        /* Chat History Styles */
        .chat-history-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-history-list {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .chat-history-item {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .chat-history-item:hover {
            background: #f3f4f6;
            border-left-color: #10a37f;
        }
        
        .chat-history-item.active {
            background: #e8f5f2;
            border-left-color: #10a37f;
            font-weight: 500;
        }
        
        .chat-history-title {
            color: #374151;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .chat-history-time {
            color: #9ca3af;
            font-size: 11px;
        }
        
        .chat-history-preview {
            color: #6b7280;
            font-size: 11px;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Collapsible Sections */
        .collapsible-section {
            margin-bottom: 8px;
        }
        
        .collapsible-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
            user-select: none;
        }
        
        .collapsible-header:hover {
            background: #f3f4f6;
            margin: -4px;
            padding: 4px;
            border-radius: 6px;
        }
        
        .toggle-icon {
            font-size: 12px;
            transition: transform 0.3s;
            color: #9ca3af;
        }
        
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .collapsible-content.collapsed {
            max-height: 0;
        }
        
        /* Empty State for Chat History */
        .chat-history-empty {
            text-align: center;
            padding: 20px 16px;
            color: #9ca3af;
            font-size: 13px;
        }
        
        .chat-history-empty i {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
            color: #d1d5db;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header-section">
            <h1 class="header-title">🤖 RAG QA System - Compact Edition</h1>
        </div>
        
        <div class="content-grid">
            <!-- Left Panel - Chat History & Controls -->
            <div class="left-panel">
                <!-- New Chat Button -->
                <div class="new-chat-section">
                    <button class="btn-new-chat" onclick="startNewChat()">
                        <i class="fas fa-plus"></i> 새 채팅
                    </button>
                </div>
                
                <!-- Chat History -->
                <div class="section-card chat-history-section">
                    <div class="section-title">
                        <i class="fas fa-history"></i>채팅 기록
                    </div>
                    <div class="chat-history-list" id="chatHistoryList">
                        <!-- Chat sessions will be loaded here -->
                    </div>
                </div>
                
                <!-- System Settings (Collapsible) -->
                <div class="section-card collapsible-section">
                    <div class="section-title collapsible-header" onclick="toggleSection('systemSettings')">
                        <i class="fas fa-cog"></i>시스템 설정
                        <i class="fas fa-chevron-down toggle-icon" id="systemSettingsIcon"></i>
                    </div>
                    <div class="collapsible-content" id="systemSettings">
                        <div class="compact-form-group">
                            <label>LLM 모델:</label>
                            <select class="form-select form-select-sm model-selector" id="llmModel">
                                <option value="gpt-4o-mini">GPT-4o-mini (빠름)</option>
                                <option value="gpt-4-turbo">GPT-4.1-mini (정확)</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-6 compact-form-group">
                                <label>청크:</label>
                                <input type="number" class="form-control form-control-sm" id="chunkSize" value="1000">
                            </div>
                            <div class="col-6 compact-form-group">
                                <label>겹침:</label>
                                <input type="number" class="form-control form-control-sm" id="chunkOverlap" value="200">
                            </div>
                        </div>
                        <div class="status-badge" id="vectorDbInfo">로딩중...</div>
                        <button class="btn btn-outline-danger btn-compact btn-sm float-end mt-2" onclick="clearVectorDB()">
                            <i class="fas fa-trash"></i> 벡터DB 초기화
                        </button>
                    </div>
                </div>
                
                <!-- Document Management (Collapsible) -->
                <div class="section-card collapsible-section">
                    <div class="section-title collapsible-header" onclick="toggleSection('documentManagement')">
                        <i class="fas fa-folder"></i>문서 관리
                        <i class="fas fa-chevron-down toggle-icon" id="documentManagementIcon"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="documentManagement">
                        <button class="btn btn-action btn-compact w-100 mb-2" id="s3LoadBtn" onclick="loadS3Documents()">
                            <i class="fas fa-download"></i> S3 폴더 로드
                        </button>
                        
                        <div class="input-group input-group-sm mb-2">
                            <input type="file" class="form-control form-control-sm" id="fileInput" accept=".pdf,.txt,.docx,.md">
                            <button class="btn btn-action btn-compact" id="uploadBtn" onclick="uploadDocument()">
                                <i class="fas fa-upload"></i>
                            </button>
                        </div>
                        
                        <div class="input-group input-group-sm mb-2">
                            <input type="text" class="form-control form-control-sm" id="textTitle" placeholder="제목">
                            <button class="btn btn-action btn-compact" onclick="toggleTextInput()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        
                        <div id="textInputSection" style="display:none;" class="mb-2">
                            <textarea class="form-control form-control-sm" id="textInput" rows="3" placeholder="텍스트 입력..."></textarea>
                            <button class="btn btn-secondary-action btn-compact mt-1" onclick="uploadText()">추가</button>
                        </div>
                        
                        <div class="document-list" id="documentList">
                            <!-- Documents will be loaded here -->
                        </div>
                        
                        <button class="btn btn-outline-danger btn-compact btn-sm w-100 mt-2" onclick="clearAllDocuments()">
                            <i class="fas fa-trash"></i> 전체 삭제
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel - Chat -->
            <div class="right-panel">
                <!-- Chat Header with FAQ and Settings -->
                <div class="chat-header">
                    <div class="chat-title">
                        <h3 style="margin: 0; color: #374151; font-size: 18px;">
                            <i class="fas fa-robot"></i> RAG QA System
                        </h3>
                    </div>
                    <div class="chat-controls">
                        <!-- Quick FAQ Buttons -->
                        <div class="faq-buttons">
                            <button class="faq-button" onclick="askQuestion('장기카드대출이란?')">💳 장기카드대출</button>
                            <button class="faq-button" onclick="askQuestion('단기카드대출 이용방법')">💰 단기카드대출</button>
                            <button class="faq-button" onclick="askQuestion('카드 할부 수수료')">📊 할부 수수료</button>
                            <button class="faq-button" onclick="askQuestion('신용공여기간이란')">📅 신용공여기간</button>
                        </div>
                        
                        <!-- Settings Dropdown -->
                        <div class="settings-container" style="position: relative;">
                            <div class="settings-toggle" onclick="toggleChatSettings()">
                                <i class="fas fa-cog"></i>
                                <span>설정</span>
                                <i class="fas fa-chevron-down" id="settingsChevron"></i>
                            </div>
                            <div class="settings-dropdown" id="chatSettingsDropdown">
                                <div class="settings-row">
                                    <span class="setting-label">LLM 모델</span>
                                    <div class="setting-control">
                                        <select id="llmModelHeader" class="form-select form-select-sm" onchange="syncLLMModel()">
                                            <option value="gpt-4o-mini">GPT-4o-mini</option>
                                            <option value="gpt-4-turbo">GPT-4.1-mini</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="settings-row">
                                    <span class="setting-label">대화 기록 사용</span>
                                    <div class="setting-control">
                                        <input type="checkbox" id="useMemoryHeader" onchange="syncMemorySettings()">
                                    </div>
                                </div>
                                <div class="settings-row">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="clearChat()">
                                        <i class="fas fa-eraser"></i> 대화 초기화
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-container" id="chatContainer">
                    <div class="message ai-message">
                        <h3>🚀 RAG QA System에 오신 것을 환영합니다!</h3>
                        <p><strong>사용법:</strong></p>
                        <ol>
                            <li>📁 <strong>S3 폴더 로드</strong> 또는 직접 파일 업로드</li>
                            <li>🤖 <strong>LLM 모델</strong> 선택 (GPT-4o-mini 추천)</li>
                            <li>❓ <strong>질문 입력</strong> 후 전송</li>
                        </ol>
                        <p><em>예시: "장기카드대출이란?", "단기카드대출 이용방법"</em></p>
                    </div>
                </div>
                
                <div class="chat-input-area">
                    <div class="chat-input-container">
                        <textarea class="chat-input" id="questionInput" placeholder="질문을 입력하세요..." onkeypress="handleKeyPress(event)" rows="1" style="resize: none; overflow-y: auto;"></textarea>
                        <button class="send-button" onclick="sendQuestion()" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Buttons -->
    <a href="/swagger/" class="api-link" target="_blank">
        <i class="fas fa-code"></i> API
    </a>
    
    <!-- Admin Settings Button -->
    <button class="admin-settings-btn" onclick="showAdminLogin()">
        <i class="fas fa-cog"></i>
    </button>
    
    <!-- Admin Login Modal -->
    <div id="adminModal" class="admin-modal">
        <div class="admin-modal-content">
            <span class="admin-close" onclick="closeAdminModal()">&times;</span>
            <h2><i class="fas fa-lock"></i> 관리자 설정</h2>
            
            <!-- Login Form -->
            <div id="adminLoginForm" class="admin-form">
                <input type="password" id="adminPassword" placeholder="관리자 비밀번호 입력" onkeypress="if(event.key==='Enter') adminLogin()">
                <button onclick="adminLogin()" class="admin-btn">로그인</button>
            </div>
            
            <!-- Settings Panel -->
            <div id="adminSettingsPanel" style="display:none;">
                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="switchAdminTab('cache')">캐시 설정</button>
                    <button class="admin-tab" onclick="switchAdminTab('chunk')">청크 전략</button>
                    <button class="admin-tab" onclick="switchAdminTab('redis')">Redis 설정</button>
                    <button class="admin-tab" onclick="switchAdminTab('password')">비밀번호</button>
                </div>
                
                <!-- Cache Settings Tab -->
                <div id="cacheTab" class="admin-tab-content active">
                    <h3>하이브리드 캐시 시스템</h3>
                    <div class="cache-info">
                        <p><strong>🚀 Redis + RDB 하이브리드</strong></p>
                        <p>• Redis: 24시간 임시 캐시</p>
                        <p>• RDB: 인기 질문 영구 저장</p>
                        <p>• 자동 문서 변경 감지</p>
                    </div>
                    
                    <div class="admin-setting-group">
                        <label>인기 질문 기준 (조회수)</label>
                        <input type="number" id="popularThreshold" value="5" min="2" max="20">
                        <small>이 횟수 이상 조회된 질문은 RDB에 영구 저장됩니다</small>
                    </div>
                    
                    <div class="admin-setting-group">
                        <label>Redis TTL (시간)</label>
                        <input type="number" id="cacheTTL" value="24" min="1" max="168">
                        <small>Redis 임시 캐시 유지 시간</small>
                    </div>
                    
                    <div class="admin-actions-inline">
                        <button onclick="validateDocuments()" class="admin-btn-small">
                            <i class="fas fa-sync"></i> 문서 변경 감지
                        </button>
                        <button onclick="loadCacheStats()" class="admin-btn-small">
                            <i class="fas fa-chart-bar"></i> 캐시 통계
                        </button>
                    </div>
                    
                    <div id="cacheStatsDisplay" class="cache-stats-display" style="display:none;">
                        <!-- 캐시 통계가 여기에 표시됩니다 -->
                    </div>
                    
                    <div class="cache-status" id="cacheStatus">
                        현재 시스템: <span id="currentCacheType">하이브리드 캐시</span>
                    </div>
                </div>
                
                <!-- Chunk Strategy Tab -->
                <div id="chunkTab" class="admin-tab-content">
                    <h3>청크 전략 설정</h3>
                    <div class="admin-setting-group">
                        <label>청크 크기</label>
                        <input type="number" id="chunkSize" value="1000" min="100" max="5000">
                    </div>
                    <div class="admin-setting-group">
                        <label>청크 겹침</label>
                        <input type="number" id="chunkOverlap" value="200" min="0" max="500">
                    </div>
                    <div class="admin-setting-group">
                        <label>구분자</label>
                        <select id="chunkSeparator" class="admin-select">
                            <option value="\n\n">이중 줄바꿈</option>
                            <option value="\n">단일 줄바꿈</option>
                            <option value=". ">마침표</option>
                        </select>
                    </div>
                </div>
                
                <!-- Redis Settings Tab -->
                <div id="redisTab" class="admin-tab-content">
                    <h3>Redis 연결 설정</h3>
                    <div class="admin-setting-group">
                        <label>호스트</label>
                        <input type="text" id="redisHost" value="localhost">
                    </div>
                    <div class="admin-setting-group">
                        <label>포트</label>
                        <input type="number" id="redisPort" value="6379">
                    </div>
                    <div class="admin-setting-group">
                        <label>비밀번호 (선택)</label>
                        <input type="password" id="redisPassword" placeholder="Redis 비밀번호">
                    </div>
                    <button onclick="testRedisConnection()" class="admin-btn-small">연결 테스트</button>
                    <div id="redisTestResult"></div>
                </div>
                
                <!-- Password Tab -->
                <div id="passwordTab" class="admin-tab-content">
                    <h3>비밀번호 변경</h3>
                    <div class="admin-setting-group">
                        <label>새 비밀번호</label>
                        <input type="password" id="newPassword" placeholder="최소 6자 이상">
                    </div>
                    <div class="admin-setting-group">
                        <label>비밀번호 확인</label>
                        <input type="password" id="confirmPassword" placeholder="비밀번호 재입력">
                    </div>
                    <button onclick="changePassword()" class="admin-btn-small">변경</button>
                </div>
                
                <!-- Save Button -->
                <div class="admin-actions">
                    <button onclick="saveAdminSettings()" class="admin-btn admin-save">
                        <i class="fas fa-save"></i> 설정 저장
                    </button>
                    <button onclick="adminLogout()" class="admin-btn admin-logout">
                        <i class="fas fa-sign-out-alt"></i> 로그아웃
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let isLoading = false;

        window.onload = function() {
            loadDocumentList();
            loadVectorDBInfo();
            setupTextareaAutoResize();
            loadChatHistory();
            startNewChat(); // 초기 채팅 시작
            
            // Sync initial settings
            const leftLLMModel = document.getElementById('llmModel');
            
            if (leftLLMModel) {
                document.getElementById('llmModelHeader').value = leftLLMModel.value;
            }
        };
        
        function renderSimilarityPanel(similarityData, query, cacheInfo = null) {
            let panel = `<div class="similarity-panel">
                <div class="similarity-header">
                    <i class="fas fa-search"></i>유사도 검색 결과 (${similarityData.total_results}개 중 상위 3개)
                </div>
                <div class="query-highlight">
                    <i class="fas fa-question-circle"></i> 질의: "${query}"
                </div>`;
            
            // Add cache source info if available
            if (cacheInfo) {
                let cacheSourceText = '';
                let cacheSourceColor = '';
                
                if (cacheInfo.source === 'redis') {
                    cacheSourceText = `⚡ Redis 캐시에서 가져옴 (${cacheInfo.hit_count}회 조회)`;
                    cacheSourceColor = '#ffc107';
                } else if (cacheInfo.source === 'popular_db') {
                    cacheSourceText = `⭐ 인기질문 DB에서 가져옴 (${cacheInfo.hit_count}회 조회)`;
                    cacheSourceColor = '#28a745';
                }
                
                panel += `<div style="background: ${cacheSourceColor}22; border-left: 3px solid ${cacheSourceColor}; padding: 8px 12px; margin: 10px 0; border-radius: 6px; font-size: 12px;">
                    ${cacheSourceText}
                </div>`;
            }
            
            similarityData.top_matches.forEach((match, index) => {
                const scoreColor = match.similarity_percentage >= 80 ? '#28a745' : 
                                 match.similarity_percentage >= 60 ? '#ffc107' : '#dc3545';
                
                panel += `<div class="similarity-item">
                    <div class="similarity-rank">${match.rank}</div>
                    <div class="similarity-score">
                        <span class="score-badge">${match.similarity_percentage}%</span>
                        <div class="score-bar">
                            <div class="score-progress" style="width: ${match.similarity_percentage}%; background: linear-gradient(90deg, ${scoreColor}, ${scoreColor}aa)"></div>
                        </div>
                        <small style="color: ${scoreColor}; font-weight: 600;">${match.similarity_score}</small>
                    </div>
                    <div class="similarity-preview">${match.content_preview}</div>
                    <div class="similarity-source">
                        <i class="fas fa-file-alt"></i> ${match.document_title}
                    </div>
                    <div class="similarity-meta">
                        <span>출처: ${match.document_source}</span>
                    </div>
                </div>`;
            });
            
            panel += '</div>';
            return panel;
        }

        function toggleTextInput() {
            const section = document.getElementById('textInputSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !isLoading) {
                sendQuestion();
            }
        }

        // Enhanced markdown formatting
        function formatMarkdown(text) {
            text = formatTables(text);
            text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = formatLists(text);
            text = text.replace(/\n\n/g, '</p><p>');
            text = '<p>' + text + '</p>';
            text = text.replace(/<p><\/p>/g, '');
            text = text.replace(/<p>(<[h|t|u|o])/g, '$1');
            text = text.replace(/(<\/[h|t|u|o][^>]*>)<\/p>/g, '$1');
            return text;
        }

        function formatTables(text) {
            const tablePattern = /(\|[^|\n]*\|[^|\n]*\|[^\n]*\n)+/g;
            return text.replace(tablePattern, (match) => {
                const rows = match.trim().split('\n');
                if (rows.length < 2) return match;
                
                let table = '<table class="table table-sm table-striped">';
                let hasHeader = false;
                
                rows.forEach((row, index) => {
                    if (row.includes('---')) {
                        hasHeader = true;
                        return;
                    }
                    
                    const cells = row.split('|').map(cell => cell.trim()).filter(cell => cell !== '');
                    if (cells.length === 0) return;
                    
                    const isHeader = (index === 0 && !hasHeader);
                    const tag = isHeader ? 'th' : 'td';
                    
                    if (isHeader) table += '<thead>';
                    else if (index === 1 && hasHeader) table += '</thead><tbody>';
                    else if (index === 1) table += '<tbody>';
                    
                    table += '<tr>';
                    cells.forEach(cell => {
                        let cellContent = cell.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        table += `<${tag}>${cellContent}</${tag}>`;
                    });
                    table += '</tr>';
                });
                
                table += hasHeader ? '</tbody></table>' : '</tbody></table>';
                return table;
            });
        }

        function formatLists(text) {
            const lines = text.split('\n');
            let result = [];
            let inList = false;
            let listType = '';
            
            for (let line of lines) {
                const isCheckItem = /^\s*[-*+]\s*✅\s*(.+)/.test(line);
                const isUnorderedItem = /^\s*[-*+]\s+(.+)/.test(line);
                const isOrderedItem = /^\s*\d+\.\s+(.+)/.test(line);
                
                if (isCheckItem) {
                    const content = line.replace(/^\s*[-*+]\s*✅\s*/, '');
                    if (!inList || listType !== 'check') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ul class="list-check">');
                        inList = true;
                        listType = 'check';
                    }
                    result.push(`<li><i class="fas fa-check-circle text-success"></i> ${content}</li>`);
                } else if (isUnorderedItem) {
                    const content = line.replace(/^\s*[-*+]\s+/, '');
                    if (!inList || listType !== 'ul') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ul>');
                        inList = true;
                        listType = 'ul';
                    }
                    result.push(`<li>${content}</li>`);
                } else if (isOrderedItem) {
                    const content = line.replace(/^\s*\d+\.\s+/, '');
                    if (!inList || listType !== 'ol') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ol>');
                        inList = true;
                        listType = 'ol';
                    }
                    result.push(`<li>${content}</li>`);
                } else {
                    if (inList) {
                        result.push(`</${listType}>`);
                        inList = false;
                        listType = '';
                    }
                    result.push(line);
                }
            }
            
            if (inList) result.push(`</${listType}>`);
            return result.join('\n');
        }

        async function sendQuestion() {
            if (isLoading) return;
            
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            if (!question) return;

            isLoading = true;
            const chatContainer = document.getElementById('chatContainer');
            const useMemoryHeader = document.getElementById('useMemoryHeader');
            const useMemory = useMemoryHeader ? useMemoryHeader.checked : false;
            const llmModelHeader = document.getElementById('llmModelHeader');
            const llmModel = llmModelHeader ? llmModelHeader.value : 'gpt-4o-mini';

            // Add user message
            chatContainer.innerHTML += `<div class="message user-message">${question}</div>`;
            
            // Add loading indicator
            chatContainer.innerHTML += `<div class="message ai-message" id="loadingMsg"><div class="loading"></div> 생각하는 중...</div>`;
            input.value = '';
            input.style.height = 'auto'; // 태스크에리아 높이 리셋
            document.getElementById('sendButton').disabled = true; // 버튼 비활성화
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch('/api/rag/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        question: question,
                        use_memory: useMemory,
                        llm_model: llmModel
                    })
                });

                const data = await response.json();
                
                // Remove loading message
                document.getElementById('loadingMsg').remove();
                
                if (data.error) {
                    let errorHTML = `<div class="message ai-message error-message">
                        <h3>🚨 ${data.title || '오류 발생'}</h3>`;
                    
                    if (data.error_code) {
                        errorHTML += `<div class="error-code">오류 코드: ${data.error_code}</div>`;
                    }
                    
                    errorHTML += `<p><strong>문제:</strong> ${data.message || data.error}</p>`;
                    
                    if (data.solution) {
                        errorHTML += `<div class="error-solution">
                            <strong>💡 해결 방법:</strong><br>
                            ${data.solution.replace(/\n/g, '<br>')}
                        </div>`;
                    }
                    
                    errorHTML += `</div>`;
                    chatContainer.innerHTML += errorHTML;
                } else {
                    const formattedAnswer = formatMarkdown(data.answer);
                    let aiMessage = `<div class="message ai-message">${formattedAnswer}`;
                    
                    // Add cache indicator with source info
                    if (data._from_cache || data._cache_source) {
                        let cacheIcon = '';
                        let cacheText = '';
                        let cacheColor = '';
                        
                        if (data._cache_source === 'redis') {
                            cacheIcon = '<i class="fas fa-bolt"></i>';
                            cacheText = 'Redis 캐시 (임시)';
                            cacheColor = 'linear-gradient(135deg, #ffc107, #ff9800)';
                        } else if (data._cache_source === 'popular_db') {
                            cacheIcon = '<i class="fas fa-star"></i>';
                            cacheText = '인기질문 DB (영구)';
                            cacheColor = 'linear-gradient(135deg, #28a745, #20c997)';
                        } else if (data._from_cache) {
                            cacheIcon = '<i class="fas fa-bolt"></i>';
                            cacheText = '캐시된 응답';
                            cacheColor = 'linear-gradient(135deg, #ffc107, #ff9800)';
                        }
                        
                        aiMessage += `<div class="cache-indicator" style="background: ${cacheColor}">
                            ${cacheIcon} ${cacheText}
                            ${data._hit_count ? `| 조회수: ${data._hit_count}회` : ''}
                        </div>`;
                    }
                    
                    aiMessage += `<div class="mt-2"><small class="text-muted">🤖 ${data.model_used || llmModel}</small></div>`;
                    
                    if (data.source_documents && data.source_documents.length > 0) {
                        aiMessage += '<div class="source-doc"><strong>📄 참고:</strong> ';
                        data.source_documents.slice(0, 2).forEach((doc, idx) => {
                            aiMessage += `${doc.metadata.source_file || doc.metadata.title || doc.metadata.filename || 'Unknown'}${idx < 1 && data.source_documents.length > 1 ? ', ' : ''}`;
                        });
                        if (data.source_documents.length > 2) aiMessage += ` 외 ${data.source_documents.length - 2}개`;
                        aiMessage += '</div>';
                    }
                    
                    // Add similarity search panel (always show if available)
                    if (data.similarity_search && data.similarity_search.top_matches && data.similarity_search.top_matches.length > 0) {
                        // Add cache source info to similarity panel
                        const cacheInfo = data._cache_source ? {
                            source: data._cache_source,
                            hit_count: data._hit_count || 0
                        } : null;
                        
                        aiMessage += renderSimilarityPanel(data.similarity_search, question, cacheInfo);
                    }
                    
                    aiMessage += '</div>';
                    chatContainer.innerHTML += aiMessage;
                    
                    // 채팅 세션 업데이트 (첫 번째 질문이면 제목 업데이트)
                    if (currentChatId && chatSessions[currentChatId]) {
                        if (chatSessions[currentChatId].title === '새 채팅') {
                            chatSessions[currentChatId].title = question.length > 30 ? question.substring(0, 30) + '...' : question;
                            updateChatHistory();
                        }
                        chatSessions[currentChatId].updatedAt = new Date();
                    }
                }
            } catch (error) {
                document.getElementById('loadingMsg').remove();
                chatContainer.innerHTML += `<div class="message ai-message">❌ 연결 오류: ${error.message}</div>`;
            }

            isLoading = false;
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // 채팅 세션 저장
            if (currentChatId) {
                saveChatSession(currentChatId);
                updateChatHistory();
            }
        }

        async function loadS3Documents() {
            if (isLoading) return;
            isLoading = true;
            
            const s3LoadBtn = document.getElementById('s3LoadBtn');
            const chatContainer = document.getElementById('chatContainer');
            
            // 버튼 로딩 상태로 변경
            const originalBtnContent = s3LoadBtn.innerHTML;
            s3LoadBtn.innerHTML = '<div class="loading"></div> 로딩 중...';
            s3LoadBtn.disabled = true;
            
            // 채팅창에 로딩 메시지 추가
            const loadingMessageId = 'loading-msg-' + Date.now();
            chatContainer.innerHTML += `<div class="message ai-message loading-message" id="${loadingMessageId}">
                <h3><div class="loading-spinner"></div> S3 폴더 로딩 중...</h3>
                <p>문서를 불러와서 처리하고 있습니다. 잠시만 기다려주세요...</p>
                <div class="loading-progress">
                    <div class="progress-bar"></div>
                </div>
            </div>`;
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                const response = await fetch('/api/document/load-s3', { method: 'POST' });
                const data = await response.json();
                
                // 로딩 메시지 제거
                document.getElementById(loadingMessageId)?.remove();
                
                if (data.error) {
                    chatContainer.innerHTML += `<div class="message ai-message error-message">
                        <h3>🚨 S3 폴더 로드 실패</h3>
                        <p>${data.error}</p>
                    </div>`;
                } else {
                    // 성공 메시지를 채팅창에 표시
                    chatContainer.innerHTML += `<div class="message ai-message success-message">
                        <h3>✅ S3 폴더 로드 완료</h3>
                        <p><strong>${data.documents_loaded || 0}개 문서</strong>가 성공적으로 로드되어 <strong>${data.total_chunks || 0}개 청크</strong>로 처리되었습니다.</p>
                        <p>🎯 이제 BC카드 관련 질문을 하실 수 있습니다!</p>
                        <div class="completion-animation">🎉</div>
                    </div>`;
                    
                    loadDocumentList();
                    loadVectorDBInfo();
                }
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
            } catch (error) {
                // 로딩 메시지 제거
                document.getElementById(loadingMessageId)?.remove();
                
                chatContainer.innerHTML += `<div class="message ai-message error-message">
                    <h3>🚨 연결 오류</h3>
                    <p>네트워크 오류: ${error.message}</p>
                </div>`;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } finally {
                // 버튼 원래 상태로 복원
                s3LoadBtn.innerHTML = originalBtnContent;
                s3LoadBtn.disabled = false;
                isLoading = false;
            }
        }

        async function uploadDocument() {
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const chatContainer = document.getElementById('chatContainer');
            const file = fileInput.files[0];
            if (!file) return;

            // 버튼 로딩 상태로 변경
            const originalBtnContent = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<div class="loading"></div>';
            uploadBtn.disabled = true;
            fileInput.disabled = true;

            // 채팅창에 로딩 메시지 추가
            const loadingMessageId = 'upload-loading-' + Date.now();
            chatContainer.innerHTML += `<div class="message ai-message loading-message" id="${loadingMessageId}">
                <h3><div class="loading-spinner"></div> 파일 업로드 중...</h3>
                <p><strong>${file.name}</strong> 파일을 업로드하고 처리하고 있습니다...</p>
                <div class="loading-progress">
                    <div class="progress-bar"></div>
                </div>
            </div>`;
            chatContainer.scrollTop = chatContainer.scrollHeight;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/document/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                // 로딩 메시지 제거
                document.getElementById(loadingMessageId)?.remove();
                
                if (data.error) {
                    chatContainer.innerHTML += `<div class="message ai-message error-message">
                        <h3>🚨 파일 업로드 실패</h3>
                        <p>${data.error}</p>
                    </div>`;
                } else {
                    // 성공 메시지를 채팅창에 표시
                    chatContainer.innerHTML += `<div class="message ai-message success-message">
                        <h3>✅ 파일 업로드 완료</h3>
                        <p><strong>${data.filename || '파일'}</strong> 파일이 성공적으로 업로드되어 <strong>${data.chunks_created || 0}개 청크</strong>로 처리되었습니다.</p>
                        <div class="completion-animation">🎉</div>
                    </div>`;
                    
                    fileInput.value = '';
                    loadDocumentList();
                    loadVectorDBInfo();
                }
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
            } catch (error) {
                // 로딩 메시지 제거
                document.getElementById(loadingMessageId)?.remove();
                
                chatContainer.innerHTML += `<div class="message ai-message error-message">
                    <h3>🚨 업로드 오류</h3>
                    <p>네트워크 오류: ${error.message}</p>
                </div>`;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } finally {
                // 버튼과 입력 필드 원래 상태로 복원
                uploadBtn.innerHTML = originalBtnContent;
                uploadBtn.disabled = false;
                fileInput.disabled = false;
            }
        }

        async function uploadText() {
            const textInput = document.getElementById('textInput');
            const titleInput = document.getElementById('textTitle');
            const text = textInput.value.trim();
            const title = titleInput.value.trim() || 'Direct Input ' + new Date().toLocaleTimeString();
            
            if (!text) return;

            try {
                const response = await fetch('/api/document/upload-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, title })
                });

                const data = await response.json();
                if (data.error) {
                    alert(`❌ ${data.error}`);
                } else {
                    // 성공 메시지를 채팅창에 표시
                    const chatContainer = document.getElementById('chatContainer');
                    chatContainer.innerHTML += `<div class="message ai-message success-message">
                        <h3>✅ 텍스트 추가 완료</h3>
                        <p><strong>${data.title || '텍스트'}</strong> 텍스트가 성공적으로 추가되어 <strong>${data.chunks_created || 0}개 청크</strong>로 처리되었습니다.</p>
                    </div>`;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                    textInput.value = '';
                    titleInput.value = '';
                    toggleTextInput();
                    loadDocumentList();
                    loadVectorDBInfo();
                }
            } catch (error) {
                alert(`❌ ${error.message}`);
            }
        }

        async function loadDocumentList() {
            try {
                const response = await fetch('/api/document/list');
                const data = await response.json();
                
                const listContainer = document.getElementById('documentList');
                let html = '';
                
                // 벡터DB 상태 표시
                if (!data.has_documents) {
                    html += `<div class="document-status empty">
                        <div class="status-icon">⚠️</div>
                        <div class="status-text">
                            <strong>문서가 로드되지 않음</strong><br>
                            <small>S3 폴더 로드 또는 파일 업로드 필요</small>
                        </div>
                    </div>`;
                } else {
                    html += `<div class="document-status loaded">
                        <div class="status-icon">✅</div>
                        <div class="status-text">
                            <strong>문서 로드 완료</strong><br>
                            <small>${data.total_chunks}개 청크 준비됨</small>
                        </div>
                    </div>`;
                }
                
                // S3 폴더 문서 표시
                if (data.s3_files && data.s3_files.length > 0) {
                    html += `<div class="document-section">
                        <div class="section-header">📁 S3 폴더 (${data.s3_files.length}개)</div>`;
                    data.s3_files.slice(0, 3).forEach(file => {
                        html += `<div class="document-item s3-file">
                            <span>📄 ${file.filename.length > 18 ? file.filename.substring(0, 18) + '...' : file.filename}</span>
                            <small class="s3-badge">S3</small>
                        </div>`;
                    });
                    if (data.s3_files.length > 3) {
                        html += `<div class="text-center text-muted"><small>+${data.s3_files.length - 3}개 더</small></div>`;
                    }
                    html += '</div>';
                }
                
                // 업로드된 파일 표시
                if (data.files && data.files.length > 0) {
                    html += `<div class="document-section">
                        <div class="section-header">📤 업로드 (${data.files.length}개)</div>`;
                    data.files.slice(0, 2).forEach(file => {
                        html += `<div class="document-item">
                            <span>📄 ${file.filename.length > 18 ? file.filename.substring(0, 18) + '...' : file.filename}</span>
                            <small>${(file.size / 1024).toFixed(1)}KB</small>
                        </div>`;
                    });
                    if (data.files.length > 2) {
                        html += `<div class="text-center text-muted"><small>+${data.files.length - 2}개 더</small></div>`;
                    }
                    html += '</div>';
                }
                
                if (!data.s3_files?.length && !data.files?.length) {
                    html += '<div class="text-center text-muted"><small>문서 없음</small></div>';
                }
                
                listContainer.innerHTML = html;
            } catch (error) {
                console.error('문서 목록 로드 실패:', error);
                document.getElementById('documentList').innerHTML = 
                    '<div class="text-center text-danger"><small>로드 실패</small></div>';
            }
        }

        async function loadVectorDBInfo() {
            try {
                const response = await fetch('/api/rag/vectordb/info');
                const data = await response.json();
                
                document.getElementById('vectorDbInfo').innerHTML = `📊 ${data.total_documents}개 문서`;
            } catch (error) {
                console.error('벡터DB 정보 로드 실패:', error);
            }
        }

        async function clearVectorDB() {
            if (!confirm('벡터DB를 초기화하시겠습니까?')) return;

            try {
                const response = await fetch('/api/rag/vectordb/clear', { method: 'DELETE' });
                const data = await response.json();
                alert('✅ 벡터DB 초기화 완료');
                loadDocumentList();
                loadVectorDBInfo();
            } catch (error) {
                alert(`❌ ${error.message}`);
            }
        }

        async function clearAllDocuments() {
            if (!confirm('모든 문서를 삭제하시겠습니까?')) return;

            try {
                const response = await fetch('/api/document/clear-all', { method: 'DELETE' });
                alert('✅ 문서 삭제 완료');
                loadDocumentList();
                loadVectorDBInfo();
            } catch (error) {
                alert(`❌ ${error.message}`);
            }
        }

        function askQuestion(question) {
            if (isLoading) return;
            
            const input = document.getElementById('questionInput');
            input.value = question;
            sendQuestion();
        }

        function clearChat() {
            // 새 채팅 시작 (기존 clearChat 대신)
            startNewChat();
        }
        
        // Chat settings functions
        function toggleChatSettings() {
            const dropdown = document.getElementById('chatSettingsDropdown');
            const chevron = document.getElementById('settingsChevron');
            
            if (dropdown.style.display === 'none' || !dropdown.style.display) {
                dropdown.style.display = 'block';
                chevron.style.transform = 'rotate(180deg)';
            } else {
                dropdown.style.display = 'none';
                chevron.style.transform = 'rotate(0deg)';
            }
        }
        
        function syncLLMModel() {
            const headerModel = document.getElementById('llmModelHeader').value;
            const leftPanelModel = document.getElementById('llmModel');
            if (leftPanelModel) {
                leftPanelModel.value = headerModel;
            }
        }
        
        function syncMemorySettings() {
            const headerMemory = document.getElementById('useMemoryHeader').checked;
            const leftPanelMemory = document.getElementById('useMemory');
            if (leftPanelMemory) {
                leftPanelMemory.checked = headerMemory;
            }
        }
        
        // Auto-resize textarea
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('questionInput');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
                
                // Enable/disable send button based on content
                const sendButton = document.getElementById('sendButton');
                sendButton.disabled = !this.value.trim();
            });
            
            // Initialize button state
            document.getElementById('sendButton').disabled = true;
        }
        
        // Chat Session Functions
        function startNewChat() {
            // 기존 채팅 저장
            if (currentChatId && chatSessions[currentChatId]) {
                saveChatSession(currentChatId);
            }
            
            // 새 채팅 ID 생성
            currentChatId = 'chat_' + Date.now();
            
            // 새 채팅 세션 생성
            chatSessions[currentChatId] = {
                id: currentChatId,
                title: '새 채팅',
                messages: [],
                createdAt: new Date(),
                updatedAt: new Date()
            };
            
            // 채팅 컵테이너 초기화
            document.getElementById('chatContainer').innerHTML = 
                `<div class="message ai-message">
                    <h3>🚀 새 채팅이 시작되었습니다!</h3>
                    <p><strong>사용법:</strong></p>
                    <ol>
                        <li>📁 <strong>S3 폴더 로드</strong> 또는 직접 파일 업로드</li>
                        <li>🤖 <strong>LLM 모델</strong> 선택 (GPT-4o-mini 추천)</li>
                        <li>❓ <strong>질문 입력</strong> 후 전송</li>
                    </ol>
                    <p><em>예시: "장기카드대출이란?", "단기카드대출 이용방법"</em></p>
                    <div class="cache-indicator" style="background: linear-gradient(135deg, #10a37f, #0d8c6b); margin-top: 15px;">
                        <i class="fas fa-database"></i> Redis 캐시된 데이터는 모든 사용자가 공유합니다
                    </div>
                </div>`;
            
            // 채팅 기록 업데이트
            updateChatHistory();
            
            // 주의: 메모리만 초기화, Redis 캐시는 유지하여 모든 사용자가 공유
            fetch('/api/chat/clear-memory', { method: 'POST' });
        }
        
        function saveChatSession(chatId) {
            if (!chatSessions[chatId]) return;
            
            const chatContainer = document.getElementById('chatContainer');
            const messages = Array.from(chatContainer.children);
            
            chatSessions[chatId].messages = messages.map(msg => ({
                content: msg.innerHTML,
                className: msg.className,
                timestamp: new Date()
            }));
            
            chatSessions[chatId].updatedAt = new Date();
            
            // 첫 번째 사용자 메시지로 제목 업데이트
            const firstUserMessage = messages.find(msg => msg.classList.contains('user-message'));
            if (firstUserMessage && chatSessions[chatId].title === '새 채팅') {
                const text = firstUserMessage.textContent || firstUserMessage.innerText;
                chatSessions[chatId].title = text.length > 30 ? text.substring(0, 30) + '...' : text;
            }
            
            // 로컬스토리지에 저장
            localStorage.setItem('chatSessions', JSON.stringify(chatSessions));
        }
        
        function loadChatSession(chatId) {
            if (!chatSessions[chatId]) return;
            
            // 기존 채팅 저장
            if (currentChatId && currentChatId !== chatId) {
                saveChatSession(currentChatId);
            }
            
            currentChatId = chatId;
            const session = chatSessions[chatId];
            
            // 채팅 컵테이너에 메시지 복원
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            
            session.messages.forEach(msgData => {
                const messageDiv = document.createElement('div');
                messageDiv.className = msgData.className;
                messageDiv.innerHTML = msgData.content;
                chatContainer.appendChild(messageDiv);
            });
            
            // 스크롤 하단으로
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // 채팅 기록 업데이트
            updateChatHistory();
        }
        
        function loadChatHistory() {
            const saved = localStorage.getItem('chatSessions');
            if (saved) {
                chatSessions = JSON.parse(saved);
                
                // Date 객체로 변환
                Object.keys(chatSessions).forEach(id => {
                    chatSessions[id].createdAt = new Date(chatSessions[id].createdAt);
                    chatSessions[id].updatedAt = new Date(chatSessions[id].updatedAt);
                });
            }
            updateChatHistory();
        }
        
        function updateChatHistory() {
            const historyList = document.getElementById('chatHistoryList');
            const sessions = Object.values(chatSessions)
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            
            if (sessions.length === 0) {
                historyList.innerHTML = `
                    <div class="chat-history-empty">
                        <i class="fas fa-comments"></i>
                        아직 채팅 기록이 없습니다.
                    </div>`;
                return;
            }
            
            historyList.innerHTML = sessions.map(session => {
                const isActive = session.id === currentChatId;
                const timeStr = formatChatTime(session.updatedAt);
                const preview = getChatPreview(session.messages);
                
                return `
                    <div class="chat-history-item ${isActive ? 'active' : ''}" 
                         onclick="loadChatSession('${session.id}')">
                        <div class="chat-history-title">${session.title}</div>
                        <div class="chat-history-time">${timeStr}</div>
                        ${preview ? `<div class="chat-history-preview">${preview}</div>` : ''}
                    </div>`;
            }).join('');
        }
        
        function formatChatTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) return '방금 전';
            if (minutes < 60) return `${minutes}분 전`;
            if (hours < 24) return `${hours}시간 전`;
            if (days < 7) return `${days}일 전`;
            
            return date.toLocaleDateString('ko-KR', {
                month: 'short',
                day: 'numeric'
            });
        }
        
        function getChatPreview(messages) {
            const lastAiMessage = messages.slice().reverse().find(msg => 
                msg.className && msg.className.includes('ai-message'));
            
            if (!lastAiMessage) return null;
            
            const text = lastAiMessage.content.replace(/<[^>]*>/g, '').trim();
            return text.length > 50 ? text.substring(0, 50) + '...' : text;
        }
        
        // Collapsible sections
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + 'Icon');
            
            content.classList.toggle('collapsed');
            icon.classList.toggle('rotated');
        }
        
        // Close settings dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const settingsContainer = document.querySelector('.settings-container');
            const dropdown = document.getElementById('chatSettingsDropdown');
            const chevron = document.getElementById('settingsChevron');
            
            if (settingsContainer && !settingsContainer.contains(event.target)) {
                if (dropdown) {
                    dropdown.style.display = 'none';
                    chevron.style.transform = 'rotate(0deg)';
                }
            }
        });
        // Chat Session Management
        let currentChatId = null;
        let chatSessions = {};
        let sessionCounter = 1;
        
        // Admin Settings Functions
        let adminToken = null;
        
        function showAdminLogin() {
            document.getElementById('adminModal').style.display = 'block';
        }
        
        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
            document.getElementById('adminPassword').value = '';
        }
        
        async function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            
            if (!password) {
                alert('비밀번호를 입력하세요');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.token) {
                    adminToken = data.token;
                    document.getElementById('adminLoginForm').style.display = 'none';
                    document.getElementById('adminSettingsPanel').style.display = 'block';
                    await loadAdminSettings();
                } else {
                    alert(data.error || '로그인 실패');
                }
                
            } catch (error) {
                alert('로그인 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        function adminLogout() {
            adminToken = null;
            document.getElementById('adminLoginForm').style.display = 'block';
            document.getElementById('adminSettingsPanel').style.display = 'none';
            closeAdminModal();
        }
        
        function switchAdminTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.admin-tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        async function loadAdminSettings() {
            if (!adminToken) return;
            
            try {
                const response = await fetch('/api/admin/settings', {
                    headers: { 'Authorization': 'Bearer ' + adminToken }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Load cache settings (hybrid)
                    document.getElementById('popularThreshold').value = data.cache_config?.popular_threshold || 5;
                    document.getElementById('cacheTTL').value = data.cache_config?.ttl_hours || 24;
                    document.getElementById('currentCacheType').textContent = data.current_cache_type || 'hybrid';
                    
                    // Load chunk settings
                    document.getElementById('chunkSize').value = data.chunk_strategy?.chunk_size || 1000;
                    document.getElementById('chunkOverlap').value = data.chunk_strategy?.chunk_overlap || 200;
                    document.getElementById('chunkSeparator').value = data.chunk_strategy?.separator || '\\n\\n';
                    
                    // Load Redis settings
                    document.getElementById('redisHost').value = data.redis_config?.host || 'localhost';
                    document.getElementById('redisPort').value = data.redis_config?.port || 6379;
                    // Don't load password for security
                    
                } else {
                    alert('설정 로드 실패: ' + (data.error || '알 수 없는 오류'));
                }
                
            } catch (error) {
                alert('설정 로드 중 오류: ' + error.message);
            }
        }
        
        async function saveAdminSettings() {
            if (!adminToken) return;
            
            const settings = {
                cache_type: 'hybrid',  // Always hybrid now
                cache_config: {
                    ttl_hours: parseInt(document.getElementById('cacheTTL').value),
                    popular_threshold: parseInt(document.getElementById('popularThreshold').value)
                },
                chunk_strategy: {
                    chunk_size: parseInt(document.getElementById('chunkSize').value),
                    chunk_overlap: parseInt(document.getElementById('chunkOverlap').value),
                    separator: document.getElementById('chunkSeparator').value
                },
                redis_config: {
                    host: document.getElementById('redisHost').value,
                    port: parseInt(document.getElementById('redisPort').value),
                    password: document.getElementById('redisPassword').value || null
                }
            };
            
            try {
                const response = await fetch('/api/admin/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + adminToken
                    },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('설정이 저장되었습니다');
                    document.getElementById('currentCacheType').textContent = data.settings?.current_cache_type || settings.cache_type;
                } else {
                    alert('설정 저장 실패: ' + (data.error || '알 수 없는 오류'));
                }
                
            } catch (error) {
                alert('설정 저장 중 오류: ' + error.message);
            }
        }
        
        async function switchCacheType() {
            const cacheType = document.getElementById('cacheType').value;
            
            try {
                const response = await fetch('/api/admin/cache/switch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + adminToken
                    },
                    body: JSON.stringify({ cache_type: cacheType })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('currentCacheType').textContent = data.current_type;
                    alert(data.message);
                } else {
                    alert('캐시 전환 실패: ' + (data.error || '알 수 없는 오류'));
                }
                
            } catch (error) {
                alert('캐시 전환 중 오류: ' + error.message);
            }
        }
        
        async function testRedisConnection() {
            const config = {
                host: document.getElementById('redisHost').value,
                port: parseInt(document.getElementById('redisPort').value),
                password: document.getElementById('redisPassword').value || null
            };
            
            try {
                const response = await fetch('/api/admin/cache/test-redis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + adminToken
                    },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                const resultDiv = document.getElementById('redisTestResult');
                
                if (data.connected) {
                    resultDiv.innerHTML = '✅ ' + data.message;
                    resultDiv.className = 'test-success';
                } else {
                    resultDiv.innerHTML = '❌ ' + data.message;
                    resultDiv.className = 'test-fail';
                }
                
            } catch (error) {
                const resultDiv = document.getElementById('redisTestResult');
                resultDiv.innerHTML = '❌ 연결 테스트 중 오류: ' + error.message;
                resultDiv.className = 'test-fail';
            }
        }
        
        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                alert('비밀번호를 입력하세요');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('비밀번호가 일치하지 않습니다');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('비밀번호는 최소 6자 이상이어야 합니다');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + adminToken
                    },
                    body: JSON.stringify({ new_password: newPassword })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('비밀번호가 변경되었습니다');
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    alert('비밀번호 변경 실패: ' + (data.error || '알 수 없는 오류'));
                }
                
            } catch (error) {
                alert('비밀번호 변경 중 오류: ' + error.message);
            }
        }
        
        async function validateDocuments() {
            if (!adminToken) return;
            
            try {
                const response = await fetch('/api/admin/cache/validate-documents', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + adminToken
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const result = data.result;
                    let message = `문서 검증 완료!\n`;
                    message += `• 확인된 문서: ${result.documents_checked}개\n`;
                    message += `• 변경 감지: ${result.changes_detected}개\n`;
                    message += `• 삭제된 캐시: ${result.cache_cleared}개`;
                    
                    alert(message);
                } else {
                    alert('문서 검증 실패: ' + (data.error || '알 수 없는 오류'));
                }
                
            } catch (error) {
                alert('문서 검증 중 오류: ' + error.message);
            }
        }
        
        async function loadCacheStats() {
            if (!adminToken) return;
            
            try {
                const response = await fetch('/api/admin/cache/hybrid-stats', {
                    headers: {
                        'Authorization': 'Bearer ' + adminToken
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayCacheStats(data);
                } else {
                    alert('캐시 통계 로드 실패: ' + (data.error || '알 수 없는 오류'));
                }
                
            } catch (error) {
                alert('캐시 통계 로드 중 오류: ' + error.message);
            }
        }
        
        function displayCacheStats(stats) {
            const display = document.getElementById('cacheStatsDisplay');
            
            let html = '<h4>📊 하이브리드 캐시 통계</h4>';
            
            html += '<div class="stats-grid">';
            
            // Redis stats
            if (stats.redis_cache) {
                html += `<div class="stats-card">
                    <h4>Redis 캐시 (임시)</h4>
                    <div class="stats-number">${stats.redis_cache.total_entries || 0}</div>
                    <small>개 항목 (조회: ${stats.redis_cache.total_hits || 0}회)</small>
                </div>`;
            }
            
            // Popular cache stats
            if (stats.popular_cache) {
                html += `<div class="stats-card">
                    <h4>인기 질문 DB (영구)</h4>
                    <div class="stats-number">${stats.popular_cache.total_entries || 0}</div>
                    <small>개 항목 (조회: ${stats.popular_cache.total_hits || 0}회)</small>
                </div>`;
            }
            
            html += '</div>';
            
            // Validation history
            if (stats.validation_history && stats.validation_history.length > 0) {
                html += '<h5>🔍 최근 문서 검증 기록</h5>';
                html += '<div style="max-height: 150px; overflow-y: auto;">';
                
                stats.validation_history.forEach(record => {
                    const date = new Date(record.date).toLocaleString('ko-KR');
                    html += `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                        <small>${date}: ${record.checked}개 확인, ${record.changes}개 변경</small>
                    </div>`;
                });
                
                html += '</div>';
            }
            
            // Cache strategy info
            if (stats.cache_strategy) {
                html += '<h5>⚙️ 캐시 전략</h5>';
                html += `<p><small>
                    • Redis TTL: ${stats.cache_strategy.redis_ttl}<br>
                    • 인기 기준: ${stats.cache_strategy.popular_threshold}<br>
                    • 검증 주기: ${stats.cache_strategy.validation_interval}
                </small></p>`;
            }
            
            display.innerHTML = html;
            display.style.display = 'block';
        }

    </script>
</body>
</html>