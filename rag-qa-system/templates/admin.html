<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG ì‹œìŠ¤í…œ ê´€ë¦¬ì</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .status-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .status-item {
            padding: 15px;
            border-radius: 6px;
            background: #f8f9fa;
            border-left: 4px solid #28a745;
        }
        
        .status-item.error {
            border-left-color: #dc3545;
        }
        
        .status-item.warning {
            border-left-color: #ffc107;
        }
        
        .action-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            font-weight: 600;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            display: none;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .important-note {
            background-color: #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border-left: 4px solid #fdcb6e;
        }
        
        .important-note h3 {
            margin-bottom: 10px;
            color: #d63031;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>RAG ì‹œìŠ¤í…œ ê´€ë¦¬ì í˜ì´ì§€</h1>
        
        <div id="alert" class="alert"></div>
        
        <!-- ì‹œìŠ¤í…œ ìƒíƒœ ì„¹ì…˜ -->
        <div class="status-section">
            <h2>ì‹œìŠ¤í…œ ìƒíƒœ</h2>
            <div class="status-grid" id="systemStatus">
                <div class="status-item">
                    <strong>Redis ìºì‹œ:</strong> <span id="redisStatus">í™•ì¸ ì¤‘...</span>
                </div>
                <div class="status-item">
                    <strong>RDB (SQLite):</strong> <span id="rdbStatus">í™•ì¸ ì¤‘...</span>
                </div>
                <div class="status-item">
                    <strong>ë²¡í„° DB:</strong> <span id="vectorStatus">í™•ì¸ ì¤‘...</span>
                </div>
                <div class="status-item">
                    <strong>ë¬¸ì„œ íŒŒì¼:</strong> <span id="docStatus">í™•ì¸ ì¤‘...</span>
                </div>
            </div>
        </div>
        
        <!-- ë°ì´í„° ì‚­ì œ ì„¹ì…˜ -->
        <div class="action-section">
            <h2>ë°ì´í„° ì‚­ì œ</h2>
            <div class="button-grid">
                <button class="btn-danger" onclick="clearRedis()">Redis ìºì‹œ ì‚­ì œ</button>
                <button class="btn-danger" onclick="clearRDB()">RDB ê¸°ë¡ ì‚­ì œ</button>
                <button class="btn-danger" onclick="clearVectorDB()">ë²¡í„° DB ì‚­ì œ</button>
                <button class="btn-danger" onclick="clearAll()">ì „ì²´ ì´ˆê¸°í™”</button>
            </div>
        </div>
        
        <!-- ë²¡í„°DB ì´ˆê¸°í™” ì„¹ì…˜ -->
        <div class="action-section">
            <h2>ë²¡í„° DB ê´€ë¦¬</h2>
            <p style="margin-bottom: 15px; color: #666;">
                ğŸ’¡ ì„ë² ë”© ì°¨ì› ë¶ˆì¼ì¹˜ í•´ê²°: BGE-M3 (1024ì°¨ì›)ë¡œ ë²¡í„°DB ì™„ì „ ì¬ìƒì„±
            </p>
            <div class="button-grid">
                <button class="btn-warning" onclick="resetVectorDBToBGE()">
                    ğŸ”„ BGE-M3ë¡œ ë²¡í„°DB ì´ˆê¸°í™”
                </button>
            </div>
        </div>
        
        <!-- ë¬¸ì„œ ë¡œë“œ ì„¹ì…˜ -->
        <div class="action-section">
            <h2>ë¬¸ì„œ ë¡œë“œ</h2>
            <p style="margin-bottom: 15px;">
                s3 í´ë”: ê¸°ë³¸ ì²­í‚¹ (1000ì, 200ì ì¤‘ë³µ)<br>
                s3-chunking í´ë”: ì»¤ìŠ¤í…€ êµ¬ë¶„ì ì²­í‚¹
            </p>
            <div class="button-grid">
                <button class="btn-success" onclick="reloadDocuments(true)">
                    ì´ˆê¸°í™” í›„ ë¬¸ì„œ ë¡œë“œ
                </button>
                <button class="btn-primary" onclick="reloadDocuments(false)">
                    ë¬¸ì„œë§Œ ë‹¤ì‹œ ë¡œë“œ
                </button>
            </div>
            <div class="loader" id="loader">
                <div class="spinner"></div>
                <p>ë¬¸ì„œë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            </div>
        </div>
        
        <!-- ì¤‘ìš” ì•ˆë‚´ -->
        <div class="important-note">
            <h3>âš ï¸ ì¤‘ìš” ì•ˆë‚´</h3>
            <ul>
                <li>ì „ì²´ ì´ˆê¸°í™” í›„ì—ëŠ” ë°˜ë“œì‹œ ë¬¸ì„œë¥¼ ë‹¤ì‹œ ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.</li>
                <li>ë¬¸ì„œ ë¡œë“œëŠ” ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (íŒŒì¼ í¬ê¸°ì— ë”°ë¼ 1-5ë¶„).</li>
                <li>s3 í´ë”ì™€ s3-chunking í´ë”ì— ë¬¸ì„œê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
            </ul>
        </div>
    </div>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
        window.onload = function() {
            checkSystemStatus();
        };
        
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/admin/system-status');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const status = data.system_status;
                    
                    // Redis ìƒíƒœ
                    const redisEl = document.getElementById('redisStatus');
                    if (status.redis.available) {
                        redisEl.textContent = `í™œì„± (${status.redis.info.keys} í‚¤)`;
                        redisEl.parentElement.className = 'status-item';
                    } else {
                        redisEl.textContent = `ë¹„í™œì„± (íŒŒì¼ ìºì‹œ: ${status.redis.info.cache_files} íŒŒì¼)`;
                        redisEl.parentElement.className = 'status-item warning';
                    }
                    
                    // RDB ìƒíƒœ
                    const rdbEl = document.getElementById('rdbStatus');
                    if (status.rdb.available) {
                        rdbEl.textContent = `í™œì„± (${status.rdb.files.length} íŒŒì¼)`;
                        rdbEl.parentElement.className = 'status-item';
                    } else {
                        rdbEl.textContent = 'ë¹„í™œì„±';
                        rdbEl.parentElement.className = 'status-item error';
                    }
                    
                    // ë²¡í„° DB ìƒíƒœ
                    const vectorEl = document.getElementById('vectorStatus');
                    if (status.vectordb.available) {
                        vectorEl.textContent = `í™œì„± (${status.vectordb.doc_count} ë¬¸ì„œ)`;
                        vectorEl.parentElement.className = 'status-item';
                    } else {
                        vectorEl.textContent = 'ë¹„í™œì„± (ë¬¸ì„œ ì—†ìŒ)';
                        vectorEl.parentElement.className = 'status-item error';
                    }
                    
                    // ë¬¸ì„œ íŒŒì¼ ìƒíƒœ
                    const docEl = document.getElementById('docStatus');
                    if (status.documents.available) {
                        docEl.textContent = `${status.documents.file_count} íŒŒì¼`;
                        docEl.parentElement.className = 'status-item';
                    } else {
                        docEl.textContent = 'íŒŒì¼ ì—†ìŒ';
                        docEl.parentElement.className = 'status-item error';
                    }
                }
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
            }
        }
        
        async function clearRedis() {
            if (!confirm('Redis ìºì‹œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch('/api/admin/clear-redis', { method: 'DELETE' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert(data.message, 'success');
                    checkSystemStatus();
                } else {
                    showAlert(data.message, 'danger');
                }
            } catch (error) {
                showAlert('Redis ìºì‹œ ì‚­ì œ ì‹¤íŒ¨', 'danger');
            }
        }
        
        async function clearRDB() {
            if (!confirm('RDB ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch('/api/admin/clear-rdb', { method: 'DELETE' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert(data.message, 'success');
                    checkSystemStatus();
                } else {
                    showAlert(data.message, 'danger');
                }
            } catch (error) {
                showAlert('RDB ì‚­ì œ ì‹¤íŒ¨', 'danger');
            }
        }
        
        async function clearVectorDB() {
            if (!confirm('ë²¡í„° DBë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë¬¸ì„œë¥¼ ë‹¤ì‹œ ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.')) return;
            
            try {
                const response = await fetch('/api/admin/clear-vectordb', { method: 'DELETE' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert(data.message + ' ë¬¸ì„œë¥¼ ë‹¤ì‹œ ë¡œë“œí•´ì£¼ì„¸ìš”!', 'warning');
                    checkSystemStatus();
                } else {
                    showAlert(data.message, 'danger');
                }
            } catch (error) {
                showAlert('ë²¡í„° DB ì‚­ì œ ì‹¤íŒ¨', 'danger');
            }
        }
        
        async function resetVectorDBToBGE() {
            if (!confirm('ë²¡í„° DBë¥¼ BGE-M3 (1024ì°¨ì›)ìœ¼ë¡œ ì™„ì „ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ê¸°ì¡´ ë²¡í„°DB ë°±ì—… í›„ ì‚­ì œ\nâ€¢ BGE-M3ë¡œ ë¬¸ì„œ ìë™ ì¬ì„ë² ë”©\nâ€¢ ìºì‹œ ì´ˆê¸°í™”\n\nì´ ì‘ì—…ì€ ëª‡ ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) return;
            
            // ë¡œë”© í‘œì‹œ
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ ì´ˆê¸°í™” ì¤‘...';
            
            try {
                const response = await fetch('/api/admin/vectordb/reset', { 
                    method: 'POST',
                    headers: {
                        'Authorization': getAuthToken()
                    }
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert(
                        `âœ… ${data.message}\n\n` +
                        `â€¢ ì„ë² ë”© ëª¨ë¸: ${data.embedding_model.type} (${data.embedding_model.dimension}ì°¨ì›)\n` +
                        `â€¢ ê¸°ì¡´ ë¬¸ì„œ ìˆ˜: ${data.old_document_count}ê°œ\n` +
                        `â€¢ ë°±ì—… ìœ„ì¹˜: ${data.backup_path || 'ì—†ìŒ'}`, 
                        'success'
                    );
                    checkSystemStatus();
                } else if (data.status === 'partial_failure') {
                    showAlert(
                        `âš ï¸ ${data.message}\n\n` +
                        `ì˜¤ë¥˜: ${data.error}\n\n` +
                        `ìˆ˜ë™ìœ¼ë¡œ "ë¬¸ì„œ ì¬ë¡œë”©"ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.`, 
                        'warning'
                    );
                    checkSystemStatus();
                } else {
                    showAlert(data.error || 'ë²¡í„° DB ì´ˆê¸°í™” ì‹¤íŒ¨', 'danger');
                }
            } catch (error) {
                showAlert('ë²¡í„° DB ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        async function clearAll() {
            if (!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
            
            try {
                const response = await fetch('/api/admin/clear-all', { method: 'DELETE' });
                const data = await response.json();
                
                if (data.status === 'success' || data.status === 'partial') {
                    showAlert(data.note || data.message, 'warning');
                    checkSystemStatus();
                } else {
                    showAlert(data.message, 'danger');
                }
            } catch (error) {
                showAlert('ì „ì²´ ì´ˆê¸°í™” ì‹¤íŒ¨', 'danger');
            }
        }
        
        async function reloadDocuments(clearAll) {
            const confirmMsg = clearAll 
                ? 'ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ë¬¸ì„œë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' 
                : 'ë¬¸ì„œë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                
            if (!confirm(confirmMsg)) return;
            
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
            
            try {
                const response = await fetch('/api/admin/reload-documents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ clear_all: clearAll })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert(
                        `ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ! ${data.documents_loaded}ê°œ ë¬¸ì„œ, ${data.total_chunks}ê°œ ì²­í¬ ìƒì„±ë¨`, 
                        'success'
                    );
                    checkSystemStatus();
                } else {
                    showAlert(data.message, 'danger');
                }
            } catch (error) {
                showAlert('ë¬¸ì„œ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'danger');
            } finally {
                loader.style.display = 'none';
            }
        }
    </script>
</body>
</html>