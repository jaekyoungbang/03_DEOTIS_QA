<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG QA System - Enhanced</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            position: relative;
        }
        .message-time {
            font-size: 0.75em;
            color: #6c757d;
            margin-top: 5px;
            opacity: 0.8;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            text-align: right;
            margin-left: 20%;
        }
        .ai-message {
            background-color: #e9ecef;
            margin-right: 20%;
            line-height: 1.6;
        }
        .ai-message h3 {
            color: #0066cc;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .ai-message table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .ai-message table th,
        .ai-message table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .ai-message table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .ai-message strong {
            color: #0066cc;
        }
        .ai-message ul, .ai-message ol {
            padding-left: 20px;
        }
        .ai-message li {
            margin-bottom: 5px;
        }
        .ai-message .list-check {
            list-style: none;
            padding-left: 0;
        }
        .ai-message .list-check li {
            padding-left: 25px;
            position: relative;
        }
        .ai-message .table-bordered {
            border: 2px solid #dee2e6;
        }
        .ai-message .table-bordered th,
        .ai-message .table-bordered td {
            border: 1px solid #dee2e6;
            vertical-align: middle;
        }
        .source-doc {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
            padding: 5px;
            background-color: #f1f3f5;
            border-radius: 5px;
        }
        .upload-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .document-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .settings-section {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .model-selector {
            margin-bottom: 15px;
        }
        .vectordb-info {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .progress-container {
            margin: 15px 0;
            display: none;
        }
        .progress {
            height: 25px;
        }
        .progress-bar {
            transition: width 0.3s ease;
            font-size: 0.9em;
        }
        .chunking-strategy-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }
        .search-results {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .search-header {
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 10px;
        }
        .search-result-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #e9ecef;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .result-rank {
            background-color: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 10px;
            min-width: 40px;
            text-align: center;
        }
        .result-info {
            flex: 1;
        }
        .result-source {
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-right: 8px;
        }
        .result-title {
            font-weight: 500;
            margin-right: 8px;
        }
        .result-score {
            color: #28a745;
            font-weight: bold;
            font-size: 0.9em;
        }
        .search-status {
            padding: 10px;
            background-color: #e3f2fd;
            border-radius: 5px;
            margin: 10px 0;
        }
        .llm-status {
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #ffc107;
        }
        .ai-answer {
            margin: 15px 0;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            line-height: 1.6;
        }
        .document-group {
            margin: 20px 0;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            background-color: #fafafa;
        }
        .doc-group-title {
            color: #0066cc;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .individual-answer {
            margin: 10px 0;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: flex;
            align-items: flex-start;
            animation: slideIn 0.3s ease-out;
        }
        .rank-badge {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        .score-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            display: inline-block;
        }
        .rank-answer {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 8px 0;
            padding: 12px;
            background-color: #f8f9fa;
        }
        .rank-header {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .source-info {
            margin-top: 8px;
            font-size: 0.8em;
            color: #6c757d;
            font-style: italic;
        }
        .process-status {
            color: #6c757d;
            font-style: italic;
            margin: 5px 0;
        }
        .error-message {
            color: #dc3545;
            font-weight: bold;
            font-size: 0.9em;
        }
        .process-answer {
            margin: 15px 0;
            padding: 15px;
            background-color: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            line-height: 1.6;
        }
        .search-info-section {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        .search-info-section h6 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 0.9em;
        }
        .search-doc-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
            font-size: 0.8em;
        }
        .doc-rank {
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            min-width: 25px;
            text-align: center;
        }
        .doc-score {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
        }
        .doc-source {
            color: #6c757d;
            font-style: italic;
        }
        .source-badge {
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7em;
            margin-left: 5px;
        }
        .llm-response {
            margin: 15px 0;
            padding: 15px;
            background-color: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        .llm-response h6 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 0.9em;
        }
        .answer-section {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .similarity-section {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .similarity-section h6 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 0.9em;
        }
        .similarity-item {
            margin: 10px 0;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 6px;
            border-left: 3px solid #007bff;
        }
        .similarity-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        .similarity-rank {
            font-weight: bold;
            color: #007bff;
        }
        .similarity-score {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.8em;
        }
        .similarity-source {
            color: #6c757d;
            font-size: 0.8em;
        }
        .similarity-content {
            color: #495057;
            font-size: 0.85em;
            line-height: 1.4;
            font-style: italic;
        }
            margin-right: 15px;
            min-width: 60px;
            text-align: center;
            flex-shrink: 0;
        }
        .answer-status {
            flex: 1;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 5px;
            border: 1px solid #ffc107;
        }
        .answer-content {
            flex: 1;
            line-height: 1.6;
            font-size: 0.95em;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">ğŸ¤– RAG QA System - Enhanced</h1>
        
        <!-- Settings Section -->
        <div class="settings-section">
            <h4><i class="fas fa-cog"></i> ì‹œìŠ¤í…œ ì„¤ì •</h4>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">LLM ëª¨ë¸ ì„ íƒ:</label>
                    <select class="form-select model-selector" id="llmModel">
                        <option value="gpt-4o-mini" selected>GPT-4o-mini (ë¹ ë¦„)</option>
                        <option value="gpt-4-turbo">GPT-4.1-mini (ì •í™•í•¨)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ì²­í¬ í¬ê¸°:</label>
                    <input type="number" class="form-control" id="chunkSize" value="1000">
                </div>
                <div class="col-md-4">
                    <label class="form-label">ì²­í¬ ê²¹ì¹¨:</label>
                    <input type="number" class="form-control" id="chunkOverlap" value="200">
                </div>
            </div>
            
            <!-- ì²­í‚¹ ì „ëµ ì„ íƒ ì„¹ì…˜ -->
            <div class="chunking-strategy-section">
                <h5><i class="fas fa-cut"></i> ì²­í‚¹ ì „ëµ ì„¤ì •</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">ì²­í‚¹ ì „ëµ:</label>
                        <select class="form-select" id="chunkingStrategy">
                            <option value="basic" selected>ê¸°ë³¸ ì²­í‚¹ (1000ì/200ì ì¤‘ì²©)</option>
                            <option value="custom_delimiter">ì»¤ìŠ¤í…€ êµ¬ë¶„ì (/$$/ ê¸°ì¤€)</option>
                            <option value="semantic">ì˜ë¯¸ ê¸°ë°˜ ì²­í‚¹</option>
                            <option value="hybrid">í•˜ì´ë¸Œë¦¬ë“œ ì²­í‚¹</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ê²€ìƒ‰ ëª¨ë“œ:</label>
                        <select class="form-select" id="searchMode">
                            <option value="basic" selected>ê¸°ë³¸ ì²­í‚¹ë§Œ ê²€ìƒ‰</option>
                            <option value="custom">ì»¤ìŠ¤í…€ ì²­í‚¹ë§Œ ê²€ìƒ‰</option>
                            <option value="dual">ì´ì¤‘ ê²€ìƒ‰ (ê¸°ë³¸+ì»¤ìŠ¤í…€)</option>
                        </select>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        ğŸ’¡ /$$/ êµ¬ë¶„ìê°€ í¬í•¨ëœ ë¬¸ì„œëŠ” ìë™ìœ¼ë¡œ ì»¤ìŠ¤í…€ ì²­í‚¹ì´ ì ìš©ë©ë‹ˆë‹¤.
                    </small>
                </div>
            </div>
            <div class="vectordb-info mt-3">
                <strong>ğŸ“Š ë²¡í„°DB ì •ë³´:</strong> <span id="vectorDbInfo">ë¡œë”© ì¤‘...</span>
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="clearVectorDB()">
                    <i class="fas fa-trash"></i> DB ì´ˆê¸°í™”
                </button>
                
                <!-- ì„±ëŠ¥ ì„¤ëª… -->
                <div class="mt-2">
                    <small class="text-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>ì„±ëŠ¥ ì •ë³´:</strong> 
                        ë¬¸ì„œ ì—…ë¡œë“œ ì‹œ 1-3ì´ˆ ì†Œìš” (OpenAI ì„ë² ë”© ìƒì„±), 
                        ê²€ìƒ‰ ì‹œ ìºì‹œ í™œìš©ìœ¼ë¡œ 0.2ì´ˆ ì´ë‚´ ì‘ë‹µ
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Document Upload Section -->
        <div class="upload-section">
            <h4><i class="fas fa-upload"></i> ë¬¸ì„œ ê´€ë¦¬</h4>
            
            <!-- S3 Auto Load -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <button class="btn btn-success w-100" onclick="loadS3Documents()">
                        <i class="fas fa-folder-open"></i> S3 í´ë” ë¬¸ì„œ ìë™ ë¡œë“œ
                    </button>
                </div>
            </div>
            
            <!-- File Upload -->
            <div class="row">
                <div class="col-md-8">
                    <input type="file" class="form-control" id="fileInput" accept=".pdf,.txt,.docx,.md">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" onclick="uploadDocument()">
                        <i class="fas fa-upload"></i> íŒŒì¼ ì—…ë¡œë“œ
                    </button>
                </div>
            </div>
            
            <!-- ì§„í–‰ë¥  í‘œì‹œ -->
            <div class="progress-container" id="progressContainer">
                <div class="progress">
                    <div class="progress-bar bg-primary" id="progressBar" role="progressbar" style="width: 0%">
                        <span id="progressText">ëŒ€ê¸° ì¤‘...</span>
                    </div>
                </div>
                <div class="mt-2">
                    <small id="progressDetails" class="text-muted">
                        ğŸ’¡ ë¬¸ì„œ ì²˜ë¦¬ëŠ” ì„ë² ë”© ìƒì„±ìœ¼ë¡œ ì¸í•´ 1-3ì´ˆ ì†Œìš”ë©ë‹ˆë‹¤. ê²€ìƒ‰ì€ ìºì‹œë¡œ 0.2ì´ˆ ì´ë‚´!
                    </small>
                </div>
            </div>
            
            <!-- Text Input -->
            <div class="mt-3">
                <h5>ë˜ëŠ” í…ìŠ¤íŠ¸ ì§ì ‘ ì…ë ¥:</h5>
                <textarea class="form-control" id="textInput" rows="3" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                <div class="mt-2">
                    <input type="text" class="form-control mb-2" id="textTitle" placeholder="ë¬¸ì„œ ì œëª© (ì„ íƒ)">
                    <button class="btn btn-secondary" onclick="uploadText()">
                        <i class="fas fa-plus"></i> í…ìŠ¤íŠ¸ ì¶”ê°€
                    </button>
                </div>
            </div>
            
            <!-- Document List -->
            <div class="mt-3">
                <h5>ğŸ“š ë¬¸ì„œ í˜„í™©:</h5>
                <div id="documentList" class="document-list"></div>
                <button class="btn btn-danger btn-sm mt-2" onclick="clearAllDocuments()">
                    <i class="fas fa-trash"></i> ëª¨ë“  ë¬¸ì„œ ì‚­ì œ
                </button>
            </div>
        </div>
        
        <!-- Chat Interface -->
        <div class="card">
            <div class="card-body">
                <div class="chat-container" id="chatContainer">
                    <div class="message ai-message">
                        <h3>ğŸ¤– RAG QA ì‹œìŠ¤í…œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h3>
                        <p>ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ê³  ì§ˆë¬¸í•´ì£¼ì„¸ìš”. ë‹¤ìŒ ê¸°ëŠ¥ë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>
                        <ul>
                            <li><strong>S3 ìë™ ë¡œë“œ:</strong> ë¯¸ë¦¬ ì¤€ë¹„ëœ ë¬¸ì„œë“¤ì„ í•œë²ˆì— ë¡œë“œ</li>
                            <li><strong>LLM ëª¨ë¸ ì„ íƒ:</strong> GPT-4o-mini ë˜ëŠ” GPT-4.1-mini ì„ íƒ</li>
                            <li><strong>ì‹¤ì‹œê°„ ì„¤ì •:</strong> ì²­í‚¹ í¬ê¸° ë° ê²¹ì¹¨ ì¡°ì •</li>
                        </ul>
                    </div>
                </div>
                <div class="input-group mt-3">
                    <input type="text" class="form-control" id="questionInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
                    <button class="btn btn-primary" onclick="sendQuestion()">
                        <i class="fas fa-paper-plane"></i> ì „ì†¡
                    </button>
                    <button class="btn btn-secondary" onclick="clearChat()">
                        <i class="fas fa-eraser"></i> ì´ˆê¸°í™”
                    </button>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="useMemory">
                    <label class="form-check-label" for="useMemory">
                        ëŒ€í™” ê¸°ë¡ ì‚¬ìš©
                    </label>
                </div>
            </div>
        </div>
        
        <!-- API Documentation Link -->
        <div class="text-center mt-4">
            <a href="/swagger/" class="btn btn-outline-info" target="_blank">
                <i class="fas fa-book"></i> API ë¬¸ì„œ (Swagger)
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Load initial data
        window.onload = function() {
            loadDocumentList();
            loadVectorDBInfo();
        };

        // Get current time in HH:MM:SS format
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false 
            });
        }

        // Advanced markdown formatting function
        function formatMarkdown(text) {
            // First, handle tables (most important fix)
            text = formatTables(text);
            
            // Headers
            text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // Bold and italic
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Lists
            text = formatLists(text);
            
            // Line breaks and paragraphs
            text = text.replace(/\n\n/g, '</p><p>');
            text = '<p>' + text + '</p>';
            
            // Clean up empty paragraphs and fix structure
            text = text.replace(/<p><\/p>/g, '');
            text = text.replace(/<p>(<h[1-6])/g, '$1');
            text = text.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
            text = text.replace(/<p>(<table)/g, '$1');
            text = text.replace(/(<\/table>)<\/p>/g, '$1');
            text = text.replace(/<p>(<ul)/g, '$1');
            text = text.replace(/(<\/ul>)<\/p>/g, '$1');
            text = text.replace(/<p>(<ol)/g, '$1');
            text = text.replace(/(<\/ol>)<\/p>/g, '$1');
            
            return text;
        }

        function formatTables(text) {
            // Enhanced table formatting
            const tablePattern = /(\|[^|\n]*\|[^|\n]*\|[^\n]*\n)+/g;
            
            return text.replace(tablePattern, (match) => {
                const rows = match.trim().split('\n');
                if (rows.length < 2) return match;
                
                let table = '<table class="table table-striped table-bordered">';
                let hasHeader = false;
                
                rows.forEach((row, index) => {
                    // Skip separator rows like |---|---|
                    if (row.includes('---') || row.includes(':--')) {
                        hasHeader = true;
                        return;
                    }
                    
                    const cells = row.split('|').map(cell => cell.trim()).filter(cell => cell !== '');
                    
                    if (cells.length === 0) return;
                    
                    // First row is header if we haven't seen a separator yet, or if this is the first row
                    const isHeader = (index === 0 && !hasHeader);
                    const tag = isHeader ? 'th' : 'td';
                    const section = isHeader ? 'thead' : 'tbody';
                    
                    if (isHeader && index === 0) {
                        table += '<thead>';
                    } else if (!isHeader && index === 1 && hasHeader) {
                        table += '</thead><tbody>';
                    } else if (!isHeader && index === 1 && !hasHeader) {
                        table += '<tbody>';
                    }
                    
                    table += '<tr>';
                    cells.forEach(cell => {
                        // Process cell content for markdown
                        let cellContent = cell;
                        cellContent = cellContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        cellContent = cellContent.replace(/\*(.*?)\*/g, '<em>$1</em>');
                        table += `<${tag}>${cellContent}</${tag}>`;
                    });
                    table += '</tr>';
                });
                
                if (hasHeader) {
                    table += '</tbody>';
                } else {
                    table += '</tbody>';
                }
                table += '</table>';
                
                return table;
            });
        }

        function formatLists(text) {
            // Enhanced list formatting
            const lines = text.split('\n');
            let result = [];
            let inList = false;
            let listType = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const isUnorderedItem = /^\s*[-*+]\s+(.+)/.test(line);
                const isOrderedItem = /^\s*\d+\.\s+(.+)/.test(line);
                const isCheckItem = /^\s*[-*+]\s*âœ…\s*(.+)/.test(line);
                
                if (isCheckItem) {
                    const content = line.replace(/^\s*[-*+]\s*âœ…\s*/, '');
                    if (!inList || listType !== 'check') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ul class="list-check">');
                        inList = true;
                        listType = 'check';
                    }
                    result.push(`<li><i class="fas fa-check-circle text-success"></i> ${content}</li>`);
                } else if (isUnorderedItem) {
                    const content = line.replace(/^\s*[-*+]\s+/, '');
                    if (!inList || listType !== 'ul') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ul>');
                        inList = true;
                        listType = 'ul';
                    }
                    result.push(`<li>${content}</li>`);
                } else if (isOrderedItem) {
                    const content = line.replace(/^\s*\d+\.\s+/, '');
                    if (!inList || listType !== 'ol') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ol>');
                        inList = true;
                        listType = 'ol';
                    }
                    result.push(`<li>${content}</li>`);
                } else {
                    if (inList) {
                        result.push(`</${listType}>`);
                        inList = false;
                        listType = '';
                    }
                    result.push(line);
                }
            }
            
            if (inList) {
                result.push(`</${listType}>`);
            }
            
            return result.join('\n');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendQuestion();
            }
        }

        // Progress bar utility functions with timing
        let uploadStartTime = 0;
        
        function showProgress(text, percentage, showTiming = false) {
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            const textElement = document.getElementById('progressText');
            const detailsElement = document.getElementById('progressDetails');
            
            container.style.display = 'block';
            bar.style.width = percentage + '%';
            
            if (percentage === 0) {
                uploadStartTime = Date.now();
                textElement.textContent = text;
                detailsElement.innerHTML = 'ğŸ”„ ì‹œì‘ ì¤‘...';
            } else if (percentage < 100) {
                const elapsed = ((Date.now() - uploadStartTime) / 1000).toFixed(1);
                textElement.textContent = text;
                
                if (percentage <= 30) {
                    detailsElement.innerHTML = `ğŸ“ íŒŒì¼ ë¡œë”© ì¤‘... (${elapsed}ì´ˆ ê²½ê³¼)`;
                } else if (percentage <= 60) {
                    detailsElement.innerHTML = `âœ‚ï¸ ì²­í‚¹ ì²˜ë¦¬ ì¤‘... (${elapsed}ì´ˆ ê²½ê³¼)`;
                } else if (percentage <= 90) {
                    detailsElement.innerHTML = `ğŸ¤– OpenAI ì„ë² ë”© ìƒì„± ì¤‘... (${elapsed}ì´ˆ ê²½ê³¼) - ê°€ì¥ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ë‹¨ê³„`;
                } else {
                    detailsElement.innerHTML = `ğŸ’¾ ë²¡í„°DB ì €ì¥ ì¤‘... (${elapsed}ì´ˆ ê²½ê³¼)`;
                }
            } else {
                const totalTime = ((Date.now() - uploadStartTime) / 1000).toFixed(2);
                textElement.textContent = `ì™„ë£Œ! (ì´ ${totalTime}ì´ˆ)`;
                detailsElement.innerHTML = `âœ… ì²˜ë¦¬ ì™„ë£Œ! ì´ì œ ë¹ ë¥¸ ê²€ìƒ‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. (í‰ê·  0.2ì´ˆ)`;
                
                setTimeout(() => {
                    container.style.display = 'none';
                    bar.style.width = '0%';
                }, 3000);
            }
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        async function sendQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            if (!question) return;

            const chatContainer = document.getElementById('chatContainer');
            const useMemory = document.getElementById('useMemory').checked;
            const llmModel = document.getElementById('llmModel').value;
            const searchMode = document.getElementById('searchMode').value;

            // Add user message with timestamp
            const userTime = getCurrentTime();
            chatContainer.innerHTML += `<div class="message user-message">${question}<div class="message-time">${userTime}</div></div>`;
            input.value = '';

            // Create AI message container for streaming
            const aiMessageId = 'ai-message-' + Date.now();
            const loadingHTML = `
                <div class="message ai-message" id="${aiMessageId}">
                    <div class="streaming-content">
                        <div class="loading-indicator">
                            <i class="fas fa-search fa-spin"></i> ê²€ìƒ‰ ì¤‘...
                        </div>
                    </div>
                    <div class="message-time">${getCurrentTime()}</div>
                </div>
            `;
            chatContainer.innerHTML += loadingHTML;
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // Use streaming endpoint
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question: question,
                        use_memory: useMemory,
                        llm_model: llmModel,
                        search_mode: searchMode
                    })
                });

                if (!response.body) {
                    throw new Error('ìŠ¤íŠ¸ë¦¬ë°ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                const aiMessageContainer = document.getElementById(aiMessageId);
                const contentContainer = aiMessageContainer.querySelector('.streaming-content');
                
                // Clear loading indicator
                contentContainer.innerHTML = '<div class="streaming-answer"></div>';
                const answerContainer = contentContainer.querySelector('.streaming-answer');

                let buffer = '';
                let isFirstChunk = true;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                // Add final timestamp and metadata
                                const finalTime = getCurrentTime();
                                aiMessageContainer.querySelector('.message-time').textContent = finalTime;
                                
                                // Add model info
                                const modelInfo = document.createElement('div');
                                modelInfo.className = 'mt-2';
                                modelInfo.innerHTML = `<small class="text-muted">ğŸ¤– Model: ${llmModel} (ìŠ¤íŠ¸ë¦¬ë°)</small>`;
                                contentContainer.appendChild(modelInfo);
                                return;
                            }
                            
                            try {
                                const chunk = JSON.parse(data);
                                
                                if (chunk.type === 'search_start') {
                                    answerContainer.innerHTML = `<div class="search-status"><i class="fas fa-search fa-spin"></i> ${chunk.message}</div>`;
                                } else if (chunk.type === 'search_result_found') {
                                    // Show each search result immediately
                                    const searchResults = answerContainer.querySelector('.search-results') || 
                                        (() => {
                                            const div = document.createElement('div');
                                            div.className = 'search-results';
                                            div.innerHTML = '<div class="search-header"><i class="fas fa-file-search"></i> ê²€ìƒ‰ ê²°ê³¼:</div>';
                                            answerContainer.appendChild(div);
                                            return div;
                                        })();
                                    
                                    const resultDiv = document.createElement('div');
                                    resultDiv.className = 'search-result-item';
                                    resultDiv.innerHTML = `
                                        <div class="result-rank">1ìœ„</div>
                                        <div class="result-info">
                                            <span class="result-source">[${chunk.source}]</span>
                                            <span class="result-title">${chunk.title}</span>
                                            <span class="result-score">${chunk.score}</span>
                                        </div>
                                    `;
                                    searchResults.appendChild(resultDiv);
                                } else if (chunk.type === 'search_completed') {
                                    // Search completed
                                    const statusDiv = answerContainer.querySelector('.search-status');
                                    if (statusDiv) {
                                        statusDiv.innerHTML = `<i class="fas fa-check text-success"></i> ${chunk.total_docs}ê°œ ë¬¸ì„œ ê²€ìƒ‰ ì™„ë£Œ (${chunk.search_time}ì´ˆ)`;
                                    }
                                } else if (chunk.type === 'all_processes_start') {
                                    // 4ê°œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘
                                    const processesDiv = document.createElement('div');
                                    processesDiv.className = 'processes-container';
                                    processesDiv.id = 'processes-container';
                                    processesDiv.innerHTML = '<h5 class="processes-title">ğŸ”„ 4ê°œ í”„ë¡œì„¸ìŠ¤ ë¹„ë™ê¸° ì‹¤í–‰ ì¤‘...</h5>';
                                    answerContainer.appendChild(processesDiv);
                                } else if (chunk.type === 'process_start') {
                                    // ê°œë³„ í”„ë¡œì„¸ìŠ¤ ì‹œì‘
                                    let processesContainer = document.getElementById('processes-container');
                                    if (!processesContainer) {
                                        processesContainer = document.createElement('div');
                                        processesContainer.className = 'processes-container';
                                        processesContainer.id = 'processes-container';
                                        answerContainer.appendChild(processesContainer);
                                    }
                                    
                                    const processDiv = document.createElement('div');
                                    processDiv.className = 'process-group';
                                    processDiv.id = `process-${chunk.process_id}`;
                                    processDiv.innerHTML = `
                                        <h6 class="process-title">ğŸ“‹ ${chunk.process_name}</h6>
                                        <div class="process-status">ë¡œë”© ì¤‘...</div>
                                    `;
                                    processesContainer.appendChild(processDiv);
                                } else if (chunk.type === 'process_complete') {
                                    // í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ - ëª¨ë“  ìˆœìœ„ ë‹µë³€ í‘œì‹œ
                                    const processDiv = document.getElementById(`process-${chunk.process_id}`);
                                    if (processDiv) {
                                        // ë¡œë”© ìƒíƒœ ì œê±°
                                        const statusDiv = processDiv.querySelector('.process-status');
                                        if (statusDiv) {
                                            statusDiv.remove();
                                        }
                                        
                                        // ì œëª©ì— ì™„ë£Œ í‘œì‹œì™€ ì‹œê°„ ì •ë³´ ì¶”ê°€
                                        const title = processDiv.querySelector('.process-title');
                                        if (title) {
                                            title.innerHTML += ` (ì‘ë‹µ ${chunk.total_time}ì´ˆ, ${chunk.status === 'success' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}) âœ…`;
                                        }
                                        
                                        // LLM ì‘ë‹µ ë‚´ìš© í‘œì‹œ
                                        if (chunk.rank_answers && chunk.rank_answers.length > 0) {
                                            const responseDiv = document.createElement('div');
                                            responseDiv.className = 'llm-response';
                                            responseDiv.innerHTML = '<h6>ğŸ’¬ ì‘ë‹µ ë‚´ìš©:</h6>';
                                            
                                            chunk.rank_answers.forEach(rankData => {
                                                const answerDiv = document.createElement('div');
                                                answerDiv.className = 'answer-section';
                                                answerDiv.innerHTML = formatMarkdown(rankData.answer);
                                                responseDiv.appendChild(answerDiv);
                                            });
                                            
                                            processDiv.appendChild(responseDiv);
                                        }
                                        
                                        // ìœ ì‚¬ë„ Top 3 í‘œì‹œ
                                        if (chunk.similarity_info && chunk.similarity_info.length > 0) {
                                            const similarityDiv = document.createElement('div');
                                            similarityDiv.className = 'similarity-section';
                                            similarityDiv.innerHTML = '<h6>ğŸ” ìœ ì‚¬ë„ Top 3</h6>';
                                            
                                            chunk.similarity_info.forEach(info => {
                                                const simDiv = document.createElement('div');
                                                simDiv.className = 'similarity-item';
                                                simDiv.innerHTML = `
                                                    <div class="similarity-header">
                                                        <span class="similarity-rank">${info.rank}.</span>
                                                        <span class="similarity-score">(ìœ ì‚¬ë„ ${info.score})</span>
                                                        <span class="similarity-source">ğŸ“„ ${info.source}</span>
                                                    </div>
                                                    <div class="similarity-content">${info.content_preview}</div>
                                                `;
                                                similarityDiv.appendChild(simDiv);
                                            });
                                            
                                            processDiv.appendChild(similarityDiv);
                                        }
                                    }
                                } else if (chunk.type === 'process_error') {
                                    // í”„ë¡œì„¸ìŠ¤ ì˜¤ë¥˜
                                    const processDiv = document.getElementById(`process-${chunk.process_id}`);
                                    if (processDiv) {
                                        const statusDiv = processDiv.querySelector('.process-status');
                                        if (statusDiv) {
                                            statusDiv.innerHTML = `<span class="error-message">âŒ ${chunk.message || chunk.error}</span>`;
                                        }
                                        
                                        const title = processDiv.querySelector('.process-title');
                                        if (title) {
                                            const timeInfo = chunk.total_time ? ` (ì‘ë‹µ ${chunk.total_time}ì´ˆ, ì‹¤íŒ¨)` : '';
                                            title.innerHTML += `${timeInfo} âŒ`;
                                        }
                                    }
                                } else if (chunk.type === 'source_docs') {
                                    // Add source documents
                                    if (chunk.docs && chunk.docs.length > 0) {
                                        const sourceDiv = document.createElement('div');
                                        sourceDiv.className = 'source-doc mt-2';
                                        sourceDiv.innerHTML = '<strong>ğŸ“„ ì°¸ê³  ë¬¸ì„œ:</strong><br>' + 
                                            chunk.docs.map((doc, idx) => 
                                                `${idx + 1}. ${doc.metadata?.source_file || doc.metadata?.title || 'Unknown'}`
                                            ).join('<br>');
                                        contentContainer.appendChild(sourceDiv);
                                    }
                                }
                                
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            } catch (e) {
                                console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', e);
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜:', error);
                // Fallback to regular query
                const aiMessageContainer = document.getElementById(aiMessageId);
                if (aiMessageContainer) {
                    aiMessageContainer.remove();
                }
                await sendQuestionFallback(question, useMemory, llmModel, searchMode);
            }
        }

        // Fallback function for non-streaming
        async function sendQuestionFallback(question, useMemory, llmModel, searchMode) {
            const chatContainer = document.getElementById('chatContainer');
            
            try {
                const response = await fetch('/api/chat/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question: question,
                        use_memory: useMemory,
                        llm_model: llmModel,
                        search_mode: searchMode
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    const errorTime = getCurrentTime();
                    chatContainer.innerHTML += `<div class="message ai-message">âŒ ì˜¤ë¥˜: ${data.error}<div class="message-time">${errorTime}</div></div>`;
                } else {
                    // Format the answer with markdown
                    const formattedAnswer = formatMarkdown(data.answer || data.result);
                    const aiTime = getCurrentTime();
                    let aiMessage = `<div class="message ai-message">${formattedAnswer}`;
                    
                    // Add model info with response time
                    const responseTime = data.response_time ? ` (${data.response_time}ì´ˆ)` : '';
                    aiMessage += `<div class="mt-2"><small class="text-muted">ğŸ¤– Model: ${data.model_used || llmModel}${responseTime}</small></div>`;
                    
                    // Add source documents if available
                    if (data.source_documents && data.source_documents.length > 0) {
                        aiMessage += '<div class="source-doc"><strong>ğŸ“„ ì°¸ê³  ë¬¸ì„œ:</strong><br>';
                        data.source_documents.forEach((doc, idx) => {
                            aiMessage += `${idx + 1}. ${doc.metadata.source_file || doc.metadata.title || doc.metadata.filename || 'Unknown'}<br>`;
                        });
                        aiMessage += '</div>';
                    }
                    
                    aiMessage += `<div class="message-time">${aiTime}</div></div>`;
                    chatContainer.innerHTML += aiMessage;
                }
            } catch (error) {
                const errorTime = getCurrentTime();
                chatContainer.innerHTML += `<div class="message ai-message">âŒ ì˜¤ë¥˜: ${error.message}<div class="message-time">${errorTime}</div></div>`;
            }

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function loadS3Documents() {
            try {
                const response = await fetch('/api/document/load-s3', {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.error) {
                    alert(`S3 ë¡œë“œ ì‹¤íŒ¨: ${data.error}`);
                } else {
                    alert(`S3 ë¡œë“œ ì„±ê³µ! ${data.documents_loaded || 0}ê°œ ë¬¸ì„œ, ${data.total_chunks || 0}ê°œ ì²­í¬ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    loadDocumentList();
                    loadVectorDBInfo();
                }
            } catch (error) {
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function uploadDocument() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const chunkingStrategy = document.getElementById('chunkingStrategy').value;
            const formData = new FormData();
            formData.append('file', file);
            formData.append('chunking_strategy', chunkingStrategy);

            try {
                showProgress('ì—…ë¡œë“œ ì‹œì‘...', 0);
                
                const response = await fetch('/api/document/upload', {
                    method: 'POST',
                    body: formData
                });

                showProgress('ì„œë²„ ì²˜ë¦¬ ì¤‘...', 50);
                const data = await response.json();
                
                if (data.error) {
                    hideProgress();
                    alert(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${data.error}`);
                } else {
                    showProgress('ì—…ë¡œë“œ ì™„ë£Œ!', 100);
                    
                    const strategyText = getStrategyDisplayName(data.chunking_strategy || chunkingStrategy);
                    alert(`ì—…ë¡œë“œ ì„±ê³µ!\n` +
                          `ì²­í‚¹ ì „ëµ: ${strategyText}\n` +
                          `ìƒì„±ëœ ì²­í¬ ìˆ˜: ${data.chunks_created || 0}ê°œ\n` +
                          `ì²˜ë¦¬ ì‹œê°„: ${(data.processing_time || 0).toFixed(2)}ì´ˆ`);
                    
                    fileInput.value = '';
                    loadDocumentList();
                    loadVectorDBInfo();
                }
            } catch (error) {
                hideProgress();
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        function getStrategyDisplayName(strategy) {
            const strategies = {
                'basic': 'ê¸°ë³¸ ì²­í‚¹',
                'custom_delimiter': 'ì»¤ìŠ¤í…€ êµ¬ë¶„ì (/$$/ ê¸°ì¤€)',
                'semantic': 'ì˜ë¯¸ ê¸°ë°˜ ì²­í‚¹',
                'hybrid': 'í•˜ì´ë¸Œë¦¬ë“œ ì²­í‚¹'
            };
            return strategies[strategy] || strategy;
        }

        async function uploadText() {
            const textInput = document.getElementById('textInput');
            const titleInput = document.getElementById('textTitle');
            const text = textInput.value.trim();
            const title = titleInput.value.trim() || 'Direct Input ' + new Date().toLocaleString();
            
            if (!text) {
                alert('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/document/upload-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        text: text,
                        title: title
                    })
                });

                const data = await response.json();
                if (data.error) {
                    alert(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${data.error}`);
                } else {
                    alert(`í…ìŠ¤íŠ¸ ì¶”ê°€ ì„±ê³µ! ${data.chunks_created || 0}ê°œì˜ ì²­í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    textInput.value = '';
                    titleInput.value = '';
                    loadDocumentList();
                    loadVectorDBInfo();
                }
            } catch (error) {
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function loadDocumentList() {
            try {
                const response = await fetch('/api/document/list');
                const data = await response.json();
                
                const listContainer = document.getElementById('documentList');
                if (data.files && data.files.length > 0) {
                    listContainer.innerHTML = data.files.map(file => 
                        `<div>ğŸ“„ ${file.filename} (${(file.size / 1024).toFixed(2)} KB)</div>`
                    ).join('');
                    listContainer.innerHTML += `<div class="mt-2"><strong>ì´ ì²­í¬ ìˆ˜: ${data.total_chunks || 0}</strong></div>`;
                } else {
                    listContainer.innerHTML = '<div class="text-muted">ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } catch (error) {
                console.error('ë¬¸ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        async function loadVectorDBInfo() {
            try {
                const response = await fetch('/api/v1/vectordb/info');
                const data = await response.json();
                
                document.getElementById('vectorDbInfo').innerHTML = 
                    `ì´ ${data.total_documents || 0}ê°œ ë¬¸ì„œ, ${data.embedding_model || 'Unknown'} ì„ë² ë”©, ${data.vector_db_type || 'Unknown'}`;
            } catch (error) {
                console.error('ë²¡í„°DB ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        async function clearVectorDB() {
            if (!confirm('ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch('/api/v1/vectordb/clear', {
                    method: 'DELETE'
                });

                const data = await response.json();
                const result = await response.json();
                alert(result.message || 'ë²¡í„°DBê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadDocumentList();
                loadVectorDBInfo();
            } catch (error) {
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function clearAllDocuments() {
            if (!confirm('ëª¨ë“  ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch('/api/document/clear-all', {
                    method: 'DELETE'
                });

                const data = await response.json();
                const result = await response.json();
                alert(result.message || 'ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadDocumentList();
                loadVectorDBInfo();
            } catch (error) {
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function clearChat() {
            document.getElementById('chatContainer').innerHTML = 
                '<div class="message ai-message"><h3>ğŸ¤– ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</h3><p>ìƒˆë¡œìš´ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.</p></div>';
            
            // Clear memory on server
            await fetch('/api/chat/clear-memory', { method: 'POST' });
        }
    </script>
</body>
</html>