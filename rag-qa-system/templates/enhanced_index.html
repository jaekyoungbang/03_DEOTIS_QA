<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG QA System - Enhanced</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            text-align: right;
            margin-left: 20%;
        }
        .ai-message {
            background-color: #e9ecef;
            margin-right: 20%;
            line-height: 1.6;
        }
        .ai-message h3 {
            color: #0066cc;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .ai-message table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .ai-message table th,
        .ai-message table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .ai-message table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .ai-message strong {
            color: #0066cc;
        }
        .ai-message ul, .ai-message ol {
            padding-left: 20px;
        }
        .ai-message li {
            margin-bottom: 5px;
        }
        .ai-message .list-check {
            list-style: none;
            padding-left: 0;
        }
        .ai-message .list-check li {
            padding-left: 25px;
            position: relative;
        }
        .ai-message .table-bordered {
            border: 2px solid #dee2e6;
        }
        .ai-message .table-bordered th,
        .ai-message .table-bordered td {
            border: 1px solid #dee2e6;
            vertical-align: middle;
        }
        .source-doc {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
            padding: 5px;
            background-color: #f1f3f5;
            border-radius: 5px;
        }
        .upload-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .document-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .settings-section {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .model-selector {
            margin-bottom: 15px;
        }
        .vectordb-info {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">ğŸ¤– RAG QA System - Enhanced</h1>
        
        <!-- Settings Section -->
        <div class="settings-section">
            <h4><i class="fas fa-cog"></i> ì‹œìŠ¤í…œ ì„¤ì •</h4>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">LLM ëª¨ë¸ ì„ íƒ:</label>
                    <select class="form-select model-selector" id="llmModel">
                        <option value="gpt-4o-mini" selected>GPT-4o-mini (ë¹ ë¦„)</option>
                        <option value="gpt-4-turbo">GPT-4.1-mini (ì •í™•í•¨)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ì²­í¬ í¬ê¸°:</label>
                    <input type="number" class="form-control" id="chunkSize" value="1000">
                </div>
                <div class="col-md-4">
                    <label class="form-label">ì²­í¬ ê²¹ì¹¨:</label>
                    <input type="number" class="form-control" id="chunkOverlap" value="200">
                </div>
            </div>
            <div class="vectordb-info mt-3">
                <strong>ğŸ“Š ë²¡í„°DB ì •ë³´:</strong> <span id="vectorDbInfo">ë¡œë”© ì¤‘...</span>
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="clearVectorDB()">
                    <i class="fas fa-trash"></i> DB ì´ˆê¸°í™”
                </button>
            </div>
        </div>
        
        <!-- Document Upload Section -->
        <div class="upload-section">
            <h4><i class="fas fa-upload"></i> ë¬¸ì„œ ê´€ë¦¬</h4>
            
            <!-- S3 Auto Load -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <button class="btn btn-success w-100" onclick="loadS3Documents()">
                        <i class="fas fa-folder-open"></i> S3 í´ë” ë¬¸ì„œ ìë™ ë¡œë“œ
                    </button>
                </div>
            </div>
            
            <!-- File Upload -->
            <div class="row">
                <div class="col-md-8">
                    <input type="file" class="form-control" id="fileInput" accept=".pdf,.txt,.docx,.md">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" onclick="uploadDocument()">
                        <i class="fas fa-upload"></i> íŒŒì¼ ì—…ë¡œë“œ
                    </button>
                </div>
            </div>
            
            <!-- Text Input -->
            <div class="mt-3">
                <h5>ë˜ëŠ” í…ìŠ¤íŠ¸ ì§ì ‘ ì…ë ¥:</h5>
                <textarea class="form-control" id="textInput" rows="3" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                <div class="mt-2">
                    <input type="text" class="form-control mb-2" id="textTitle" placeholder="ë¬¸ì„œ ì œëª© (ì„ íƒ)">
                    <button class="btn btn-secondary" onclick="uploadText()">
                        <i class="fas fa-plus"></i> í…ìŠ¤íŠ¸ ì¶”ê°€
                    </button>
                </div>
            </div>
            
            <!-- Document List -->
            <div class="mt-3">
                <h5>ğŸ“š ë¬¸ì„œ í˜„í™©:</h5>
                <div id="documentList" class="document-list"></div>
                <button class="btn btn-danger btn-sm mt-2" onclick="clearAllDocuments()">
                    <i class="fas fa-trash"></i> ëª¨ë“  ë¬¸ì„œ ì‚­ì œ
                </button>
            </div>
        </div>
        
        <!-- Chat Interface -->
        <div class="card">
            <div class="card-body">
                <div class="chat-container" id="chatContainer">
                    <div class="message ai-message">
                        <h3>ğŸ¤– RAG QA ì‹œìŠ¤í…œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h3>
                        <p>ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ê³  ì§ˆë¬¸í•´ì£¼ì„¸ìš”. ë‹¤ìŒ ê¸°ëŠ¥ë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>
                        <ul>
                            <li><strong>S3 ìë™ ë¡œë“œ:</strong> ë¯¸ë¦¬ ì¤€ë¹„ëœ ë¬¸ì„œë“¤ì„ í•œë²ˆì— ë¡œë“œ</li>
                            <li><strong>LLM ëª¨ë¸ ì„ íƒ:</strong> GPT-4o-mini ë˜ëŠ” GPT-4.1-mini ì„ íƒ</li>
                            <li><strong>ì‹¤ì‹œê°„ ì„¤ì •:</strong> ì²­í‚¹ í¬ê¸° ë° ê²¹ì¹¨ ì¡°ì •</li>
                        </ul>
                    </div>
                </div>
                <div class="input-group mt-3">
                    <input type="text" class="form-control" id="questionInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
                    <button class="btn btn-primary" onclick="sendQuestion()">
                        <i class="fas fa-paper-plane"></i> ì „ì†¡
                    </button>
                    <button class="btn btn-secondary" onclick="clearChat()">
                        <i class="fas fa-eraser"></i> ì´ˆê¸°í™”
                    </button>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="useMemory">
                    <label class="form-check-label" for="useMemory">
                        ëŒ€í™” ê¸°ë¡ ì‚¬ìš©
                    </label>
                </div>
            </div>
        </div>
        
        <!-- API Documentation Link -->
        <div class="text-center mt-4">
            <a href="/swagger/" class="btn btn-outline-info" target="_blank">
                <i class="fas fa-book"></i> API ë¬¸ì„œ (Swagger)
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Load initial data
        window.onload = function() {
            loadDocumentList();
            loadVectorDBInfo();
        };

        // Advanced markdown formatting function
        function formatMarkdown(text) {
            // First, handle tables (most important fix)
            text = formatTables(text);
            
            // Headers
            text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // Bold and italic
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Lists
            text = formatLists(text);
            
            // Line breaks and paragraphs
            text = text.replace(/\n\n/g, '</p><p>');
            text = '<p>' + text + '</p>';
            
            // Clean up empty paragraphs and fix structure
            text = text.replace(/<p><\/p>/g, '');
            text = text.replace(/<p>(<h[1-6])/g, '$1');
            text = text.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
            text = text.replace(/<p>(<table)/g, '$1');
            text = text.replace(/(<\/table>)<\/p>/g, '$1');
            text = text.replace(/<p>(<ul)/g, '$1');
            text = text.replace(/(<\/ul>)<\/p>/g, '$1');
            text = text.replace(/<p>(<ol)/g, '$1');
            text = text.replace(/(<\/ol>)<\/p>/g, '$1');
            
            return text;
        }

        function formatTables(text) {
            // Enhanced table formatting
            const tablePattern = /(\|[^|\n]*\|[^|\n]*\|[^\n]*\n)+/g;
            
            return text.replace(tablePattern, (match) => {
                const rows = match.trim().split('\n');
                if (rows.length < 2) return match;
                
                let table = '<table class="table table-striped table-bordered">';
                let hasHeader = false;
                
                rows.forEach((row, index) => {
                    // Skip separator rows like |---|---|
                    if (row.includes('---') || row.includes(':--')) {
                        hasHeader = true;
                        return;
                    }
                    
                    const cells = row.split('|').map(cell => cell.trim()).filter(cell => cell !== '');
                    
                    if (cells.length === 0) return;
                    
                    // First row is header if we haven't seen a separator yet, or if this is the first row
                    const isHeader = (index === 0 && !hasHeader);
                    const tag = isHeader ? 'th' : 'td';
                    const section = isHeader ? 'thead' : 'tbody';
                    
                    if (isHeader && index === 0) {
                        table += '<thead>';
                    } else if (!isHeader && index === 1 && hasHeader) {
                        table += '</thead><tbody>';
                    } else if (!isHeader && index === 1 && !hasHeader) {
                        table += '<tbody>';
                    }
                    
                    table += '<tr>';
                    cells.forEach(cell => {
                        // Process cell content for markdown
                        let cellContent = cell;
                        cellContent = cellContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        cellContent = cellContent.replace(/\*(.*?)\*/g, '<em>$1</em>');
                        table += `<${tag}>${cellContent}</${tag}>`;
                    });
                    table += '</tr>';
                });
                
                if (hasHeader) {
                    table += '</tbody>';
                } else {
                    table += '</tbody>';
                }
                table += '</table>';
                
                return table;
            });
        }

        function formatLists(text) {
            // Enhanced list formatting
            const lines = text.split('\n');
            let result = [];
            let inList = false;
            let listType = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const isUnorderedItem = /^\s*[-*+]\s+(.+)/.test(line);
                const isOrderedItem = /^\s*\d+\.\s+(.+)/.test(line);
                const isCheckItem = /^\s*[-*+]\s*âœ…\s*(.+)/.test(line);
                
                if (isCheckItem) {
                    const content = line.replace(/^\s*[-*+]\s*âœ…\s*/, '');
                    if (!inList || listType !== 'check') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ul class="list-check">');
                        inList = true;
                        listType = 'check';
                    }
                    result.push(`<li><i class="fas fa-check-circle text-success"></i> ${content}</li>`);
                } else if (isUnorderedItem) {
                    const content = line.replace(/^\s*[-*+]\s+/, '');
                    if (!inList || listType !== 'ul') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ul>');
                        inList = true;
                        listType = 'ul';
                    }
                    result.push(`<li>${content}</li>`);
                } else if (isOrderedItem) {
                    const content = line.replace(/^\s*\d+\.\s+/, '');
                    if (!inList || listType !== 'ol') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ol>');
                        inList = true;
                        listType = 'ol';
                    }
                    result.push(`<li>${content}</li>`);
                } else {
                    if (inList) {
                        result.push(`</${listType}>`);
                        inList = false;
                        listType = '';
                    }
                    result.push(line);
                }
            }
            
            if (inList) {
                result.push(`</${listType}>`);
            }
            
            return result.join('\n');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendQuestion();
            }
        }

        async function sendQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            if (!question) return;

            const chatContainer = document.getElementById('chatContainer');
            const useMemory = document.getElementById('useMemory').checked;
            const llmModel = document.getElementById('llmModel').value;

            // Add user message
            chatContainer.innerHTML += `<div class="message user-message">${question}</div>`;
            input.value = '';

            try {
                const response = await fetch('/api/chat/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question: question,
                        use_memory: useMemory,
                        llm_model: llmModel
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    chatContainer.innerHTML += `<div class="message ai-message">âŒ ì˜¤ë¥˜: ${data.error}</div>`;
                } else {
                    // Format the answer with markdown
                    const formattedAnswer = formatMarkdown(data.answer);
                    let aiMessage = `<div class="message ai-message">${formattedAnswer}`;
                    
                    // Add model info
                    aiMessage += `<div class="mt-2"><small class="text-muted">ğŸ¤– Model: ${data.model_used || llmModel}</small></div>`;
                    
                    // Add source documents if available
                    if (data.source_documents && data.source_documents.length > 0) {
                        aiMessage += '<div class="source-doc"><strong>ğŸ“„ ì°¸ê³  ë¬¸ì„œ:</strong><br>';
                        data.source_documents.forEach((doc, idx) => {
                            aiMessage += `${idx + 1}. ${doc.metadata.source_file || doc.metadata.title || doc.metadata.filename || 'Unknown'}<br>`;
                        });
                        aiMessage += '</div>';
                    }
                    
                    aiMessage += '</div>';
                    chatContainer.innerHTML += aiMessage;
                }
            } catch (error) {
                chatContainer.innerHTML += `<div class="message ai-message">âŒ ì˜¤ë¥˜: ${error.message}</div>`;
            }

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function loadS3Documents() {
            try {
                const response = await fetch('/api/document/load-s3', {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.error) {
                    alert(`S3 ë¡œë“œ ì‹¤íŒ¨: ${data.error}`);
                } else {
                    alert(`S3 ë¡œë“œ ì„±ê³µ! ${data.documents_loaded || 0}ê°œ ë¬¸ì„œ, ${data.total_chunks || 0}ê°œ ì²­í¬ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    loadDocumentList();
                    loadVectorDBInfo();
                }
            } catch (error) {
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function uploadDocument() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/document/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.error) {
                    alert(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${data.error}`);
                } else {
                    alert(`ì—…ë¡œë“œ ì„±ê³µ! ${data.chunks_created || 0}ê°œì˜ ì²­í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    fileInput.value = '';
                    loadDocumentList();
                    loadVectorDBInfo();
                }
            } catch (error) {
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function uploadText() {
            const textInput = document.getElementById('textInput');
            const titleInput = document.getElementById('textTitle');
            const text = textInput.value.trim();
            const title = titleInput.value.trim() || 'Direct Input ' + new Date().toLocaleString();
            
            if (!text) {
                alert('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/document/upload-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        text: text,
                        title: title
                    })
                });

                const data = await response.json();
                if (data.error) {
                    alert(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${data.error}`);
                } else {
                    alert(`í…ìŠ¤íŠ¸ ì¶”ê°€ ì„±ê³µ! ${data.chunks_created || 0}ê°œì˜ ì²­í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    textInput.value = '';
                    titleInput.value = '';
                    loadDocumentList();
                    loadVectorDBInfo();
                }
            } catch (error) {
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function loadDocumentList() {
            try {
                const response = await fetch('/api/document/list');
                const data = await response.json();
                
                const listContainer = document.getElementById('documentList');
                if (data.files && data.files.length > 0) {
                    listContainer.innerHTML = data.files.map(file => 
                        `<div>ğŸ“„ ${file.filename} (${(file.size / 1024).toFixed(2)} KB)</div>`
                    ).join('');
                    listContainer.innerHTML += `<div class="mt-2"><strong>ì´ ì²­í¬ ìˆ˜: ${data.total_chunks || 0}</strong></div>`;
                } else {
                    listContainer.innerHTML = '<div class="text-muted">ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } catch (error) {
                console.error('ë¬¸ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        async function loadVectorDBInfo() {
            try {
                const response = await fetch('/api/v1/vectordb/info');
                const data = await response.json();
                
                document.getElementById('vectorDbInfo').innerHTML = 
                    `ì´ ${data.total_documents || 0}ê°œ ë¬¸ì„œ, ${data.embedding_model || 'Unknown'} ì„ë² ë”©, ${data.vector_db_type || 'Unknown'}`;
            } catch (error) {
                console.error('ë²¡í„°DB ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        async function clearVectorDB() {
            if (!confirm('ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch('/api/v1/vectordb/clear', {
                    method: 'DELETE'
                });

                const data = await response.json();
                const result = await response.json();
                alert(result.message || 'ë²¡í„°DBê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadDocumentList();
                loadVectorDBInfo();
            } catch (error) {
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function clearAllDocuments() {
            if (!confirm('ëª¨ë“  ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch('/api/document/clear-all', {
                    method: 'DELETE'
                });

                const data = await response.json();
                const result = await response.json();
                alert(result.message || 'ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadDocumentList();
                loadVectorDBInfo();
            } catch (error) {
                alert(`ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function clearChat() {
            document.getElementById('chatContainer').innerHTML = 
                '<div class="message ai-message"><h3>ğŸ¤– ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</h3><p>ìƒˆë¡œìš´ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.</p></div>';
            
            // Clear memory on server
            await fetch('/api/chat/clear-memory', { method: 'POST' });
        }
    </script>
</body>
</html>