<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEOTIS RAG QA System - ÌÜµÌï© Î≤§ÏπòÎßàÌÇπ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #2c3e50;
            margin: 0;
        }
        
        .admin-btn {
            padding: 0.5rem 1rem;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .admin-btn:hover {
            background: #c0392b;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 80px);
            margin: 0;
            padding: 0;
        }
        
        /* ÏÇ¨Ïù¥ÎìúÎ∞î */
        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        
        /* Î©îÏù∏ Ïª®ÌÖêÏ∏† */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* ÏÇ¨Ïù¥ÎìúÎ∞î Ïª®ÌÖêÏ∏† */
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
            background: #2c3e50;
            color: white;
        }
        
        .sidebar-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .new-chat-section {
            margin-bottom: 1rem;
        }
        
        .new-chat-btn {
            width: 100%;
            padding: 1rem;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .new-chat-btn:hover {
            background: #219a52;
        }
        
        .delete-history-btn {
            width: 100%;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }
        
        .delete-history-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }
        
        .delete-history-btn:active {
            transform: translateY(0);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .chat-history-section {
            margin-top: 1.5rem;
        }
        
        .history-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .history-list-sidebar {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .history-item-sidebar {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .history-item-sidebar:hover {
            background: #e3f2fd;
            border-left-color: #3498db;
        }
        
        .history-item-sidebar.active {
            background: #e8f5e8;
            border-left-color: #27ae60;
        }
        
        .history-question {
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
            line-height: 1.3;
        }
        
        .history-meta {
            font-size: 0.75rem;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        
        /* ÏãúÏä§ÌÖú Ï†ïÎ≥¥ (Í∞ÑÏÜåÌôî) */
        .system-info {
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #e0e0e0;
        }
        
        .system-info h3 {
            margin: 0 0 1rem 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .info-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .info-badge {
            padding: 0.25rem 0.75rem;
            background: #e8f4f8;
            color: #2c3e50;
            border-radius: 12px;
            font-size: 0.8rem;
            border: 1px solid #3498db;
        }
        
        /* Ï±ÑÌåÖ ÏûÖÎ†• ÏòÅÏó≠ */
        .chat-input-area {
            padding: 1.5rem;
            background: white;
            border-top: 1px solid #e0e0e0;
        }
        
        /* Í≤∞Í≥º Í∑∏Î¶¨Îìú ÏòÅÏó≠ */
        .results-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .results-grid-realtime {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .result-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            opacity: 1;
            min-height: 300px;
            font-size: 0.9rem;
            transform: translateY(0);
            transition: all 0.5s ease;
            display: block;
            visibility: visible;
        }
        
        .result-card.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .result-card.loading {
            opacity: 0.7;
        }
        
        .result-card-header {
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-card-title {
            margin: 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .similarity-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .result-card-content {
            padding: 1rem;
        }
        
        .answer-text {
            line-height: 1.6;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .result-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #666;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        
        .result-meta span {
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .result-meta span.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .result-meta span.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .loading-card {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            background: white;
            border-radius: 12px;
            border: 2px dashed #ddd;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }
        
        .low-similarity-card {
            background: #fff3cd !important;
            border: 2px solid #ffeaa7 !important;
            opacity: 1 !important;
            display: block !important;
            visibility: visible !important;
        }
        
        .low-similarity-header {
            background: #ffeaa7;
            color: #856404;
        }
        
        .question-confirm {
            text-align: center;
            padding: 2rem;
        }
        
        .question-confirm h4 {
            margin-bottom: 1rem;
            color: #856404;
        }
        
        .confirm-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        
        .confirm-btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .confirm-btn.yes {
            background: #27ae60;
            color: white;
        }
        
        .confirm-btn.yes:hover {
            background: #219a52;
        }
        
        .confirm-btn.no {
            background: #e74c3c;
            color: white;
        }
        
        .confirm-btn.no:hover {
            background: #c0392b;
        }
        
        .chat-header {
            background: #2c3e50;
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .chat-header h3 {
            margin: 0;
        }
        
        .chat-history-dropdown {
            position: relative;
        }
        
        .history-btn {
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s;
        }
        
        .history-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .history-list {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 300px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .history-list.show {
            display: block;
        }
        
        .history-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            color: #333;
            transition: background 0.3s;
        }
        
        .history-item:hover {
            background: #f8f9fa;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-question {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .history-date {
            font-size: 0.8rem;
            color: #666;
        }
        
        .history-empty {
            padding: 1rem;
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .new-chat-btn {
            padding: 0.5rem 1rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: #3498db;
            color: white;
        }
        
        .message.bot .message-avatar {
            background: #27ae60;
            color: white;
        }
        
        .message-content {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 12px;
            max-width: 80%;
            position: relative;
        }
        
        .message.user .message-content {
            background: #3498db;
            color: white;
        }
        
        .message-meta {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .similarity-options {
            margin-top: 1rem;
            padding: 1rem;
            background: #fff3cd;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }
        
        .similarity-option {
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .similarity-option:hover {
            background: #f8f9fa;
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
            transform: translateY(-1px);
        }
        
        .similarity-option:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .low-similarity-card {
            border-left: 4px solid #f39c12;
        }
        
        .low-similarity-header {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        /* Ï±ÑÌåÖ ÏûÖÎ†• */
        .chat-input-container {
            padding: 1rem 1.5rem;
            border-top: 1px solid #eee;
        }
        
        .chat-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        
        .summarize-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        
        .summarize-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-input {
            display: flex;
            gap: 0.75rem;
        }
        
        .chat-input input {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .chat-input input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .send-btn {
            padding: 1rem 2rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .send-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .send-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Î≤§ÏπòÎßàÌÇπ Í≤∞Í≥º */
        .benchmark-results {
            display: none;
            margin-top: 2rem;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }
        
        .result-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border-left: 4px solid transparent;
        }
        
        .result-panel.api {
            border-left-color: #3498db;
        }
        
        .result-panel.local {
            border-left-color: #27ae60;
        }
        
        .panel-header {
            padding: 1rem 1.5rem;
            background: rgba(0,0,0,0.05);
            border-bottom: 1px solid #eee;
        }
        
        .panel-title {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .api .panel-title {
            color: #3498db;
        }
        
        .local .panel-title {
            color: #27ae60;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            padding: 1rem 1.5rem;
        }
        
        .metric {
            text-align: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .metric-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .metric-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        
        .panel-content {
            padding: 1.5rem;
        }
        
        .answer-content {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            line-height: 1.6;
            margin-bottom: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .source-info {
            padding: 1rem;
            background: #e8f4f8;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .source-info h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            color: #2c3e50;
        }
        
        .source-list {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê */
        .admin-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
        .admin-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }
        
        .admin-actions {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .admin-action-btn {
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
        }
        
        .admin-action-btn:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }
        
        .admin-action-btn.danger:hover {
            border-color: #e74c3c;
            background: #ffebee;
        }

        /* Ï¥àÍ∏∞Ìôî Îã®Í≥Ñ Ïä§ÌÉÄÏùº */
        .init-step {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 1rem;
            border-left: 4px solid #007bff;
        }

        .init-step i {
            margin-right: 0.8rem;
            width: 20px;
            color: #007bff;
        }

        .init-step i.fa-check-circle {
            color: #28a745 !important;
        }
        
        /* Î°úÎî© ÏÉÅÌÉú */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .process-loading-spinner {
            width: 60px !important;
            height: 60px !important;
            min-width: 60px !important;
            min-height: 60px !important;
            border: 6px solid rgba(102, 126, 234, 0.2) !important;
            border-top: 6px solid #667eea !important;
            border-right: 6px solid #764ba2 !important;
            border-radius: 50% !important;
            animation: spin 1.2s linear infinite !important;
            margin: 20px auto !important;
            display: block !important;
            position: relative !important;
            z-index: 10 !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
            box-sizing: border-box !important;
            flex-shrink: 0 !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Í∏∞Î≥∏ Ïä§ÌîºÎÑàÍ∞Ä ÏïàÎ≥¥Ïùº Îïå ÎåÄÏ≤¥Ïö© */
        .process-loading-spinner::before {
            content: "‚è≥";
            font-size: 24px !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            animation: bounce 1s infinite !important;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translate(-50%, -50%) translateY(0); }
            40% { transform: translate(-50%, -50%) translateY(-10px); }
            60% { transform: translate(-50%, -50%) translateY(-5px); }
        }
        
        /* Í∞ïÎ†•Ìïú Ïï†ÎãàÎ©îÏù¥ÏÖò ÌÇ§ÌîÑÎ†àÏûÑ */
        @keyframes spin {
            0% { 
                transform: rotate(0deg) !important; 
                border-top-color: #667eea !important;
            }
            25% { 
                transform: rotate(90deg) !important; 
                border-top-color: #764ba2 !important;
            }
            50% { 
                transform: rotate(180deg) !important; 
                border-top-color: #667eea !important;
            }
            75% { 
                transform: rotate(270deg) !important; 
                border-top-color: #764ba2 !important;
            }
            100% { 
                transform: rotate(360deg) !important; 
                border-top-color: #667eea !important;
            }
        }
        
        /* Î°úÎî© Ïª®ÌÖåÏù¥ÎÑà Ïä§ÌÉÄÏùº Í∞ïÌôî */
        .loading-container {
            text-align: center !important;
            padding: 40px 20px !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
            border: 2px solid rgba(102, 126, 234, 0.3) !important;
            border-radius: 12px !important;
            min-height: 180px !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            position: relative !important;
            z-index: 1 !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05) !important;
        }
        
        /* ÌîÑÎ°úÏÑ∏Ïä§ Ïπ¥Îìú Î°úÎî© ÏÉÅÌÉú */
        .process-card.loading {
            opacity: 1 !important;
            border-left: 4px solid #007bff !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        }
        
        .process-card-body.loading {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            min-height: 120px !important;
        }
        
        /* ÌîÑÎ°úÏÑ∏Ïä§ Ïπ¥Îìú ÎåÄÍ∏∞ ÏÉÅÌÉú */
        .process-card.waiting {
            opacity: 0.6 !important;
            border-left: 4px solid #ffa500 !important;
            background: linear-gradient(135deg, #fffbf0 0%, #fff3cd 100%) !important;
        }
        
        .process-card-body.waiting {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            min-height: 120px !important;
            flex-direction: column;
        }
        
        .waiting-icon {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* ÌîÑÎ°úÏÑ∏Ïä§ Ïπ¥Îìú ÏÑ±Í≥µ ÏÉÅÌÉú */
        .process-card.success {
            border-left: 4px solid #28a745 !important;
            background: linear-gradient(135deg, #f8fff9 0%, #e6ffed 100%) !important;
        }
        
        /* ÌîÑÎ°úÏÑ∏Ïä§ Ïπ¥Îìú ÏóêÎü¨ ÏÉÅÌÉú */
        .process-card.error {
            border-left: 4px solid #dc3545 !important;
            background: linear-gradient(135deg, #fff8f8 0%, #ffeded 100%) !important;
        }
        
        /* Î°úÎî© Ï†êÎì§ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .loading-dots span {
            animation: blink 1.4s infinite both;
            font-size: 1.2em;
            margin: 0 2px;
        }
        
        .loading-dots span:nth-child(1) { animation-delay: 0s; }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes blink {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }
        
        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .info-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .results-grid-realtime {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chat-options {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .history-list {
                min-width: 250px;
            }
        }
        
        @media (max-width: 480px) {
            .info-cards {
                grid-template-columns: 1fr;
            }
            
            .results-grid-realtime {
                grid-template-columns: 1fr;
                gap: 1rem;
                max-width: 100%;
            }
        }
        
        /* ÌîÑÎ°úÏÑ∏Ïä§ Ïπ¥Îìú Ìó§Îçî (Í∞ÄÎ°ú Î∞∞Ïó¥) */
        .process-cards-header {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .process-card {
            background: white !important;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #dee2e6 !important;
            overflow: hidden;
            min-height: auto;
            transition: all 0.3s ease;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
        }
        
        /* Ï§ëÎ≥µ Ï†úÍ±∞Îê® - ÏúÑÏóêÏÑú Ï†ïÏùòÌï® */
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
        }
        
        .card-content {
            padding: 1rem;
            height: calc(100% - 60px);
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .card-content.waiting {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-style: italic;
        }
        
        .card-content.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #007bff;
        }
        
        .card-loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 0.5rem;
        }
        
        /* ÏßàÎ¨∏ ÌëúÏãú ÏòÅÏó≠ */
        .question-display-area {
            padding: 1rem 1.5rem;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .question-text {
            font-size: 1.1rem;
            font-weight: 500;
            color: #2c3e50;
            text-align: center;
        }
        
        /* ÌïòÎã® ÏûÖÎ†•Ï∞Ω Í≥†Ï†ï */
        .chat-input-area-fixed {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        /* Ïú†ÏÇ¨ÎèÑ Ï†ïÎ≥¥ Ïä§ÌÉÄÏùº */
        .similarity-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(0,123,255,0.1);
            border-radius: 8px;
            border-left: 3px solid #007bff;
        }
        
        .similarity-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .similarity-item {
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(0,123,255,0.2);
            padding-bottom: 0.5rem;
        }
        
        .similarity-rank {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        
        .similarity-content {
            color: #6c757d;
            font-size: 0.8rem;
            line-height: 1.3;
        }
        
        .card-meta {
            margin-top: 1rem;
            padding: 0.5rem;
            background: rgba(40,167,69,0.1);
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
        
        .card-meta.error {
            background: rgba(220,53,69,0.1);
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: bold;
        }
        
        .status-badge.success {
            color: #28a745;
        }
        
        .status-badge.error {
            color: #dc3545;
        }
        
        .time-badge {
            color: #6c757d;
            font-weight: bold;
        }
        
        /* Î∞òÏùëÌòï Ïπ¥Îìú Î†àÏù¥ÏïÑÏõÉ */
        @media (max-width: 1200px) {
            .process-cards-header {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            .process-cards-group {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
        }
        
        @media (max-width: 768px) {
            .process-cards-header {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .card-header {
                font-size: 0.8rem;
                padding: 0.5rem;
            }
        }
        
        /* Ï±ÑÌåÖ ÌûàÏä§ÌÜ†Î¶¨ ÏòÅÏó≠ */
        .chat-history-area {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
        }
        
        /* ÏßàÎ¨∏-ÎãµÎ≥Ä Í∑∏Î£π */
        .qa-group {
            margin-bottom: 2rem;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
        }
        
        /* ÏÇ¨Ïö©Ïûê ÏßàÎ¨∏ (Ïò§Î•∏Ï™Ω Ï†ïÎ†¨) */
        .user-question {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }
        
        .user-question-content {
            max-width: 70%;
            background: #007bff;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            border-bottom-right-radius: 4px;
            font-size: 1rem;
            word-wrap: break-word;
        }
        
        /* 2Í∞ú ÌîÑÎ°úÏÑ∏Ïä§ Ïπ¥Îìú Í∑∏Î£π (Í∞ÄÎ°ú 1Ï§Ñ) */
        .process-cards-group {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
            opacity: 1 !important;
            visibility: visible !important;
            min-height: 250px; /* ÏµúÏÜå ÎÜíÏù¥ Î≥¥Ïû• */
        }
        
        /* Í∞úÎ≥Ñ ÌîÑÎ°úÏÑ∏Ïä§ Ïπ¥Îìú */
        .process-card {
            background: white !important;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #dee2e6 !important;
            overflow: hidden;
            min-height: auto;
            transition: all 0.3s ease;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
        }
        
        /* Ï§ëÎ≥µ Ï†úÍ±∞Îê® - ÏúÑÏóêÏÑú Ï†ïÏùòÌï® */
        
        .process-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
        }
        
        .process-card-body {
            padding: 0.75rem;
            height: calc(100% - 60px);
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .process-card-body.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #007bff;
        }
        
        /* Î°úÎî© Ïä§ÌîºÎÑà Ïä§ÌÉÄÏùº - Ï§ëÎ≥µ Ï†úÍ±∞Îê® */
        
        /* ÎåÄÏ≤¥ Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖò (Ï†ê 3Í∞ú) */
        .loading-dots {
            display: inline-flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .loading-dots span {
            width: 8px;
            height: 8px;
            background-color: #667eea;
            border-radius: 50%;
            animation: pulse 1.4s ease-in-out infinite;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes pulse {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }
        
        /* Î°úÎî© ÏßÑÌñâ ÌÖçÏä§Ìä∏ */
        .loading-progress {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        /* Î°úÎî© ÏãúÍ∞Ñ ÌëúÏãú */
        .loading-timer {
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.25rem;
        }
        
        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 1200px) {
            .process-cards-group {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
        }
        
        @media (max-width: 768px) {
            .user-question-content {
                max-width: 85%;
            }
            
            .process-cards-group {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .process-card-header {
                font-size: 0.8rem;
                padding: 0.5rem;
            }
            
            .process-card-body {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>DEOTIS RAG QA System</h1>
            <button class="admin-btn" onclick="showAdminPanel()">
                <i class="fas fa-cog"></i> ÏãúÏä§ÌÖú Í¥ÄÎ¶¨
            </button>
        </div>
    </div>
    
    <div class="container">
        <!-- ÏÇ¨Ïù¥ÎìúÎ∞î -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>üí¨ DEOTIS RAG</h2>
            </div>
            
            <div class="sidebar-content">
                <!-- ÏÉà Ï±ÑÌåÖ Î≤ÑÌäº -->
                <div class="new-chat-section">
                    <button class="new-chat-btn" onclick="newChat()">
                        <i class="fas fa-plus"></i>
                        ÏÉà Ï±ÑÌåÖ ÏãúÏûë
                    </button>
                    
                    <!-- Ï±ÑÌåÖ Î™©Î°ù ÏÇ≠Ï†ú Î≤ÑÌäº -->
                    <button class="delete-history-btn" onclick="clearChatHistory()" title="Î™®Îì† Ï±ÑÌåÖ Í∏∞Î°ù ÏÇ≠Ï†ú">
                        <i class="fas fa-trash-alt"></i>
                        Ï±ÑÌåÖ Í∏∞Î°ù ÏÇ≠Ï†ú
                    </button>
                </div>
                
                <!-- ÏãúÏä§ÌÖú Ï†ïÎ≥¥ -->
                <div class="system-info">
                    <h3>üéØ 2Í∞ÄÏßÄ ÎπÑÍµê Î∂ÑÏÑù</h3>
                    <div class="info-badges">
                        <span class="info-badge">üè† Î°úÏª¨ Í∏∞Î≥∏</span>
                        <span class="info-badge">üèóÔ∏è Î°úÏª¨ Ïª§Ïä§ÌÖÄ</span>
                    </div>
                </div>
                
                <!-- Ï±ÑÌåÖ ÌûàÏä§ÌÜ†Î¶¨ -->
                <div class="chat-history-section">
                    <div class="history-title">Ï±ÑÌåÖ Í∏∞Î°ù</div>
                    <div class="history-list-sidebar" id="historySidebar">
                        <div style="text-align: center; color: #666; font-style: italic; padding: 1rem;">
                            Ï±ÑÌåÖ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
        <div class="main-content">
            <!-- Ï±ÑÌåÖ ÌûàÏä§ÌÜ†Î¶¨ ÏòÅÏó≠ -->
            <div class="chat-history-area" id="chatHistory">
                <div class="welcome-message">
                    <div style="text-align: center; padding: 2rem; color: #666; background: #f8f9fa; border-radius: 12px; margin: 1rem;">
                        <h3 style="margin-bottom: 1rem; color: #2c3e50;">üí¨ Ï±ÑÌåÖ ÏãúÏûë</h3>
                        <p>ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÎ©¥ 2Í∞ú ÌîÑÎ°úÏÑ∏Ïä§ÏóêÏÑú Í∞ÅÍ∞Å ÎãµÎ≥ÄÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§.</p>
                        <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap; margin-top: 1rem;">
                            <span class="info-badge">üè† ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM+Í∏∞Î≥∏</span>
                            <span class="info-badge">üîß ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM+Ïª§Ïä§ÌÖÄ</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ï±ÑÌåÖ ÏûÖÎ†•Ï∞Ω (ÌïòÎã® Í≥†Ï†ï) -->
            <div class="chat-input-area-fixed">
                <div style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="summarizeCheck" style="margin: 0;" onchange="updateSummarizeMode()">
                        <label for="summarizeCheck" style="font-size: 0.9rem; color: #495057; font-weight: 500; cursor: pointer;">
                            üìù ÏöîÏïΩ Î™®Îìú <span id="summarizeStatus" style="color: #6c757d; font-size: 0.8rem;">(ÏÉÅÏÑ∏ ÎãµÎ≥Ä)</span>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label for="localModelSelect" style="font-size: 0.9rem; color: #495057; font-weight: 500;">ü§ñ Î°úÏª¨ Î™®Îç∏:</label>
                        <select id="localModelSelect" style="padding: 0.3rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; background: white;">
                            <option value="./models/kanana8b" selected>kanana8b (ÌòÑÏû¨ ÏÑúÎ≤Ñ Î™®Îç∏)</option>
                            <option value="Qwen/Qwen3-32B-AWQ">Qwen/Qwen3-32B-AWQ</option>
                            <option value="meta-llama/Llama-2-7b-chat-hf">Llama-2-7b-chat</option>
                            <option value="microsoft/DialoGPT-medium">DialoGPT-medium</option>
                        </select>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî... (Ïòà: Ïó∞ÌöåÎπÑ ÎÇ©Î∂Ä)">
                    <button class="send-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        
        <!-- Ï±ÑÌåÖ Ïª®ÌÖåÏù¥ÎÑà Ïà®ÍπÄ (Ïπ¥Îìú Î†àÏù¥ÏïÑÏõÉ ÏÇ¨Ïö©) -->
        <div id="chatContainer" style="display: none;">
            <div id="chatMessages" style="padding: 1rem;">
                <!-- ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå -->
            </div>
        </div>

        <!-- Í∏∞Ï°¥ Î≤§ÏπòÎßàÌÇπ Í≤∞Í≥º (Ïà®ÍπÄ) -->
        <div class="benchmark-results" id="benchmarkResults" style="display: none;">
            <div class="results-grid" id="resultsGrid">
                <!-- Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
        </div>
    </div>
    
    <!-- Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-content">
            <h3>üîß ÏãúÏä§ÌÖú Í¥ÄÎ¶¨</h3>
            <p>ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Î∞è Î¨∏ÏÑú Î°úÎìú Í∏∞Îä•</p>
            
            <div class="admin-actions">
                <button class="admin-action-btn danger" onclick="initializeSystem()">
                    <h4>üîÑ Ï†ÑÏ≤¥ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî</h4>
                    <p>Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÍ≥† S3ÏóêÏÑú Î¨∏ÏÑúÎ•º Îã§Ïãú Î°úÎìúÌï©ÎãàÎã§</p>
                </button>
                
                <button class="admin-action-btn" onclick="reloadDocuments()">
                    <h4>üì• Î¨∏ÏÑúÎßå Îã§Ïãú Î°úÎìú</h4>
                    <p>S3 Ìè¥ÎçîÏóêÏÑú Î¨∏ÏÑúÎ•º Îã§Ïãú Î°úÎìúÌï©ÎãàÎã§ (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ)</p>
                </button>
            </div>
            
            <div style="margin-top: 1rem; text-align: center;">
                <button onclick="hideAdminPanel()" style="padding: 0.5rem 1rem; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    Îã´Í∏∞
                </button>
            </div>
        </div>
    </div>

    <!-- Ï¥àÍ∏∞Ìôî ÏßÑÌñâ ÌåùÏóÖ -->
    <div class="admin-panel" id="initializationPopup" style="display: none;">
        <div class="admin-content" style="max-width: 600px;">
            <h3>üîÑ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ï§ë...</h3>
            <div id="initializationStatus">
                <div class="init-step" id="step1">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ï§ë...</span>
                </div>
                <div class="init-step" id="step2" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>S3 Ìè¥ÎçîÏóêÏÑú Î¨∏ÏÑú Î°úÎìú Ï§ë...</span>
                </div>
                <div class="init-step" id="step3" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Î≤°ÌÑ∞ ÏûÑÎ≤†Îî© ÏÉùÏÑ± Ï§ë...</span>
                </div>
                <div class="init-step" id="stepComplete" style="display: none;">
                    <i class="fas fa-check-circle" style="color: #28a745;"></i>
                    <span>Ï¥àÍ∏∞Ìôî ÏôÑÎ£å! Ï±ÑÌåÖÏùÑ ÏãúÏûëÌï† Ïàò ÏûàÏäµÎãàÎã§.</span>
                </div>
            </div>
            
            <div id="initializationResult" style="display: none; margin-top: 1rem; text-align: center;">
                <button onclick="closeInitializationPopup()" style="padding: 0.8rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                    Ï±ÑÌåÖ ÏãúÏûëÌïòÍ∏∞
                </button>
            </div>
        </div>
    </div>
    
    <script>
        let currentQuery = '';
        let resultCount = 0;
        // chatSessions Ï¥àÍ∏∞Ìôî Ïãú ÌÉÄÏûÖ Ï≤¥ÌÅ¨
        let storedSessions = localStorage.getItem('chatSessions');
        let chatSessions = [];
        try {
            if (storedSessions) {
                const parsed = JSON.parse(storedSessions);
                // Î∞∞Ïó¥Ïù∏ÏßÄ ÌôïÏù∏
                if (Array.isArray(parsed)) {
                    chatSessions = parsed;
                } else if (typeof parsed === 'object' && parsed !== null) {
                    // Í∞ùÏ≤¥Ïù∏ Í≤ΩÏö∞ Î∞∞Ïó¥Î°ú Î≥ÄÌôò
                    chatSessions = Object.values(parsed);
                }
            }
        } catch (e) {
            console.error('chatSessions ÌååÏã± Ïò§Î•ò:', e);
            chatSessions = [];
        }
        let currentSessionId = null;
        let similarityData = {};
        let processTimers = {}; // Í∞Å ÌîÑÎ°úÏÑ∏Ïä§Î≥Ñ ÌÉÄÏù¥Î®∏ Ï†ÄÏû•
        let timerIntervals = {}; // ÌÉÄÏù¥Î®∏ Ïù∏ÌÑ∞Î≤å ID Ï†ÄÏû•
        
        // Ï±ÑÌåÖ ÌûàÏä§ÌÜ†Î¶¨ ÌÜ†Í∏Ä
        function toggleHistory() {
            const historyList = document.getElementById('historyList');
            historyList.classList.toggle('show');
            
            if (historyList.classList.contains('show')) {
                updateHistoryList();
            }
        }
        
        // ÌûàÏä§ÌÜ†Î¶¨ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateHistoryList() {
            const historyList = document.getElementById('historyList');
            
            if (chatSessions.length === 0) {
                historyList.innerHTML = '<div class="history-empty">Ï±ÑÌåÖ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>';
                return;
            }
            
            historyList.innerHTML = chatSessions.map((session, index) => `
                <div class="history-item" onclick="loadChatSession(${index})">
                    <div class="history-question">${session.firstQuestion}</div>
                    <div class="history-date">${new Date(session.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
        }
        
        // Ï±ÑÌåÖ ÏÑ∏ÏÖò Î°úÎìú
        function loadChatSession(index) {
            const session = chatSessions[index];
            currentSessionId = index;
            chatHistory = session.messages;
            
            // Î©îÏãúÏßÄ Î≥µÏõê
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            chatHistory.forEach(msg => {
                if (msg.type === 'user') {
                    addMessage('user', msg.content);
                } else if (msg.type === 'benchmark') {
                    addMessage('bot', '4Í∞ÄÏßÄ Î∞©ÏãùÏùò ÎãµÎ≥ÄÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
                    displayBenchmarkResults(msg.content);
                }
            });
            
            // ÌûàÏä§ÌÜ†Î¶¨ Îã´Í∏∞
            document.getElementById('historyList').classList.remove('show');
        }
        
        // ÏÉà Ï±ÑÌåÖ
        function newChat() {
            console.log('üîÑ ÏÉà Ï±ÑÌåÖ ÏãúÏûë');
            
            chatHistory = [];
            currentSessionId = null;
            
            // Ï±ÑÌåÖ Î©îÏãúÏßÄ ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        üîÑ ÏÉàÎ°úÏö¥ Ï±ÑÌåÖÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§. ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.
                    </div>
                    <div id="autoReloadPrompt" style="display: none; text-align: center; padding: 2rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; margin: 1rem;">
                        <h4 style="color: #856404; margin-bottom: 1rem;">üìÇ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÌïÑÏöî</h4>
                        <p style="color: #856404; margin-bottom: 1.5rem;">Î≤°ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§. Î¨∏ÏÑúÎ•º Îã§Ïãú Î°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.</p>
                        <button onclick="autoLoadDocuments()" style="background: #28a745; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                            üì• S3 Î¨∏ÏÑú ÏûêÎèô Î°úÎìú
                        </button>
                    </div>
                `;
            }
            
            // Î≤§ÏπòÎßàÌÅ¨ Í≤∞Í≥º Ïà®Í∏∞Í∏∞
            const benchmarkResults = document.getElementById('benchmarkResults');
            if (benchmarkResults) {
                benchmarkResults.style.display = 'none';
            }
            
            // Í≤∞Í≥º ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
            const resultsGrid = document.getElementById('resultsGrid');
            if (resultsGrid) {
                resultsGrid.innerHTML = '';
                console.log('‚úÖ Í≤∞Í≥º ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            }
            
            // ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî Î∞è Ìè¨Ïª§Ïä§
            const questionInput = document.getElementById('questionInput');
            if (questionInput) {
                questionInput.value = '';
                questionInput.focus();
            }
            
            console.log('‚úÖ ÏÉà Ï±ÑÌåÖ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            
            // ÏãúÏä§ÌÖú ÏÉÅÌÉú Ï≤¥ÌÅ¨
            checkSystemStatus();
        }
        
        // ÏãúÏä§ÌÖú ÏÉÅÌÉú Ï≤¥ÌÅ¨ Ìï®Ïàò
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/document/status');
                const data = await response.json();
                
                // Î≤°ÌÑ∞ DBÍ∞Ä ÎπÑÏñ¥ÏûàÏúºÎ©¥ ÏûêÎèô Î¶¨Î°úÎìú ÌîÑÎ°¨ÌîÑÌä∏ ÌëúÏãú
                if (data.total_documents === 0) {
                    const autoReloadPrompt = document.getElementById('autoReloadPrompt');
                    if (autoReloadPrompt) {
                        autoReloadPrompt.style.display = 'block';
                        console.log('‚ö†Ô∏è Î≤°ÌÑ∞ DB ÎπÑÏñ¥ÏûàÏùå - ÏûêÎèô Î¶¨Î°úÎìú ÌîÑÎ°¨ÌîÑÌä∏ ÌëúÏãú');
                    }
                }
            } catch (error) {
                console.log('ÏãúÏä§ÌÖú ÏÉÅÌÉú Ï≤¥ÌÅ¨ Ïã§Ìå®:', error);
            }
        }
        
        // ÏûêÎèô Î¨∏ÏÑú Î°úÎìú Ìï®Ïàò
        async function autoLoadDocuments() {
            const button = event.target;
            const originalText = button.textContent;
            
            try {
                button.textContent = 'üì• Î°úÎî© Ï§ë...';
                button.disabled = true;
                
                const response = await fetch('/api/document/load-s3', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.documents_loaded) {
                    // ÏÑ±Í≥µ Ïãú ÌîÑÎ°¨ÌîÑÌä∏ Ïà®Í∏∞Í∏∞
                    const autoReloadPrompt = document.getElementById('autoReloadPrompt');
                    if (autoReloadPrompt) {
                        autoReloadPrompt.style.display = 'none';
                    }
                    
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                    alert(`‚úÖ Î¨∏ÏÑú Î°úÎìú ÏôÑÎ£å!\nüìÑ ${data.documents_loaded}Í∞ú Î¨∏ÏÑú, ${data.total_chunks}Í∞ú Ï≤≠ÌÅ¨Í∞Ä Î°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
                    console.log('‚úÖ ÏûêÎèô Î¨∏ÏÑú Î°úÎìú ÏÑ±Í≥µ');
                } else {
                    alert('‚ùå Î¨∏ÏÑú Î°úÎìú Ïã§Ìå®: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
                
            } catch (error) {
                alert('‚ùå Î¨∏ÏÑú Î°úÎìú Ï§ë Ïò§Î•ò Î∞úÏÉù: ' + error.message);
                console.error('ÏûêÎèô Î¨∏ÏÑú Î°úÎìú Ïò§Î•ò:', error);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // Ï±ÑÌåÖ Í∏∞Î°ù ÏÇ≠Ï†ú Ìï®Ïàò
        function clearChatHistory() {
            if (confirm('Î™®Îì† Ï±ÑÌåÖ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) {
                // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Ï±ÑÌåÖ ÏÑ∏ÏÖò ÏÇ≠Ï†ú
                localStorage.removeItem('chatSessions');
                chatSessions = [];
                
                // ÏÇ¨Ïù¥ÎìúÎ∞î ÌûàÏä§ÌÜ†Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏
                updateSidebarHistory();
                
                // ÌòÑÏû¨ Ï±ÑÌåÖÎèÑ Ï¥àÍ∏∞Ìôî
                newChat();
                
                // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #27ae60;
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    animation: slideIn 0.3s ease;
                `;
                toast.innerHTML = '<i class="fas fa-check"></i> Î™®Îì† Ï±ÑÌåÖ Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.';
                
                document.body.appendChild(toast);
                
                // 3Ï¥à ÌõÑ ÌÜ†Ïä§Ìä∏ Ï†úÍ±∞
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 3000);
            }
        }
        
        // HTML Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Ìï®Ïàò
        function escapeHtml(text) {
            if (text === '&nbsp;') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ÏöîÏïΩ Î™®Îìú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateSummarizeMode() {
            const checkbox = document.getElementById('summarizeCheck');
            const status = document.getElementById('summarizeStatus');
            
            if (checkbox && status) {
                if (checkbox.checked) {
                    status.textContent = '(Í∞ÑÍ≤∞Ìïú ÏöîÏïΩ)';
                    status.style.color = '#28a745';
                    console.log('‚úÖ ÏöîÏïΩ Î™®Îìú ÌôúÏÑ±Ìôî: LLMÏù¥ Í∞ÑÍ≤∞Ìïú ÏöîÏïΩ Ï†úÍ≥µ');
                } else {
                    status.textContent = '(ÏÉÅÏÑ∏ ÎãµÎ≥Ä)';
                    status.style.color = '#6c757d';
                    console.log('üìñ ÏùºÎ∞ò Î™®Îìú: Í≤ÄÏÉâÎêú ÎÇ¥Ïö© Í∑∏ÎåÄÎ°ú Ï∂úÎ†•');
                }
            }
        }
        
        // Ïπ¥ÎìúÎ™Ö Ï∂îÏ∂ú Ìï®Ïàò (Ïã§Ï†ú MD ÌååÏùºÏùò Ïù¥ÎØ∏ÏßÄ alt ÌÖçÏä§Ìä∏ Í∏∞Î∞ò)
        function extractCardNameFromAlt(altText) {
            if (!altText) return '';
            
            // Ïã§Ï†ú MD ÌååÏùºÏóê ÏûàÎäî Ïπ¥ÎìúÎ™Ö Ìå®ÌÑ¥ Îß§Ïπ≠
            const cardPatterns = {
                'Ïö∞Î¶¨Ïπ¥Îìú': ['Ïö∞Î¶¨Ïπ¥Îìú', 'woori'],
                'ÌïòÎÇòÏπ¥Îìú': ['ÌïòÎÇòÏπ¥Îìú', 'hana'], 
                'ÎÜçÌòëÏπ¥Îìú': ['NHÎÜçÌòëÏπ¥Îìú', 'ÎÜçÌòë', 'NH', 'nh'],
                'SCÏ†úÏùºÏùÄÌñâ': ['Standard Chartered', 'SCÏ†úÏùºÏùÄÌñâ', 'SC'],
                'Í∏∞ÏóÖÏùÄÌñâ': ['IBKÍ∏∞ÏóÖÏùÄÌñâ', 'IBK', 'Í∏∞ÏóÖÏùÄÌñâ'],
                'Íµ≠ÎØºÏπ¥Îìú': ['KBÍµ≠ÎØºÏπ¥Îìú', 'KB', 'Íµ≠ÎØº'],
                'ÎåÄÍµ¨ÏùÄÌñâ': ['DGBÎåÄÍµ¨ÏùÄÌñâ', 'DGB', 'ÎåÄÍµ¨'],
                'Î∂ÄÏÇ∞ÏùÄÌñâ': ['BNKÎ∂ÄÏÇ∞ÏùÄÌñâ', 'BNKÎ∂ÄÏÇ∞', 'Î∂ÄÏÇ∞'],
                'Í≤ΩÎÇ®ÏùÄÌñâ': ['BNKÍ≤ΩÎÇ®ÏùÄÌñâ', 'BNKÍ≤ΩÎÇ®', 'Í≤ΩÎÇ®'],
                'Ïî®Ìã∞ÏùÄÌñâ': ['citiÏùÄÌñâ', 'citi', 'Citi'],
                'Ïã†ÌïúÏπ¥Îìú': ['Ïã†ÌïúÏπ¥Îìú', 'shinhan', 'Shinhan'],
                'BCÏπ¥Îìú': ['BC Î∞îÎ°úÏπ¥Îìú', 'BC', 'bc', 'Î∞îÎ°úÏπ¥Îìú']
            };
            
            for (const [cardName, patterns] of Object.entries(cardPatterns)) {
                if (patterns.some(pattern => altText.includes(pattern))) {
                    return cardName;
                }
            }
            return altText;
        }
        
        // ÌÖçÏä§Ìä∏ Ìè¨Îß∑ÌåÖ Ìï®Ïàò
        function formatText(text) {
            if (!text) return '';
            
            console.log('üîß formatText input:', text.substring(0, 200) + '...');
            
            // 1Îã®Í≥Ñ: Ïù¥ÎØ∏ÏßÄ ÎßàÌÅ¨Îã§Ïö¥ÏùÑ Î≥¥Ìò∏ÌïòÍ∏∞ ÏúÑÌï¥ ÏûÑÏãú ÌîåÎ†àÏù¥Ïä§ÌôÄÎçîÎ°ú ÎåÄÏ≤¥
            const imageProtectionMap = new Map();
            let imageCounter = 0;
            let formatted = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, src) => {
                const placeholder = `__IMAGE_PLACEHOLDER_${imageCounter}__`;
                imageProtectionMap.set(placeholder, match);
                imageCounter++;
                return placeholder;
            });
            
            // 2Îã®Í≥Ñ: <think> ÌÉúÍ∑∏ÏôÄ ÎÇ¥Ïö© Ï†úÍ±∞ (Îã´Îäî ÌÉúÍ∑∏Í∞Ä ÏûàÎäî Í≤ΩÏö∞)
            formatted = formatted.replace(/<think>[\s\S]*?<\/think>/g, '');
            
            // <think>Î°ú ÏãúÏûëÌïòÎäî Î∂ÄÎ∂ÑÏù¥ ÎÇ®ÏïÑÏûàÏúºÎ©¥ ÎÅùÍπåÏßÄ Ï†úÍ±∞ (Îã´Îäî ÌÉúÍ∑∏Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÎåÄÎπÑ)
            formatted = formatted.replace(/<think>[\s\S]*$/g, '');
            
            // **ÎãµÎ≥Ä:** ÌòïÌÉúÎ°ú ÏãúÏûëÌïòÎäî ÌïúÍµ≠Ïñ¥ ÎãµÎ≥Ä Ï∂îÏ∂ú
            const answerMatch = formatted.match(/\*\*ÎãµÎ≥Ä:\*\*[\s\S]*$/);
            if (answerMatch) {
                formatted = answerMatch[0];
            }
            
            // Ï§ÑÎ∞îÍøà Ï†ïÍ∑úÌôî
            formatted = formatted.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // 1. ÎßàÌÅ¨Îã§Ïö¥ ÌÖåÏù¥Î∏î Í≤ÄÏ∂ú Î∞è Î≥ÄÌôò (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
            // Îçî Ï†ïÌôïÌïú ÎßàÌÅ¨Îã§Ïö¥ ÌÖåÏù¥Î∏î Í≤ÄÏ∂ú: Ïó∞ÏÜçÎêú | ÎùºÏù∏Îì§ÏùÑ ÌïòÎÇòÏùò ÌÖåÏù¥Î∏îÎ°ú Ïù∏Ïãù
            const markdownTableRegex = /((\|[^|\n]*)+\|[\s]*\n){2,}/g;
            const markdownTables = formatted.match(markdownTableRegex);
            
            if (markdownTables) {
                console.log('üîß Found markdown tables:', markdownTables.length);
                markdownTables.forEach((tableMatch, index) => {
                    console.log(`üîß Processing table ${index + 1}:`, tableMatch);
                    const tableHtml = convertMarkdownTableToHTML(tableMatch);
                    if (tableHtml) {
                        console.log(`üîß Table ${index + 1} converted to HTML`);
                        formatted = formatted.replace(tableMatch, tableHtml);
                    } else {
                        console.log(`üîß Table ${index + 1} failed to convert`);
                    }
                });
            }
            
            // 2. ÏùºÎ∞ò ÌÖçÏä§Ìä∏ ÌÖåÏù¥Î∏î Í≤ÄÏ∂ú (ÌÉ≠Ïù¥ÎÇò Ïó¨Îü¨ Í≥µÎ∞±ÏúºÎ°ú Íµ¨Î∂Ñ, ÎòêÎäî ÎßàÌÅ¨Îã§Ïö¥ ÏûîÏó¨Î¨º)
            const textTableRegex = /^([^\n]+\t[^\n]*\n)+/gm;
            const textTables = formatted.match(textTableRegex);
            
            // 3. ÎßàÌÅ¨Îã§Ïö¥ ÌÖåÏù¥Î∏î ÏûîÏó¨Î¨º Í≤ÄÏ∂ú (| Í∞Ä ÏûàÏßÄÎßå ÏôÑÏ†ÑÌïú ÎßàÌÅ¨Îã§Ïö¥Ïù¥ ÏïÑÎãå Í≤ΩÏö∞)
            const partialMarkdownTableRegex = /^[^|\n]*\|[^|\n]*\|[^|\n]*$/gm;
            const partialTables = formatted.match(partialMarkdownTableRegex);
            
            // 4. ÌäπÎ≥Ñ ÏºÄÏù¥Ïä§: ÌïúÍµ≠Ïñ¥ ÌÖåÏù¥Î∏î ÌòïÏãù (Ïòà: "Í≤∞Ï†úÏùºÏûê    ÏùºÏãúÎ∂à/Ìï†Î∂Ä Ïù¥Ïö©Í∏∞Í∞Ñ    ÌòÑÍ∏àÏÑúÎπÑÏä§ Ïù¥Ïö©Í∏∞Í∞Ñ")
            const koreanTablePattern = /^([Í∞Ä-Ìû£\w\s/]+\s{4,}[Í∞Ä-Ìû£\w\s/]+\s{4,}[Í∞Ä-Ìû£\w\s/]+.*\n)+/gm;
            const koreanTables = formatted.match(koreanTablePattern);
            
            if (textTables) {
                textTables.forEach(tableMatch => {
                    const tableHtml = convertTextTableToHTML(tableMatch);
                    if (tableHtml) {
                        formatted = formatted.replace(tableMatch, tableHtml);
                    }
                });
            }
            
            // Î∂ÄÎ∂Ñ ÎßàÌÅ¨Îã§Ïö¥ ÌÖåÏù¥Î∏î Ï≤òÎ¶¨
            if (partialTables) {
                partialTables.forEach(tableMatch => {
                    const tableHtml = convertPartialMarkdownTableToHTML(tableMatch);
                    if (tableHtml) {
                        formatted = formatted.replace(tableMatch, tableHtml);
                    }
                });
            }
            
            // ÌïúÍµ≠Ïñ¥ Í≥µÎ∞± Í∏∞Î∞ò ÌÖåÏù¥Î∏î Ï≤òÎ¶¨
            if (koreanTables) {
                koreanTables.forEach(tableMatch => {
                    const tableHtml = convertKoreanSpaceTableToHTML(tableMatch);
                    if (tableHtml) {
                        formatted = formatted.replace(tableMatch, tableHtml);
                    }
                });
            }
            
            // 5. ÏΩúÎ°†ÏúºÎ°ú Íµ¨Î∂ÑÎêú ÌÇ§-Í∞í Ïåç ÌÖåÏù¥Î∏î (Ïòà: "Ìï≠Î™©: Í∞í" ÌòïÌÉú)
            const keyValueRegex = /^([^:\n]+:\s*[^\n]+\n){2,}/gm;
            const keyValueTables = formatted.match(keyValueRegex);
            
            if (keyValueTables) {
                keyValueTables.forEach(tableMatch => {
                    const tableHtml = convertKeyValueToHTML(tableMatch);
                    if (tableHtml) {
                        formatted = formatted.replace(tableMatch, tableHtml);
                    }
                });
            }
            
            // ÍπÄÎ™ÖÏ†ï Í≥†Í∞ùÏùò Ïπ¥Îìú Î≥¥Ïú† Ïó¨Î∂ÄÏóê Îî∞Î•∏ Ïù¥ÎØ∏ÏßÄ Î∂ÑÎ•ò ÌëúÏãú
            formatted = formatted.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, altText, imagePath) => {
                // Aspose.WordsÎ°ú ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄÎßå Ï≤òÎ¶¨
                if (imagePath.startsWith('Aspose.Words.')) {
                    // ÍπÄÎ™ÖÏ†ï Í≥†Í∞ù Î≥¥Ïú† Ïπ¥Îìú ÌôïÏù∏ (Ïã§Ï†ú Ïù¥ÎØ∏ÏßÄ alt ÌÖçÏä§Ìä∏ÏôÄ Îß§Ïπ≠)
                    const userOwnedCards = ['Ïö∞Î¶¨Ïπ¥Îìú', 'ÌïòÎÇòÏπ¥Îìú', 'ÎÜçÌòëÏπ¥Îìú'];
                    const cardName = extractCardNameFromAlt(altText);
                    console.log('üîç Ïπ¥ÎìúÎ™Ö Ï∂îÏ∂ú:', altText, '‚Üí', cardName);
                    
                    const isOwnedCard = userOwnedCards.some(owned => {
                        // Îçî Ï†ïÌôïÌïú Îß§Ïπ≠ÏùÑ ÏúÑÌï¥ Îã§ÏñëÌïú Ìå®ÌÑ¥ ÌôïÏù∏
                        if (owned === 'Ïö∞Î¶¨Ïπ¥Îìú' && (altText.includes('Ïö∞Î¶¨') || cardName.includes('Ïö∞Î¶¨'))) return true;
                        if (owned === 'ÌïòÎÇòÏπ¥Îìú' && (altText.includes('ÌïòÎÇò') || cardName.includes('ÌïòÎÇò'))) return true;
                        if (owned === 'ÎÜçÌòëÏπ¥Îìú' && (altText.includes('NH') || altText.includes('ÎÜçÌòë') || cardName.includes('ÎÜçÌòë'))) return true;
                        return false;
                    });
                    
                    const cardStatus = isOwnedCard ? 
                        `<div style="background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-top: 5px;">
                            ‚úÖ Î≥¥Ïú† Ïπ¥Îìú
                        </div>` :
                        `<div style="background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-top: 5px;">
                            ‚≠ê Î∞úÍ∏â Ï∂îÏ≤ú Ïπ¥Îìú
                        </div>`;
                    
                    return `<div style="margin: 15px 0; text-align: center; border: ${isOwnedCard ? '2px solid #28a745' : '2px solid #ffc107'}; padding: 10px; border-radius: 12px;">
                        <img src="/images/${imagePath}" 
                             alt="${altText}" 
                             style="max-width: 200px; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                             onerror="console.error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®:', '/images/${imagePath}'); this.style.display='none'; this.nextElementSibling.style.display='block';" 
                             onload="console.log('Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏÑ±Í≥µ:', '/images/${imagePath}');" />
                        <div style="display: none; padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
                            ‚ùå Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®<br>
                            üì∑ ÌååÏùº: ${imagePath}<br>
                            üè∑Ô∏è ÏÑ§Î™Ö: ${altText}
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9em; color: #333;">
                            ${altText}
                        </div>
                        ${cardStatus}
                    </div>`;
                }
                return match; // Îã§Î•∏ Ïù¥ÎØ∏ÏßÄÎäî ÏõêÎ≥∏ Ïú†ÏßÄ
            });
            
            // Í∏∞Î≥∏ ÌÖçÏä§Ìä∏ Ìè¨Îß∑ÌåÖ
            formatted = formatted
                // ÌÖåÏù¥Î∏î Íµ¨Î∂ÑÏÑ† Ï†úÍ±∞ (ÎèÖÎ¶ΩÏ†ÅÏù∏ ÎùºÏù∏Ïùò ---, ===, ... Ìå®ÌÑ¥)
                .replace(/^[\s]*[-=.+_*~:]{3,}[\s]*$/gm, '')
                // Ïó∞ÏÜçÎêú Îπà Ï§Ñ Ï†ïÎ¶¨
                .replace(/\n\s*\n\s*\n/g, '\n\n')
                // ÏûòÎ™ªÎêú Î∞±Ïä¨ÎûòÏãú Ïù¥Ïä§ÏºÄÏù¥ÌîÑ ÏàòÏ†ï
                .replace(/\\(\d+)\./g, '$1.')
                // Î≥ºÎìú ÌÖçÏä§Ìä∏
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Ïù¥ÌÉ§Î¶≠ ÌÖçÏä§Ìä∏
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Ïà´Ïûê Î™©Î°ù Í∞úÏÑ† (Îã®Í≥ÑÎ≥Ñ Ï†àÏ∞® Í∞ïÏ°∞)
                .replace(/^\d+\)\s(.+)$/gm, '<div style="margin: 10px 0; padding: 12px 16px; background: #f0f8ff; border-left: 4px solid #2196F3; border-radius: 6px;"><strong style="color: #1976D2;">$&</strong></div>')
                .replace(/^\d+\.\s(.+)$/gm, '<div style="margin: 8px 0; padding: 10px 12px; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 4px;"><strong>$&</strong></div>')
                // Î∂àÎ¶ø Î™©Î°ù Í∞úÏÑ†
                .replace(/^[-‚Ä¢]\s(.+)$/gm, '<div style="margin: 5px 0; padding-left: 20px; color: #555;">‚Ä¢ $1</div>')
                // Ï§ëÏöî ÏÑπÏÖò Ìó§Îçî (** Î°ú ÎëòÎü¨Ïã∏Ïù∏ ÌÖçÏä§Ìä∏)
                .replace(/\*\*([^*]+)\*\*:/g, '<div style="margin: 15px 0 8px 0; font-weight: 700; font-size: 1.1em; color: #2c3e50; border-bottom: 2px solid #e9ecef; padding-bottom: 4px;">$1:</div>')
                // Ï§ÑÎ∞îÍøàÏùÑ <br>Î°ú Î≥ÄÌôò (ÌÖåÏù¥Î∏î Ï†úÏô∏)
                .replace(/\n/g, '<br>');
            
            // ÎßàÏßÄÎßâ Îã®Í≥Ñ: Î≥¥Ìò∏Îêú Ïù¥ÎØ∏ÏßÄ ÎßàÌÅ¨Îã§Ïö¥ÏùÑ HTMLÎ°ú Î≥ÄÌôòÌïòÏó¨ Î≥µÏõê
            imageProtectionMap.forEach((originalImage, placeholder) => {
                // ÎßàÌÅ¨Îã§Ïö¥ Ïù¥ÎØ∏ÏßÄÎ•º HTMLÎ°ú Î≥ÄÌôò
                const htmlImage = originalImage.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, 
                    '<img src="$2" alt="$1" style="max-width: 200px; height: auto; margin: 8px 0; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onerror="console.error(\'Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®:\', \'$2\'); this.style.display=\'none\';" onload="console.log(\'Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏÑ±Í≥µ:\', \'$2\');" />');
                formatted = formatted.replace(placeholder, htmlImage);
            });
            
            console.log('üîß formatText output:', formatted.substring(0, 500) + '...');
            return formatted;
        }
        
        // ÎßàÌÅ¨Îã§Ïö¥ ÌÖåÏù¥Î∏îÏùÑ HTMLÎ°ú Î≥ÄÌôò
        function convertMarkdownTableToHTML(tableText) {
            try {
                const lines = tableText.trim().split('\n').filter(line => line.trim());
                const tableRows = [];
                let headerProcessed = false;
                let maxColumns = 0;
                
                // Î®ºÏ†Ä ÏµúÎåÄ Ïó¥ ÏàòÎ•º Ï∞æÏùå
                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('|') && line.endsWith('|')) {
                        if (!line.match(/^\|[\s\-:]+\|$/)) {
                            const cells = line.slice(1, -1).split('|');
                            maxColumns = Math.max(maxColumns, cells.length);
                        }
                    }
                }
                
                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('|') && line.endsWith('|')) {
                        // Íµ¨Î∂ÑÏÑ† Í±¥ÎÑàÎõ∞Í∏∞ - Îçî Í∞ïÎ†•Ìïú Ìå®ÌÑ¥ (| ------ | ÌòïÌÉú Ï≤òÎ¶¨)
                        const cellsCheck = line.slice(1, -1).split('|');
                        const isAllSeparators = cellsCheck.every(cell => {
                            const trimmed = cell.trim();
                            // Îπà ÏÖÄÏù¥Í±∞ÎÇò Íµ¨Î∂ÑÏÑ† Î¨∏ÏûêÎì§Î°úÎßå Ïù¥Î§ÑÏßÑ ÏÖÄÏù∏ÏßÄ ÌôïÏù∏ (Îçî Í∞ïÌôîÎêú Ìå®ÌÑ¥)
                            return trimmed === '' || /^[-=:+_*~.\s]{2,}$/.test(trimmed) || /^-{2,}$/.test(trimmed);
                        });
                        
                        if (isAllSeparators) {
                            console.log('üîß Skipping table separator line:', line);
                            continue;
                        }
                        
                        // ÏÖÄ Ï∂îÏ∂ú Î∞è Îπà ÏÖÄ Ï≤òÎ¶¨
                        let cells = line.slice(1, -1).split('|').map(cell => {
                            const trimmed = cell.trim();
                            // Íµ¨Î∂ÑÏÑ†Îßå ÏûàÎäî ÏÖÄ Ï≤¥ÌÅ¨ (ÌïúÍ∏Ä ÌÖçÏä§Ìä∏ Î≥¥Ìò∏) - ------ Ìå®ÌÑ¥ Ï≤òÎ¶¨
                            if (trimmed.match(/^[-=.+_*~:\s]{2,}$/) && trimmed.length > 0) {
                                return '&nbsp;';
                            }
                            // ------ Í∞ôÏùÄ Íµ¨Î∂ÑÏÑ† Ìå®ÌÑ¥ Ï≤òÎ¶¨  
                            if (/^-{2,}$/.test(trimmed)) {
                                return '&nbsp;';
                            }
                            // Îπà ÏÖÄ Ï≤òÎ¶¨
                            if (!trimmed) {
                                return '&nbsp;';
                            }
                            return trimmed;
                        });
                        
                        // Ïó¥ Ïàò ÎßûÏ∂îÍ∏∞
                        while (cells.length < maxColumns) {
                            cells.push('&nbsp;');
                        }
                        
                        if (cells.length > 0) {
                            const tag = !headerProcessed ? 'th' : 'td';
                            const rowClass = !headerProcessed ? 'header-row' : '';
                            tableRows.push(`<tr class="${rowClass}">${cells.map(cell => `<${tag}>${cell === '&nbsp;' ? cell : escapeHtml(cell)}</${tag}>`).join('')}</tr>`);
                            if (!headerProcessed) headerProcessed = true;
                        }
                    }
                }
                
                if (tableRows.length > 0) {
                    return createStyledTable(tableRows.join(''));
                }
            } catch (e) {
                console.error('ÎßàÌÅ¨Îã§Ïö¥ ÌÖåÏù¥Î∏î Î≥ÄÌôò Ïò§Î•ò:', e);
            }
            return null;
        }
        
        // ÌÖçÏä§Ìä∏ ÌÖåÏù¥Î∏îÏùÑ HTMLÎ°ú Î≥ÄÌôò (ÌÉ≠ Íµ¨Î∂Ñ)
        function convertTextTableToHTML(tableText) {
            const lines = tableText.trim().split('\n').filter(line => line.trim());
            if (lines.length < 2) return null;
            
            const tableRows = [];
            let isFirstRow = true;
            
            for (let line of lines) {
                const cells = line.split('\t').map(cell => cell.trim());
                if (cells.length > 1) {
                    const tag = isFirstRow ? 'th' : 'td';
                    const rowClass = isFirstRow ? 'header-row' : '';
                    tableRows.push(`<tr class="${rowClass}">${cells.map(cell => `<${tag}>${cell || '&nbsp;'}</${tag}>`).join('')}</tr>`);
                    isFirstRow = false;
                }
            }
            
            if (tableRows.length > 0) {
                return createStyledTable(tableRows.join(''));
            }
            return null;
        }
        
        // ÌÇ§-Í∞í ÏåçÏùÑ HTML ÌÖåÏù¥Î∏îÎ°ú Î≥ÄÌôò
        function convertKeyValueToHTML(kvText) {
            const lines = kvText.trim().split('\n').filter(line => line.trim());
            if (lines.length < 2) return null;
            
            const tableRows = [];
            
            for (let line of lines) {
                const colonIndex = line.indexOf(':');
                if (colonIndex > 0) {
                    const key = line.substring(0, colonIndex).trim();
                    const value = line.substring(colonIndex + 1).trim();
                    tableRows.push(`<tr><td class="key-cell"><strong>${key}</strong></td><td class="value-cell">${value}</td></tr>`);
                }
            }
            
            if (tableRows.length > 0) {
                return createStyledTable(tableRows.join(''), true);
            }
            return null;
        }
        
        // ÌïúÍµ≠Ïñ¥ Í≥µÎ∞± Í∏∞Î∞ò ÌÖåÏù¥Î∏îÏùÑ HTMLÎ°ú Î≥ÄÌôò
        function convertKoreanSpaceTableToHTML(tableText) {
            try {
                const lines = tableText.trim().split('\n').filter(line => line.trim());
                const tableRows = [];
                
                console.log('üîß Processing Korean space table:', tableText.substring(0, 100));
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    // 4Í∞ú Ïù¥ÏÉÅÏùò Ïó∞ÏÜçÎêú Í≥µÎ∞±ÏúºÎ°ú Ïª¨Îüº Íµ¨Î∂Ñ
                    const cells = line.split(/\s{4,}/).map(cell => cell.trim()).filter(cell => cell.length > 0);
                    
                    if (cells.length >= 2) {
                        const tag = i === 0 ? 'th' : 'td';
                        const rowClass = i === 0 ? 'header-row' : '';
                        tableRows.push(`<tr class="${rowClass}">${cells.map(cell => `<${tag}>${escapeHtml(cell)}</${tag}>`).join('')}</tr>`);
                    }
                }
                
                if (tableRows.length > 0) {
                    return createStyledTable(tableRows.join(''));
                }
                
            } catch (e) {
                console.error('ÌïúÍµ≠Ïñ¥ Í≥µÎ∞± ÌÖåÏù¥Î∏î Î≥ÄÌôò Ïò§Î•ò:', e);
            }
            return null;
        }
        
        // Î∂ÄÎ∂Ñ ÎßàÌÅ¨Îã§Ïö¥ ÌÖåÏù¥Î∏îÏùÑ HTMLÎ°ú Î≥ÄÌôò (| ÏûàÏßÄÎßå ÏôÑÏ†ÑÌïòÏßÄ ÏïäÏùÄ ÌÖåÏù¥Î∏î)
        function convertPartialMarkdownTableToHTML(tableText) {
            try {
                const line = tableText.trim();
                console.log('üîß Processing partial markdown table:', line);
                
                // | Í∏∞Ìò∏Î°ú Î∂ÑÌï†
                const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell.length > 0);
                
                if (cells.length >= 2) {
                    // Îã®Ïùº Ìñâ ÌÖåÏù¥Î∏îÎ°ú Ï≤òÎ¶¨
                    const tableRow = `<tr>${cells.map(cell => `<td>${escapeHtml(cell)}</td>`).join('')}</tr>`;
                    return createStyledTable(tableRow);
                }
                
            } catch (e) {
                console.error('Î∂ÄÎ∂Ñ ÎßàÌÅ¨Îã§Ïö¥ ÌÖåÏù¥Î∏î Î≥ÄÌôò Ïò§Î•ò:', e);
            }
            return null;
        }
        
        // Ïä§ÌÉÄÏùºÏù¥ Ï†ÅÏö©Îêú ÌÖåÏù¥Î∏î ÏÉùÏÑ±
        function createStyledTable(tableBody, isKeyValue = false) {
            const uniqueId = 'table_' + Math.random().toString(36).substr(2, 9);
            console.log('üîß Creating table with ID:', uniqueId);
            console.log('üîß Table body:', tableBody);
            
            // CSSÎ•º ÎèôÏ†ÅÏúºÎ°ú Ìó§ÎìúÏóê Ï∂îÍ∞Ä
            const style = document.createElement('style');
            const keyValueStyle = isKeyValue ? `
                #${uniqueId} .key-cell { 
                    background-color: #f8f9fa !important; 
                    font-weight: bold !important; 
                    width: 30% !important; 
                    color: #495057 !important;
                }
                #${uniqueId} .value-cell { 
                    background-color: #ffffff !important; 
                }` : '';
                
            style.textContent = `
                #${uniqueId} {
                    width: 100% !important;
                    border-collapse: collapse !important;
                    font-size: 0.85rem !important;
                    border: 2px solid #dee2e6 !important;
                    border-radius: 8px !important;
                    overflow: hidden !important;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
                    table-layout: auto !important;
                    margin: 0 !important;
                }
                
                #${uniqueId} td, #${uniqueId} th { 
                    border: 1px solid #dee2e6 !important; 
                    padding: 8px 6px !important; 
                    text-align: left !important; 
                    vertical-align: top !important;
                    word-wrap: break-word !important;
                    word-break: break-word !important;
                    max-width: none !important;
                    white-space: normal !important;
                }
                
                #${uniqueId} th, #${uniqueId} .header-row td { 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                    color: white !important; 
                    font-weight: bold !important; 
                    text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
                }
                
                #${uniqueId} tr:nth-child(even):not(.header-row) {
                    background-color: #f8f9fa !important;
                }
                
                #${uniqueId} tr:nth-child(odd):not(.header-row) {
                    background-color: #ffffff !important;
                }
                
                #${uniqueId} tr:hover:not(.header-row) {
                    background-color: #e3f2fd !important;
                    transition: background-color 0.2s ease !important;
                }
                
                ${keyValueStyle}
            `;
            
            // Ìó§ÎìúÏóê Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä
            document.head.appendChild(style);
            
            const finalHtml = `
                <div style="margin: 15px 0; overflow-x: auto; width: 100%; clear: both;">
                    <table id="${uniqueId}">
                        ${tableBody}
                    </table>
                </div>
            `;
            
            console.log('üîß Final table HTML:', finalHtml.substring(0, 300) + '...');
            return finalHtml;
        }

        // Ïã§ÏãúÍ∞Ñ Î©îÏãúÏßÄ Ï†ÑÏÜ°
        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Ï†ïÏùò
        window.sendMessage = async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Ïù¥Ï†Ñ ÏûëÏóÖÏù¥ ÏßÑÌñâ Ï§ëÏù¥Î©¥ Í≤ΩÍ≥† Î©îÏãúÏßÄ
            const isProcessing = document.querySelector('.process-card.loading, .process-card.waiting');
            if (isProcessing) {
                const userConfirm = confirm('Ïù¥Ï†Ñ ÏûëÏóÖÏù¥ ÏïÑÏßÅ ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§. \nÏÉàÎ°úÏö¥ ÏßàÎ¨∏ÏùÑ ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Ïù¥Ï†Ñ ÏûëÏóÖÏùÄ Ï∑®ÏÜåÎê©ÎãàÎã§)');
                if (!userConfirm) {
                    return;
                }
                
                // Ïù¥Ï†Ñ ÏûëÏóÖ Ï∑®ÏÜå
                console.log('üìã Ïù¥Ï†Ñ ÏûëÏóÖ Ï∑®ÏÜå Î∞è ÏÉàÎ°úÏö¥ ÏßàÎ¨∏ ÏãúÏûë');
                // Î™®Îì† ÌÉÄÏù¥Î®∏ Ï§ëÏßÄ
                Object.keys(timerIntervals).forEach(timerId => {
                    clearInterval(timerIntervals[timerId]);
                });
                timerIntervals = {};
            }
            
            currentQuery = message;
            resultCount = 0;
            similarityData = {};
            
            // ÏßàÎ¨∏ ÌëúÏãú
            displayUserQuestion(message);
            
            input.value = '';
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            
            // DOM ÏóÖÎç∞Ïù¥Ìä∏Í∞Ä ÏôÑÎ£åÎêòÎèÑÎ°ù Í∏∞Îã§Î¶º (Ïπ¥ÎìúÎì§Ïù¥ ÌôïÏã§Ìûà Î≥¥Ïù¥ÎèÑÎ°ù)
            await new Promise(resolve => setTimeout(resolve, 100));
            await new Promise(resolve => requestAnimationFrame(resolve));
            
            try {
                const summarizeCheckbox = document.getElementById('summarizeCheck');
                const summarize = summarizeCheckbox ? summarizeCheckbox.checked : false;
                
                // Ïã§ÏãúÍ∞Ñ Ïä§Ìä∏Î¶¨Î∞ç Î©ÄÌã∞ Î≤§ÏπòÎßàÌÇπÏúºÎ°ú 4Í∞ú ÌîÑÎ°úÏÑ∏Ïä§ Ï≤òÎ¶¨
                executeAllModesStream(message, summarize);
                
            } catch (error) {
                console.error('Ï†ÑÏ≤¥ Ïò§Î•ò:', error);
                displayGlobalError(`Ï†ÑÏ≤¥ Ïò§Î•ò: ${error.message}`);
            } finally {
                // 35Ï¥à ÌõÑ ÏûÖÎ†• Îã§Ïãú ÌôúÏÑ±Ìôî (ÎπÑÏÉÅ ÏÉÅÌô©Ïö©)
                setTimeout(() => {
                    if (input) input.disabled = false;
                    const btn = document.getElementById('sendBtn');
                    if (btn) btn.disabled = false;
                    console.log('ÌÉÄÏûÑÏïÑÏõÉÏúºÎ°ú Ïù∏Ìïú ÏûÖÎ†• ÌôúÏÑ±Ìôî');
                }, 35000);
            }
        };
        
        // Í∞úÎ≥Ñ Î™®Îìú Ïã§Ìñâ (Í∞úÎ≥Ñ API ÏÇ¨Ïö©)
        async function executeMode(mode, query, summarize, index) {
            try {
                console.log(`üöÄ Executing mode: ${mode} with query: "${query}"`);
                
                // Î™®ÎìúÎ≥Ñ API ÏóîÎìúÌè¨Ïù∏Ìä∏ Í≤∞Ï†ï
                let endpoint;
                if (mode === 'chatgpt-basic') {
                    endpoint = '/api/chat/chatgpt-basic';
                } else if (mode === 'chatgpt-custom') {
                    endpoint = '/api/chat/chatgpt-custom';
                } else if (mode === 'local-basic') {
                    endpoint = '/api/chat/local-basic';
                } else if (mode === 'local-custom') {
                    endpoint = '/api/chat/local-custom';
                } else {
                    displayError(mode, 'Ïïå Ïàò ÏóÜÎäî Î™®ÎìúÏûÖÎãàÎã§.', index);
                    return;
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: query
                    })
                });
                
                console.log(`üì° Response status for ${mode}: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log(`üìÑ Result for ${mode}:`, result);
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // ÏÉàÎ°úÏö¥ API ÌòïÏãùÏóê ÎßûÏ∂∞ Í≤∞Í≥º Î≥ÄÌôò
                const formattedResult = {
                    type: 'single',
                    success: result.success,
                    answer: result.answer,
                    similarity_info: result.similarity_info,
                    total_time: result.total_time,
                    process_name: result.process_name
                };
                
                // Ï¶âÏãú ÌëúÏãú (ÏôÑÎ£åÎêú Í≤ÉÎ∂ÄÌÑ∞ Î∞îÎ°ú ÌëúÏãú)
                displayResult(formattedResult, mode, index);
                
            } catch (error) {
                console.error(`‚ùå Error executing ${mode}:`, error);
                displayError(mode, error.message, index);
            }
        }
        
        // Ïä§Ìä∏Î¶¨Î∞ç APIÎ°ú Ïã§ÏãúÍ∞Ñ Ï≤òÎ¶¨ (ÎπÑÌôúÏÑ±ÌôîÎê® - ÏàúÏ∞® Î≤§ÏπòÎßàÌÇπÏúºÎ°ú ÎåÄÏ≤¥)
        async function executeStreamingQuery(query, summarize) {
            console.error(`‚ùå [STREAMING_QUERY] Ïù¥ Ìï®ÏàòÎäî ÎπÑÌôúÏÑ±ÌôîÎêòÏñ¥Ïïº Ìï©ÎãàÎã§! ÏàúÏ∞® Î≤§ÏπòÎßàÌÇπÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.`);
            console.error(`‚ùå executeStreamingQuery Ìò∏Ï∂úÎê®, executeAllModesÎ°ú ÎåÄÏ≤¥`);
            
            // Ïã§ÏãúÍ∞Ñ Ïä§Ìä∏Î¶¨Î∞çÏúºÎ°ú ÎåÄÏ≤¥ Ïã§Ìñâ
            return executeAllModesStream(query, summarize);
            
            // ÏïÑÎûòÎäî ÎπÑÌôúÏÑ±ÌôîÎêú Í∏∞Ï°¥ ÏΩîÎìú
            try {
                console.log(`üöÄ Starting streaming query: "${query}"`);
                
                // ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï (60Ï¥àÎ°ú Ï¶ùÍ∞Ä)
                window.streamTimeoutId = setTimeout(() => {
                    console.error('‚è±Ô∏è Timeout: No process_complete events received within 60 seconds');
                    // Î™®Îì† Î°úÎî© Ï§ëÏù∏ Ïπ¥ÎìúÏóê ÌÉÄÏûÑÏïÑÏõÉ ÏóêÎü¨ ÌëúÏãú
                    const cardsGroup = document.getElementById(window.currentCardsGroupId);
                    if (cardsGroup) {
                        const loadingCards = cardsGroup.querySelectorAll('.process-card.loading');
                        loadingCards.forEach((card) => {
                            const mode = card.id.split('-')[1] + '-' + card.id.split('-')[2];
                            displayError(mode, 'ÏùëÎãµ ÏãúÍ∞Ñ Ï¥àÍ≥º (60Ï¥à). Î∞±ÏóîÎìú ÌîÑÎ°úÏÑ∏Ïä§ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 0);
                        });
                    }
                }, 60000);
                
                console.log('üîó Making request to /api/chat/stream...');
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: query,
                        use_memory: false,
                        llm_model: 'gpt-4o-mini',
                        summarize: summarize
                    })
                });
                
                console.log(`üì° Response status: ${response.status} ${response.statusText}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}${errorText ? ' - ' + errorText : ''}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                console.log('üéâ Stream completed');
                                if (window.streamTimeoutId) {
                                    clearTimeout(window.streamTimeoutId);
                                }
                                continue;
                            }
                            
                            try {
                                const event = JSON.parse(data);
                                console.log('üî∏ Raw event data:', data);
                                console.log('üîπ Parsed event:', event);
                                handleStreamEvent(event);
                            } catch (e) {
                                console.error('Failed to parse event:', e, 'Data:', data);
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Streaming error:', error);
                // Î™®Îì† ÌîÑÎ°úÏÑ∏Ïä§Ïóê Ïò§Î•ò ÌëúÏãú
                displayGlobalError(error.message);
            }
        }
        
        // Ïä§Ìä∏Î¶º Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
        function handleStreamEvent(event) {
            console.log('üì• Stream event:', event);
            console.log('Event type:', event.type);
            console.log('Process ID:', event.process_id);
            console.log('Status:', event.status);
            
            // process_start Ïù¥Î≤§Ìä∏Îäî Î¨¥Ïãú (Ïù¥ÎØ∏ Ïπ¥ÎìúÍ∞Ä ÌëúÏãúÎêòÏñ¥ ÏûàÏùå)
            if (event.type === 'all_processes_start' || event.type === 'process_start') {
                console.log('‚úÖ Process start event - already showing loading cards');
                return;
            }
            
            if (event.type === 'process_complete') {
                console.log('‚úÖ Process complete event received');
                const mode = getProcessMode(event.process_id);
                
                // ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM ÌîÑÎ°úÏÑ∏Ïä§ÎèÑ Ï†ïÏÉÅ Ï≤òÎ¶¨ÌïòÎèÑÎ°ù Î≥ÄÍ≤Ω
                console.log(`üì® ÌîÑÎ°úÏÑ∏Ïä§ ${event.process_id} (${mode}) Ïù¥Î≤§Ìä∏:`, event.type);
                
                // ChatGPT ÌîÑÎ°úÏÑ∏Ïä§Îßå Ï†ïÏÉÅ Ï≤òÎ¶¨
                const result = {
                    success: event.status === 'success',
                    answer: event.answer || (event.rank_answers && event.rank_answers[0] ? event.rank_answers[0].answer : 'ÎãµÎ≥Ä ÏóÜÏùå'),
                    similarity_info: event.similarity_info || [],
                    total_time: event.total_time || 0,
                    process_name: event.process_name,
                    chunking_type: event.chunking_type  // chunking_type Ï∂îÍ∞Ä
                };
                console.log('Calling displayResult with:', result, mode);
                displayResult(result, mode, getCardIndex(event.process_id));
                
            } else if (event.type === 'process_error') {
                console.log('‚ùå Process error event received');
                console.log('Error details:', event);
                // ÌîÑÎ°úÏÑ∏Ïä§ Ïò§Î•ò
                const mode = getProcessMode(event.process_id);
                console.log('Error mode:', mode, 'Message:', event.message || event.error);
                displayError(mode, event.message || event.error || 'Unknown error', getCardIndex(event.process_id));
                
                // ÌÉÄÏûÑÏïÑÏõÉ ÌÅ¥Î¶¨Ïñ¥ (ÏóêÎü¨ÎèÑ ÏôÑÎ£åÎ°ú Í∞ÑÏ£º)
                if (window.streamTimeoutId) {
                    clearTimeout(window.streamTimeoutId);
                }
            } else {
                console.log('‚ö†Ô∏è Unknown event type:', event.type);
                // ÎîîÎ≤ÑÍπÖÏùÑ ÏúÑÌï¥ Î™®Îì† Ïù¥Î≤§Ìä∏ ÎÇ¥Ïö© ÌëúÏãú
                console.log('Full event:', JSON.stringify(event, null, 2));
            }
        }
        
        // ÌîÑÎ°úÏÑ∏Ïä§ IDÎ°ú Î™®Îìú Í≤∞Ï†ï Î∞è Ïπ¥Îìú Ïù∏Îç±Ïä§ Í≥ÑÏÇ∞
        function getProcessMode(processId) {
            const modeMap = {
                1: 'chatgpt-basic',   // Î∞±ÏóîÎìú ÌîÑÎ°úÏÑ∏Ïä§ 1 ‚Üí ÌîÑÎ°†Ìä∏ÏóîÎìú Ïπ¥Îìú 2
                2: 'chatgpt-custom',  // Î∞±ÏóîÎìú ÌîÑÎ°úÏÑ∏Ïä§ 2 ‚Üí ÌîÑÎ°†Ìä∏ÏóîÎìú Ïπ¥Îìú 3  
                3: 'local-basic',     // Î∞±ÏóîÎìú ÌîÑÎ°úÏÑ∏Ïä§ 3 ‚Üí ÌîÑÎ°†Ìä∏ÏóîÎìú Ïπ¥Îìú 0
                4: 'local-custom'     // Î∞±ÏóîÎìú ÌîÑÎ°úÏÑ∏Ïä§ 4 ‚Üí ÌîÑÎ°†Ìä∏ÏóîÎìú Ïπ¥Îìú 1
            };
            return modeMap[processId] || 'unknown';
        }
        
        // ÌîÑÎ°úÏÑ∏Ïä§ IDÎ°ú Ïπ¥Îìú Ïù∏Îç±Ïä§ Í≥ÑÏÇ∞
        function getCardIndex(processId) {
            const indexMap = {
                3: 0,  // ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + s3Í∏∞Î≥∏ ‚Üí Ïπ¥Îìú 0  
                4: 1   // ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + s3-chunking ‚Üí Ïπ¥Îìú 1
            };
            return indexMap[processId] || 0;
        }
        
        // Îã®Ïùº ÏÇ¨Ïö©Ïûê ÏßàÎ¨∏ ÌëúÏãú
        function displaySingleUserQuestion(question) {
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) return;
            
            // ÏÉàÎ°úÏö¥ QA Í∑∏Î£π ÏÉùÏÑ±
            const qaGroup = document.createElement('div');
            qaGroup.className = 'qa-group';
            
            // ÏÇ¨Ïö©Ïûê ÏßàÎ¨∏ Ï∂îÍ∞Ä (Ïò§Î•∏Ï™Ω Ï†ïÎ†¨)
            const userQuestion = document.createElement('div');
            userQuestion.className = 'user-question';
            const summarizeCheckbox = document.getElementById('summarizeCheck');
            const isSummarizeMode = summarizeCheckbox ? summarizeCheckbox.checked : false;
            
            userQuestion.innerHTML = `
                <div class="user-question-content">
                    <div style="margin-bottom: 4px;"><strong>me:</strong> ${question}</div>
                    <div style="font-size: 0.75rem; opacity: 0.9;">
                        ${isSummarizeMode ? 
                            '<span style="background: rgba(40, 167, 69, 0.2); color: #28a745; padding: 2px 6px; border-radius: 3px;">üìù ÏöîÏïΩÎ™®Îìú ON</span>' : 
                            '<span style="background: rgba(0, 123, 255, 0.2); color: #007bff; padding: 2px 6px; border-radius: 3px;">üìñ ÏùºÎ∞òÎ™®Îìú</span>'
                        }
                        <span style="margin-left: 8px; opacity: 0.7;">${new Date().toLocaleTimeString()}</span>
                    </div>
                </div>
            `;
            qaGroup.appendChild(userQuestion);
            
            // AI ÏùëÎãµ Î°úÎî© Ïπ¥Îìú
            const aiResponse = document.createElement('div');
            aiResponse.className = 'ai-response loading';
            aiResponse.id = 'single-response';
            aiResponse.innerHTML = `
                <div class="ai-response-header">
                    ü§ñ DEOTIS RAG Agent
                    <span class="model-badge">ChatGPT-4o</span>
                </div>
                <div class="ai-response-content">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">AIÍ∞Ä Î¨∏ÏÑúÎ•º Í≤ÄÏÉâÌïòÍ≥† ÎãµÎ≥ÄÏùÑ ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...</div>
                    </div>
                </div>
            `;
            
            qaGroup.appendChild(aiResponse);
            chatHistory.appendChild(qaGroup);
            
            // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú
            scrollToBottom();
        }
        
        // Ïä§Ìä∏Î¶¨Î∞ç Î©ÄÌã∞ Î≤§ÏπòÎßàÌÇπ
        async function executeAllModesStream(query, summarize) {
            try {
                console.log(`üöÄ Streaming all modes: "${query}"`);
                
                const requestBody = JSON.stringify({
                    query: query,
                    summarize: summarize,
                    local_model: document.getElementById('localModelSelect').value
                });
                
                const response = await fetch('/api/chat/vllm-dual-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: requestBody
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr === '[DONE]') {
                                console.log('üì° Ïä§Ìä∏Î¶¨Î∞ç ÏôÑÎ£å Ïã†Ìò∏ Î∞õÏùå');
                                continue;
                            }
                            try {
                                const data = JSON.parse(dataStr);
                                handleStreamEvent(data);
                            } catch (e) {
                                console.error('Stream parsing error:', e);
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Streaming error:', error);
                displayGlobalError(`Ïä§Ìä∏Î¶¨Î∞ç Ïò§Î•ò: ${error.message}`);
            }
        }
        
        function handleStreamEvent(data) {
            console.log('üì¶ Stream event:', data);
            
            switch (data.type) {
                case 'phase_start':
                    console.log(`üéØ Phase ${data.phase}:`, data.modes);
                    break;
                    
                case 'process_complete':
                    console.log(`üìä Process ${data.process_id} (${data.process_name}) ÏôÑÎ£å`);
                    const mode = getProcessMode(data.process_id);
                    const result = {
                        success: data.status === 'success',
                        answer: data.answer || 'ÎãµÎ≥Ä ÏóÜÏùå',
                        similarity_info: data.similarity_info || [],
                        total_time: data.total_time || 0,
                        process_name: data.process_name,
                        chunking_type: data.chunking_type
                    };
                    console.log('üìã Calling displayResult with:', result, mode);
                    displayResult(result, mode, getCardIndex(data.process_id));
                    break;
                    
                case 'result':
                    console.log(`üìä ${data.mode} ÏôÑÎ£å`);
                    const cardIndex = getCardIndexByMode(data.mode);
                    displayResult(data.result.result, data.mode, cardIndex);
                    break;
                    
                case 'complete':
                case 'all_complete':
                    console.log('üéâ Î™®Îì† Î™®Îìú ÏôÑÎ£å');
                    setTimeout(() => {
                        const input = document.getElementById('messageInput');
                        const btn = document.getElementById('sendBtn');
                        if (input) input.disabled = false;
                        if (btn) btn.disabled = false;
                    }, 500);
                    break;
                    
                case 'error':
                    displayGlobalError(data.message);
                    break;
            }
        }
        
        function getCardIndexByMode(mode) {
            const modeToCardIndex = {
                'local-basic': 0,
                'local-custom': 1,
                'chatgpt-basic': 2, 
                'chatgpt-custom': 3
            };
            return modeToCardIndex[mode] || 0;
        }
        
        // Í∏∞Ï°¥ Î∞∞Ïπò Î∞©Ïãù (Î∞±ÏóÖ)
        async function executeAllModes(query, summarize) {
            try {
                console.log(`\ud83d\ude80 Executing all modes with query: "${query}"`);
                
                // Ïä§Ìä∏Î¶¨Î∞ç API Ìò∏Ï∂úÎ°ú Î≥ÄÍ≤Ω
                const response = await fetch('/api/chat/vllm-dual-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify({
                        query: query,
                        summarize: summarize,
                        local_model: document.getElementById('localModelSelect').value
                    })
                });
                
                console.log(`\ud83d\udce1 Multi-query response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`\ud83d\udcc4 Multi-query result:`, data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Í∞Å Î™®ÎìúÏóê ÎåÄÌïú Í≤∞Í≥º Ï≤òÎ¶¨
                if (data.results && Array.isArray(data.results)) {
                    data.results.forEach((modeResult, index) => {
                        const mode = modeResult.mode;
                        const result = modeResult.result;
                        
                        console.log(`\ud83d\udd04 Processing result for ${mode}:`, result);
                        console.log(`[MODE DEBUG] Success: ${modeResult.success}, Error: ${modeResult.error}`);
                        
                        // Í≤∞Í≥º ÌëúÏãú
                        displayResult(result, mode, index);
                    });
                    
                    // ÏûÖÎ†• Îã§Ïãú ÌôúÏÑ±Ìôî
                    setTimeout(() => {
                        const input = document.getElementById('messageInput');
                        const btn = document.getElementById('sendBtn');
                        if (input) input.disabled = false;
                        if (btn) btn.disabled = false;
                        console.log('Î™®Îì† Í≤∞Í≥º Ï≤òÎ¶¨ ÏôÑÎ£å - ÏûÖÎ†• ÌôúÏÑ±Ìôî');
                    }, 1000);
                } else {
                    throw new Error('ÎπÑÏñ¥ÏûàÏßÄ ÏïäÍ±∞ÎÇò ÏûòÎ™ªÎêú Í≤∞Í≥º ÌòïÏãù');
                }
                
            } catch (error) {
                console.error('Multi-query error:', error);
                displayGlobalError(`\ubaa8Îì† Î™®Îìú Ïã§Ìñâ Ï§ë Ïò§Î•ò: ${error.message}`);
            }
        }
        
        // Î™®Îìú ÏÑ§Ï†ï Í∞ÄÏ†∏Ïò§Í∏∞ (ÌÜµÌï©)
        function getModeConfig(mode) {
            const modeConfigs = {
                'local-basic': { 
                    title: 'ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + s3Í∏∞Î≥∏', 
                    type: 'local',
                    priority: 3,
                    description: 's3Ìè¥Îçî Î¨∏ÏÑú (Ollama LLaMA)'
                },
                'local-custom': { 
                    title: 'ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + s3-chunking', 
                    type: 'local',
                    priority: 4,
                    description: 's3-chunkingÌè¥Îçî Î¨∏ÏÑú (Ollama+Ìñ•ÏÉÅ)'
                }
            };
            return modeConfigs[mode] || { title: mode, type: 'unknown', priority: 0, description: '' };
        }

        // Î°úÎî© Ïπ¥Îìú Í∞ÄÏ†∏Ïò§Í∏∞
        function getLoadingCard(mode, index) {
            return document.getElementById(`loading-${mode}`);
        }

        // ÏÇ¨Ïö©Ïûê ÏßàÎ¨∏Í≥º 4Í∞ú ÌîÑÎ°úÏÑ∏Ïä§ Ïπ¥Îìú Í∑∏Î£π ÏÉùÏÑ±
        function displayUserQuestion(question) {
            const chatHistory = document.getElementById('chatHistory');
            console.log('üîç displayUserQuestion Ìò∏Ï∂ú, chatHistory:', chatHistory);
            
            if (!chatHistory) {
                console.error('‚ùå chatHistory ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                return;
            }
            
            // ÏÉàÎ°úÏö¥ QA Í∑∏Î£π ÏÉùÏÑ±
            const qaGroup = document.createElement('div');
            qaGroup.className = 'qa-group';
            console.log('‚úÖ QA Í∑∏Î£π ÏÉùÏÑ±:', qaGroup);
            
            // ÏÇ¨Ïö©Ïûê ÏßàÎ¨∏ Ï∂îÍ∞Ä (Ïò§Î•∏Ï™Ω Ï†ïÎ†¨)
            const userQuestion = document.createElement('div');
            userQuestion.className = 'user-question';
            const summarizeCheckbox = document.getElementById('summarizeCheck');
            const isSummarizeMode = summarizeCheckbox ? summarizeCheckbox.checked : false;
            
            userQuestion.innerHTML = `
                <div class="user-question-content">
                    <div style="margin-bottom: 4px;"><strong>me:</strong> ${question}</div>
                    <div style="font-size: 0.75rem; opacity: 0.9;">
                        ${isSummarizeMode ? 
                            '<span style="background: rgba(40, 167, 69, 0.2); color: #28a745; padding: 2px 6px; border-radius: 3px;">üìù ÏöîÏïΩÎ™®Îìú ON</span>' : 
                            '<span style="background: rgba(0, 123, 255, 0.2); color: #007bff; padding: 2px 6px; border-radius: 3px;">üìñ ÏùºÎ∞òÎ™®Îìú</span>'
                        }
                        <span style="margin-left: 8px; opacity: 0.7;">${new Date().toLocaleTimeString()}</span>
                    </div>
                </div>
            `;
            qaGroup.appendChild(userQuestion);
            
            // 4Í∞ú ÌîÑÎ°úÏÑ∏Ïä§ Ïπ¥Îìú Í∑∏Î£π ÏÉùÏÑ± (Í∞ÄÎ°ú 1Ï§Ñ)
            const processCardsGroup = document.createElement('div');
            processCardsGroup.className = 'process-cards-group';
            processCardsGroup.id = `cards-group-${Date.now()}`; // Í≥†Ïú† ID
            
            const groupTimestamp = Date.now(); // Í∑∏Î£πÎ≥ÑÎ°ú ÎèôÏùºÌïú ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏÇ¨Ïö©
            // ÏÇ¨Ïö©Ïûê ÏöîÏ≤≠ ÏàúÏÑú: üè†‚Üíüîß
            const allProcesses = [
                {key: 'local-basic', name: 'ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + s3Í∏∞Î≥∏', desc: 'Í∏∞Î≥∏Ï≤≠ÌÇπÏ†ÑÎûµ(1500Ïûê/250Ï§ëÏ≤©)', icon: 'üè†', phase: 1, order: 1},
                {key: 'local-custom', name: 'ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + s3-chunking', desc: 'Ïª§Ïä§ÌÖÄ Ï≤≠ÌÇπÏ†ÑÎûµ(Ìñ•ÏÉÅÎêú ÏßÄÏãù)', icon: 'üîß', phase: 2, order: 2}
            ];
            
            const phase1Processes = allProcesses.filter(p => p.phase === 1);
            const phase2Processes = allProcesses.filter(p => p.phase === 2);
            
            // ÏàúÏÑúÎåÄÎ°ú Ïπ¥Îìú ÏÉùÏÑ±
            allProcesses.forEach(process => {
                const processCard = document.createElement('div');
                const isPhase1 = process.phase === 1;
                
                processCard.className = isPhase1 ? 'process-card loading' : 'process-card waiting';
                processCard.id = `card-${process.key}-${groupTimestamp}`;
                
                console.log(`üîß [PHASE ${process.phase}] Ïπ¥Îìú ÏÉùÏÑ±: ${process.key}, ID: ${processCard.id}`);
                
                if (isPhase1) {
                    // Phase 1 Ïπ¥Îìú: Ï¶âÏãú Î°úÎî© ÏãúÏûë
                    processCard.innerHTML = `
                        <div class="process-card-header">
                            ${process.icon} ${process.name}
                        </div>
                        <div class="process-card-body loading">
                            <div class="loading-container">
                                <div class="process-loading-spinner"></div>
                                <div class="loading-progress" style="margin-top: 15px; font-weight: 500; color: #495057;">
                                    ‚è≥ AIÍ∞Ä Î¨∏ÏÑúÎ•º Í≤ÄÏÉâÏ§ëÏûÖÎãàÎã§...
                                </div>
                                <div class="loading-timer" id="timer-${process.key}-${groupTimestamp}" style="color: #6c757d; font-size: 0.85rem; margin-top: 8px;">0Ï¥à Í≤ΩÍ≥º</div>
                                <div class="loading-dots" style="margin-top: 10px; color: #667eea;">
                                    <span>‚óè</span><span>‚óè</span><span>‚óè</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Phase 2 Ïπ¥Îìú: ÎåÄÍ∏∞ Ï§ë
                    processCard.innerHTML = `
                        <div class="process-card-header">
                            ${process.icon} ${process.name}
                        </div>
                        <div class="process-card-body waiting">
                            <div class="waiting-container">
                                <div class="waiting-icon" style="font-size: 2rem; color: #ffa500; text-align: center;">‚è≥</div>
                                <div class="waiting-message" style="margin-top: 15px; font-weight: 500; color: #495057; text-align: center;">
                                    Ïù¥Ï†Ñ ÏûëÏóÖ Ï¢ÖÎ£å ÎåÄÍ∏∞Ï§ë...
                                </div>
                                <div class="waiting-timer" id="timer-${process.key}-${groupTimestamp}" style="color: #6c757d; font-size: 0.85rem; margin-top: 8px; text-align: center;">ÎåÄÍ∏∞ Ï§ë</div>
                            </div>
                        </div>
                    `;
                }
                
                processCardsGroup.appendChild(processCard);
                console.log(`‚úÖ Ïπ¥Îìú Ï∂îÍ∞ÄÎê®: ${process.order}Î≤à ${process.key}`);
            });
            
            // Phase 1 Ïπ¥ÎìúÎì§Ïùò ÌÉÄÏù¥Î®∏ ÏãúÏûë
            phase1Processes.forEach(process => {
                console.log(`‚è±Ô∏è [PHASE 1] ÌÉÄÏù¥Î®∏ ÏãúÏûë: ${process.key}`);
                startProcessTimer(process.key, groupTimestamp);
            });
            
            qaGroup.appendChild(processCardsGroup);
            chatHistory.appendChild(qaGroup);
            console.log('üéØ QA Í∑∏Î£πÏù¥ chatHistoryÏóê Ï∂îÍ∞ÄÎê®');
            
            // DOM Í∞ïÏ†ú Î¶¨ÌîåÎ°úÏö∞ Ìä∏Î¶¨Í±∞
            processCardsGroup.offsetHeight;
            
            // ÌòÑÏû¨ Ïπ¥Îìú Í∑∏Î£π IDÎ•º Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú Ï†ÄÏû•
            window.currentCardsGroupId = processCardsGroup.id;
            console.log('üíæ ÌòÑÏû¨ Ïπ¥Îìú Í∑∏Î£π ID Ï†ÄÏû•:', window.currentCardsGroupId);
            
            // Ïπ¥ÎìúÎì§Ïù¥ Ï†úÎåÄÎ°ú ÌëúÏãúÎêòÎäîÏßÄ ÌôïÏù∏
            setTimeout(() => {
                const cards = processCardsGroup.querySelectorAll('.process-card');
                console.log(`üîç ÏÉùÏÑ±Îêú Ïπ¥Îìú Ïàò: ${cards.length}`);
                cards.forEach((card, index) => {
                    const rect = card.getBoundingClientRect();
                    console.log(`üìè Ïπ¥Îìú ${index + 1} ÌÅ¨Í∏∞: ${rect.width}x${rect.height}`);
                    if (rect.height === 0) {
                        console.error(`‚ùå Ïπ¥Îìú ${index + 1}Ïù¥ Î≥¥Ïù¥ÏßÄ ÏïäÏäµÎãàÎã§!`);
                        // Í∞ïÏ†úÎ°ú Ïä§ÌÉÄÏùº Ï†ÅÏö©
                        card.style.display = 'block';
                        card.style.minHeight = '200px';
                        card.style.opacity = '1';
                        card.style.visibility = 'visible';
                    }
                });
            }, 50);
            
            
            // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú
            scrollToBottom();
            
            // Ïù¥ÎØ∏ Phase 1 ÌÉÄÏù¥Î®∏Îäî ÏúÑÏóêÏÑú ÏãúÏûëÎê®
            // Ï∂îÍ∞ÄÎ°ú ÏãúÏûëÌï† ÌÉÄÏù¥Î®∏ ÏóÜÏùå
            console.log('üéÜ displayUserQuestion ÏôÑÎ£å');
        }

        // ÌîÑÎ°úÏÑ∏Ïä§ ÌÉÄÏù¥Î®∏ ÏãúÏûë
        function startProcessTimer(processKey, timestamp) {
            const timerKey = `${processKey}-${timestamp}`;
            const timerId = `timer-${timerKey}`;
            
            processTimers[timerKey] = setInterval(() => {
                const timerElement = document.getElementById(timerId);
                if (timerElement) {
                    const currentTime = parseFloat(timerElement.textContent) || 0;
                    timerElement.textContent = `${(currentTime + 0.1).toFixed(1)}Ï¥à`;
                }
            }, 100); // 0.1Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
        }
        
        // ÌîÑÎ°úÏÑ∏Ïä§ ÌÉÄÏù¥Î®∏ Ï§ëÏßÄ
        function stopProcessTimer(processKey, timestamp) {
            const timerKey = `${processKey}-${timestamp}`;
            if (processTimers[timerKey]) {
                clearInterval(processTimers[timerKey]);
                delete processTimers[timerKey];
            }
        }
        
        // Ï†ÑÏó≠ Ïò§Î•ò Ï≤òÎ¶¨
        function displayGlobalError(errorMessage) {
            console.error('Global error:', errorMessage);
            // Î™®Îì† Î°úÎî© Ï§ëÏù∏ Ïπ¥ÎìúÏóê Ïò§Î•ò ÌëúÏãú
            const cardsGroup = document.getElementById(window.currentCardsGroupId);
            if (cardsGroup) {
                const loadingCards = cardsGroup.querySelectorAll('.process-card.loading');
                loadingCards.forEach((card, index) => {
                    const mode = ['local-basic', 'local-custom', 'chatgpt-basic', 'chatgpt-custom'][index];
                    displayError(mode, errorMessage, index);
                });
            }
        }
        
        // Ïä§ÌÅ¨Î°§ Ìï®Ïàò
        function scrollToBottom() {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // Ï†ÑÏó≠ Ïò§Î•ò ÌëúÏãú Ìï®Ïàò
        function displayGlobalError(message) {
            const resultsGrid = document.getElementById('resultsGrid');
            if (resultsGrid) {
                resultsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #e74c3c; background: #fff; border-radius: 12px; border: 2px solid #e74c3c;">
                        <h3>‚ùå Ïò§Î•ò Î∞úÏÉù</h3>
                        <p>${message}</p>
                        <button onclick="location.reload()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">ÏÉàÎ°úÍ≥†Ïπ®</button>
                    </div>
                `;
            }
            
            // ÏûÖÎ†• Îã§Ïãú ÌôúÏÑ±Ìôî
            setTimeout(() => {
                const input = document.getElementById('messageInput');
                const btn = document.getElementById('sendBtn');
                if (input) input.disabled = false;
                if (btn) btn.disabled = false;
            }, 1000);
        }
        
        // Ïò§Î•òÎ•º Ìï¥Îãπ Ïπ¥ÎìúÏóê ÌëúÏãú
        function displayError(mode, errorMessage, index) {
            // ÌòÑÏû¨ Ïπ¥Îìú Í∑∏Î£πÏóêÏÑú Ìï¥Îãπ Ïπ¥Îìú Ï∞æÍ∏∞
            const cardsGroup = document.getElementById(window.currentCardsGroupId);
            if (!cardsGroup) {
                console.error('Cards group not found for error:', window.currentCardsGroupId);
                return;
            }
            
            // Î™®ÎìúÏóê Îî∞Î•∏ Ïπ¥Îìú Ïù∏Îç±Ïä§ Í≤∞Ï†ï (ÏÉàÎ°úÏö¥ ÏàúÏÑú: üè†‚Üíüîß)
            const modeIndex = {
                'local-basic': 0,     // 1Î≤à: üè† ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + s3Í∏∞Î≥∏
                'local-custom': 1     // 2Î≤à: üîß ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + s3-chunking
            };
            
            const cardIndex = modeIndex[mode];
            if (cardIndex === undefined) {
                console.error('Unknown mode for error:', mode);
                return;
            }
            
            const processCard = cardsGroup.children[cardIndex];
            if (!processCard) {
                console.error('Process card not found for error at index:', cardIndex);
                return;
            }
            
            // ÌÉÄÏù¥Î®∏ Ï§ëÏßÄ
            const cardId = processCard.id;
            const timestamp = cardId.split('-').pop();
            stopProcessTimer(mode, timestamp);
            
            // Î°úÎî© ÏÉÅÌÉú Ï†úÍ±∞ Î∞è Ïò§Î•ò ÏÉÅÌÉú Ï∂îÍ∞Ä
            processCard.classList.remove('loading');
            processCard.classList.add('error');
            
            const cardBody = processCard.querySelector('.process-card-body');
            cardBody.classList.remove('loading');
            
            let html = `
                <div style="color: #dc3545; margin-bottom: 1rem;">
                    ‚ùå ${errorMessage}
                </div>
            `;
            
            // ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM Ïò§Î•òÏù∏ Í≤ΩÏö∞ Ìï¥Í≤∞Î∞©Î≤ï Ï∂îÍ∞Ä
            if (mode.includes('local')) {
                html += `
                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,193,7,0.1); border-radius: 8px; border-left: 3px solid #ffc107;">
                        <div style="font-weight: bold; color: #f57c00; margin-bottom: 0.5rem;">
                            üõ†Ô∏è Ìï¥Í≤∞Î∞©Î≤ï
                        </div>
                        <div style="font-size: 0.8rem; color: #6c757d;">
                            1. ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM ÏÉÅÌÉú ÌôïÏù∏: 192.168.0.224:8412<br>
                            2. vLLM ÏÑúÎ≤Ñ Ïû¨ÏãúÏûëÏù¥ ÌïÑÏöîÌï† Ïàò ÏûàÏùå<br>
                            3. kanana8b Î™®Îç∏ Î°úÎî© ÏÉÅÌÉú ÌôïÏù∏
                        </div>
                    </div>
                `;
            }
            
            html += `
                <div class="process-meta error">
                    <div class="status-badge error">
                        <span>‚ùå Ïã§Ìå®</span>
                        <span style="color: #6c757d; font-size: 0.8rem; margin-left: 0.5rem;">
                            üìÇ ${mode.includes('basic') ? 's3Í∏∞Î≥∏' : 's3-chunking'}
                        </span>
                    </div>
                    <div class="time-badge">
                        ‚è±Ô∏è 0.00Ï¥à
                    </div>
                </div>
            `;
            
            cardBody.innerHTML = html;
            
            // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú
            scrollToBottom();
            
            // Í≤∞Í≥º Ïπ¥Ïö¥Ìä∏ Ï¶ùÍ∞Ä
            resultCount++;
            
            // Î™®Îì† Í≤∞Í≥º ÏôÑÎ£åÏãú ÏûÖÎ†• Îã§Ïãú ÌôúÏÑ±Ìôî
            if (resultCount >= 4) {
                setTimeout(() => {
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                }, 1000);
            }
        }
        
        // Ï§ëÎ≥µ Î©îÏãúÏßÄ Ï∂îÍ∞Ä Ìï®Ïàò Ï†úÍ±∞Îê®
        
        // Í≤∞Í≥º ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
        function clearResultsArea() {
            document.getElementById('resultsGrid').innerHTML = '';
        }
        
        // Î°úÎî© Ïπ¥ÎìúÎì§ ÏÉùÏÑ±
        function createLoadingCards() {
            const grid = document.getElementById('resultsGrid');
            const modes = [
                { key: 'local-basic', title: 'ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + Í∏∞Î≥∏Ï≤≠ÌÇπÏ†ÑÎûµ(1500Ïûê ÎÇòÎàÑÍ∏∞ 250Ï§ëÏ≤©)(s3 Ìè¥Îçî)', icon: 'üè†' },
                { key: 'local-custom', title: 'ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + Ïª§Ïä§ÌÖÄ Ï≤≠ÌÇπÏ†ÑÎûµ(1500Ïûê ÎÇòÎàÑÍ∏∞ 250Ï§ëÏ≤©)(s3-chunking Ìè¥Îçî)', icon: 'üîß' }
            ];
            
            modes.forEach((mode, index) => {
                const loadingCard = `
                    <div class="loading-card" id="loading-${mode.key}">
                        <div class="loading-spinner"></div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">${mode.title}</div>
                            <div style="color: #666; font-size: 0.9rem;">ÎãµÎ≥Ä ÏÉùÏÑ± Ï§ë...</div>
                        </div>
                    </div>
                `;
                grid.insertAdjacentHTML('beforeend', loadingCard);
            });
        }
        
        // Í≤∞Í≥ºÎ•º Ìï¥Îãπ Ïπ¥ÎìúÏóê ÌëúÏãú
        function displayResult(result, mode, originalIndex) {
            // ÌòÑÏû¨ Ïπ¥Îìú Í∑∏Î£πÏóêÏÑú Ìï¥Îãπ Ïπ¥Îìú Ï∞æÍ∏∞
            const cardsGroup = document.getElementById(window.currentCardsGroupId);
            if (!cardsGroup) {
                console.error('Cards group not found:', window.currentCardsGroupId);
                return;
            }
            
            // Î™®ÎìúÏóê Îî∞Î•∏ Ïπ¥Îìú Ïù∏Îç±Ïä§ Í≤∞Ï†ï (ÏÉàÎ°úÏö¥ ÏàúÏÑú: üè†‚Üíüîß)
            const modeIndex = {
                'local-basic': 0,     // 1Î≤à: üè† ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + s3Í∏∞Î≥∏
                'local-custom': 1     // 2Î≤à: üîß ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + s3-chunking
            };
            
            const cardIndex = modeIndex[mode];
            if (cardIndex === undefined) {
                console.error('Unknown mode:', mode);
                return;
            }
            
            const processCard = cardsGroup.children[cardIndex];
            if (!processCard) {
                console.error('Process card not found for index:', cardIndex);
                return;
            }
            
            // Phase 2 Ïπ¥ÎìúÍ∞Ä ÏãúÏûëÌï† Îïå waiting ÏÉÅÌÉúÏóêÏÑú loadingÏúºÎ°ú Ï†ÑÌôò
            if (processCard.classList.contains('waiting')) {
                console.log(`üîÑ [PHASE 2] ${mode} ÏãúÏûë - waitingÏóêÏÑú loadingÏúºÎ°ú Ï†ÑÌôò`);
                processCard.classList.remove('waiting');
                processCard.classList.add('loading');
                
                const cardBody = processCard.querySelector('.process-card-body');
                cardBody.classList.remove('waiting');
                cardBody.classList.add('loading');
                
                const timestamp = processCard.id.split('-').pop();
                // waiting ÎÇ¥Ïö©ÏùÑ loading ÎÇ¥Ïö©ÏúºÎ°ú Ï†ÑÌôò (0Ï¥àÎ∂ÄÌÑ∞ ÏãúÏûë)
                cardBody.innerHTML = `
                    <div class="loading-container">
                        <div class="process-loading-spinner"></div>
                        <div class="loading-progress" style="margin-top: 15px; font-weight: 500; color: #495057;">
                            ‚è≥ AIÍ∞Ä Î¨∏ÏÑúÎ•º Í≤ÄÏÉâÏ§ëÏûÖÎãàÎã§...
                        </div>
                        <div class="loading-timer" id="timer-${mode}-${timestamp}" style="color: #6c757d; font-size: 0.85rem; margin-top: 8px;">0.0Ï¥à Í≤ΩÍ≥º</div>
                        <div class="loading-dots" style="margin-top: 10px; color: #667eea;">
                            <span>‚óè</span><span>‚óè</span><span>‚óè</span>
                        </div>
                    </div>
                `;
                
                // Phase 2 ÌÉÄÏù¥Î®∏ 0Ï¥àÎ∂ÄÌÑ∞ ÏãúÏûë
                console.log(`‚è∞ [PHASE 2] ${mode} ÌÉÄÏù¥Î®∏ 0Ï¥àÎ∂ÄÌÑ∞ ÏãúÏûë`);
                startProcessTimer(mode, timestamp);
            }
            
            // ÌÉÄÏù¥Î®∏ Ï§ëÏßÄ
            const cardId = processCard.id;
            const timestamp = cardId.split('-').pop();
            stopProcessTimer(mode, timestamp);
            
            // Î°úÎî© ÏÉÅÌÉú Ï†úÍ±∞
            processCard.classList.remove('loading');
            
            const cardBody = processCard.querySelector('.process-card-body');
            cardBody.classList.remove('loading');
            
            if (result.success) {
                // ÏÑ±Í≥µÌïú Í≤ΩÏö∞
                processCard.classList.add('success');
                
                let html = `
                    <div style="margin-bottom: 1rem; line-height: 1.6;">
                        ${formatText(result.answer) || 'ÎãµÎ≥ÄÏùÑ ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.'}
                    </div>
                `;
                
                // Ï∂îÏ≤ú ÏßàÎ¨∏ ÌëúÏãú (Ïú†ÏÇ¨ÎèÑ 80% ÎØ∏ÎßåÏãú)
                if (result.suggested_questions && result.suggested_questions.length > 0) {
                    html += `
                        <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                            <div style="font-weight: 500; margin-bottom: 0.5rem; color: #007bff;">üí° Ïù¥Îü∞ ÏßàÎ¨∏Îì§ÏùÄ Ïñ¥Îñ†Ïã†Í∞ÄÏöî?</div>
                            ${result.suggested_questions.map(q => `
                                <div style="margin: 0.3rem 0; cursor: pointer; color: #007bff; text-decoration: underline;" onclick="askSuggestedQuestion('${q.replace(/'/g, "\\'")}')">
                                    ‚Ä¢ ${q}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Ïú†ÏÇ¨ÎèÑ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
                if (result.similarity_info && result.similarity_info.length > 0) {
                    const topScore = result.similarity_info[0].score;
                    html += `
                        <div class="similarity-info">
                            <div class="similarity-title">
                                üîç Ïú†ÏÇ¨ÎèÑ ${topScore} (ÏÉÅÏúÑ ${result.similarity_info.length}Í∞ú)
                            </div>
                            ${result.similarity_info.map(item => `
                                <div class="similarity-item">
                                    <div class="similarity-rank">
                                        <strong>ÏàúÏúÑ ${item.rank}: ${item.score}</strong>
                                        <span style="font-size: 0.8rem; color: #6c757d;">
                                            üìÑ ${item.source || 'Unknown'}
                                        </span>
                                    </div>
                                    <div class="similarity-content">
                                        ${item.content_preview || 'ÎÇ¥Ïö© ÏóÜÏùå'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Ï≤òÎ¶¨ ÏãúÍ∞Ñ Î∞è ÏÉÅÌÉú Ï†ïÎ≥¥
                html += `
                    <div class="process-meta">
                        <div class="status-badge success">
                            <span>‚úÖ ÏÑ±Í≥µ</span>
                            <span style="color: #6c757d; font-size: 0.8rem; margin-left: 0.5rem;">
                                üìÇ ${result.chunking_type === 'basic' ? 's3Í∏∞Î≥∏' : 's3-chunking'} (${result.chunking_type || 'undefined'})
                            </span>
                        </div>
                        <div class="time-badge">
                            ‚è±Ô∏è ${parseFloat(result.response_time || result.total_time || 0).toFixed(3)}Ï¥à
                        </div>
                    </div>
                `;
                
                cardBody.innerHTML = html;
                
            } else {
                // Ïã§Ìå®Ìïú Í≤ΩÏö∞
                processCard.classList.add('error');
                
                let html = `
                    <div style="color: #dc3545; margin-bottom: 1rem;">
                        ‚ùå ${result.answer || 'Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'}
                    </div>
                `;
                
                // ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM Ïò§Î•òÏù∏ Í≤ΩÏö∞ Ìï¥Í≤∞Î∞©Î≤ï Ï∂îÍ∞Ä
                if (mode.includes('local')) {
                    html += `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,193,7,0.1); border-radius: 8px; border-left: 3px solid #ffc107;">
                            <div style="font-weight: bold; color: #f57c00; margin-bottom: 0.5rem;">
                                üõ†Ô∏è Ìï¥Í≤∞Î∞©Î≤ï
                            </div>
                            <div style="font-size: 0.8rem; color: #6c757d;">
                                1. ÌÑ∞ÎØ∏ÎÑêÏóêÏÑú "ollama serve" Î™ÖÎ†π Ïã§Ìñâ<br>
                                2. "ollama list"Î°ú Î™®Îç∏ ÌôïÏù∏<br>
                                3. Î™®Îç∏ ÏóÜÏúºÎ©¥ "ollama pull llama2" Î°ú ÏÑ§Ïπò
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="process-meta error">
                        <div class="status-badge error">
                            <span>‚ùå Ïã§Ìå®</span>
                            <span style="color: #6c757d; font-size: 0.8rem; margin-left: 0.5rem;">
                                üìÇ ${result.chunking_type === 'basic' ? 's3Í∏∞Î≥∏' : 's3-chunking'} (${result.chunking_type || 'undefined'})
                            </span>
                        </div>
                        <div class="time-badge">
                            ‚è±Ô∏è ${parseFloat(result.response_time || result.total_time || 0).toFixed(3)}Ï¥à
                        </div>
                    </div>
                `;
                
                cardBody.innerHTML = html;
            }
            
            // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú
            scrollToBottom();
            
            // Í≤∞Í≥º Ïπ¥Ïö¥Ìä∏ Ï¶ùÍ∞Ä
            resultCount++;
            
            // Î™®Îì† Í≤∞Í≥º ÏôÑÎ£åÏãú ÏûÖÎ†• Îã§Ïãú ÌôúÏÑ±Ìôî
            if (resultCount >= 4) {
                setTimeout(() => {
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                }, 1000);
            }
        }
        
        // Ï§ëÎ≥µ Î©îÏãúÏßÄ Ï∂îÍ∞Ä Ìï®Ïàò Ï†úÍ±∞Îê®
        
        // Í≤∞Í≥º ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
        function clearResultsArea() {
            document.getElementById('resultsGrid').innerHTML = '';
        }
        
        // Î°úÎî© Ïπ¥ÎìúÎì§ ÏÉùÏÑ±
        function createLoadingCards() {
            const grid = document.getElementById('resultsGrid');
            const modes = [
                { key: 'local-basic', title: 'ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + Í∏∞Î≥∏Ï≤≠ÌÇπÏ†ÑÎûµ(1500Ïûê ÎÇòÎàÑÍ∏∞ 250Ï§ëÏ≤©)(s3 Ìè¥Îçî)', icon: 'üè†' },
                { key: 'local-custom', title: 'ÏÇ¨ÎÇ¥ÏÑúÎ≤Ñ vLLM + Ïª§Ïä§ÌÖÄ Ï≤≠ÌÇπÏ†ÑÎûµ(1500Ïûê ÎÇòÎàÑÍ∏∞ 250Ï§ëÏ≤©)(s3-chunking Ìè¥Îçî)', icon: 'üîß' }
            ];
            
            modes.forEach((mode, index) => {
                const loadingCard = `
                    <div class="loading-card" id="loading-${mode.key}">
                        <div class="loading-spinner"></div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">${mode.title}</div>
                            <div style="color: #666; font-size: 0.9rem;">ÎãµÎ≥Ä ÏÉùÏÑ± Ï§ë...</div>
                        </div>
                    </div>
                `;
                grid.insertAdjacentHTML('beforeend', loadingCard);
            });
        }
        
        // Ïù¥ Ìï®ÏàòÎäî Ïπ¥Îìú Î†àÏù¥ÏïÑÏõÉÏóêÏÑú ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå (ÏúÑÏùò displayResult Ìï®Ïàò ÏÇ¨Ïö©)
        
        // Ï§ëÎ≥µÎêú Î©îÏãúÏßÄ Í¥ÄÎ†® Ìï®ÏàòÎì§ Ï†úÍ±∞Îê®
        
        // Ïù¥ Ï±ÑÌåÖ Î≤ÑÏ†ÑÏùò displayError Ìï®ÏàòÎäî ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå (ÏúÑÏùò Ïπ¥Îìú Î≤ÑÏ†Ñ ÏÇ¨Ïö©)
        
        // ÌòÑÏû¨ ÏÑ∏ÏÖò Ï†ÄÏû•
        function saveCurrentSession() {
            if (currentQuery) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                
                const newSession = {
                    id: Date.now(),
                    question: currentQuery.length > 40 ? currentQuery.substring(0, 40) + '...' : currentQuery,
                    fullQuestion: currentQuery,
                    timestamp: now.toISOString(),
                    displayTime: timeString,
                    resultCount: resultCount
                };
                
                chatSessions.unshift(newSession);
                
                // ÏµúÎåÄ 20Í∞úÍπåÏßÄÎßå Ï†ÄÏû•
                if (chatSessions.length > 20) {
                    chatSessions = chatSessions.slice(0, 20);
                }
                
                localStorage.setItem('chatSessions', JSON.stringify(chatSessions));
                updateSidebarHistory();
            }
        }
        
        // ÏÇ¨Ïù¥ÎìúÎ∞î ÌûàÏä§ÌÜ†Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏
        function updateSidebarHistory() {
            const sidebar = document.getElementById('historySidebar');
            if (!sidebar) return;
            
            // chatSessionsÍ∞Ä Î∞∞Ïó¥Ïù∏ÏßÄ ÌôïÏù∏
            if (!Array.isArray(chatSessions)) {
                console.error('chatSessions is not an array:', chatSessions);
                chatSessions = [];
            }
            
            if (chatSessions.length === 0) {
                sidebar.innerHTML = `
                    <div style="text-align: center; color: #666; font-style: italic; padding: 1rem;">
                        Ï±ÑÌåÖ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§
                    </div>
                `;
                return;
            }
            
            sidebar.innerHTML = chatSessions.map((session, index) => `
                <div class="history-item-sidebar ${index === 0 ? 'active' : ''}" onclick="loadSession(${index})">
                    <div class="history-question">${session.question}</div>
                    <div class="history-meta">
                        <span>${session.resultCount}Í∞ú Í≤∞Í≥º</span>
                        <span>${new Date(session.timestamp).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }
        
        function loadSession(index) {
            const session = chatSessions[index];
            document.getElementById('messageInput').value = session.fullQuestion;
        }
        
        // Î°úÎî© Í¥ÄÎ†® Ìï®ÏàòÎì§ÏùÄ Ïπ¥Îìú Î†àÏù¥ÏïÑÏõÉÏóêÏÑú ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå
        
        // Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê
        function showAdminPanel() {
            document.getElementById('adminPanel').style.display = 'block';
        }
        
        function hideAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }

        // ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        async function initializeSystem() {
            if (!confirm('‚ö†Ô∏è Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÍ≥† Î¨∏ÏÑúÍ∞Ä Îã§Ïãú Î°úÎìúÎê©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            // Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê Ïà®Í∏∞Í≥† Ï¥àÍ∏∞Ìôî ÌåùÏóÖ ÌëúÏãú
            hideAdminPanel();
            document.getElementById('initializationPopup').style.display = 'block';

            try {
                // 1Îã®Í≥Ñ: Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                document.getElementById('step1').style.display = 'flex';
                await fetch('/api/admin/clear-all', { method: 'DELETE' });

                // 2Îã®Í≥Ñ: Î¨∏ÏÑú Î°úÎìú
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'flex';

                // 3Îã®Í≥Ñ: ÏûÑÎ≤†Îî© ÏÉùÏÑ± (Î°úÎìúÏôÄ Ìï®Íªò ÏßÑÌñâÎê®)
                document.getElementById('step2').style.display = 'none';
                document.getElementById('step3').style.display = 'flex';

                const response = await fetch('/api/admin/reload-documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clear_all: true })
                });

                const result = await response.json();

                // ÏôÑÎ£å ÌëúÏãú
                document.getElementById('step3').style.display = 'none';
                document.getElementById('stepComplete').style.display = 'flex';
                document.getElementById('initializationResult').style.display = 'block';

                console.log('ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å:', result);

            } catch (error) {
                console.error('Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                alert('Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
                closeInitializationPopup();
            }
        }

        // Î¨∏ÏÑúÎßå Îã§Ïãú Î°úÎìú
        async function reloadDocuments() {
            if (!confirm('Î¨∏ÏÑúÎ•º Îã§Ïãú Î°úÎìúÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

            hideAdminPanel();
            
            try {
                const response = await fetch('/api/admin/reload-documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clear_all: false })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    alert(`Î¨∏ÏÑú Î°úÎìú ÏôÑÎ£å!\n- Î°úÎìúÎêú Î¨∏ÏÑú: ${result.documents_loaded}Í∞ú\n- ÏÉùÏÑ±Îêú Ï≤≠ÌÅ¨: ${result.total_chunks}Í∞ú`);
                } else {
                    alert('Î¨∏ÏÑú Î°úÎìú Ïã§Ìå®: ' + result.message);
                }
            } catch (error) {
                alert('Î¨∏ÏÑú Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // Ï¥àÍ∏∞Ìôî ÌåùÏóÖ Îã´Í∏∞
        function closeInitializationPopup() {
            document.getElementById('initializationPopup').style.display = 'none';
            // ÌåùÏóÖ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('.init-step').forEach(step => step.style.display = 'none');
            document.getElementById('initializationResult').style.display = 'none';
        }

        // Î≤°ÌÑ∞DB ÏÉÅÌÉú ÌôïÏù∏
        async function checkVectorDBStatus() {
            try {
                const response = await fetch('/api/system-status');
                const data = await response.json();

                if (data.status === 'success' && data.system_status) {
                    const vectordb = data.system_status.vectordb;
                    const documents = data.system_status.documents;

                    // Î≤°ÌÑ∞DBÍ∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò Î¨∏ÏÑúÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ Ï¥àÍ∏∞Ìôî Í∂åÏû• ÌåùÏóÖ ÌëúÏãú
                    if (!vectordb.available || vectordb.doc_count === 0 || !documents.available) {
                        setTimeout(showInitializationRecommendation, 1000); // 1Ï¥à ÌõÑ ÌëúÏãú
                    }
                }
            } catch (error) {
                console.error('ÏãúÏä§ÌÖú ÏÉÅÌÉú ÌôïÏù∏ Ïò§Î•ò:', error);
            }
        }

        // Ï¥àÍ∏∞Ìôî Í∂åÏû• ÌåùÏóÖ ÌëúÏãú
        function showInitializationRecommendation() {
            const popup = document.createElement('div');
            popup.className = 'admin-panel';
            popup.id = 'initRecommendationPopup';
            popup.innerHTML = `
                <div class="admin-content" style="max-width: 500px;">
                    <h3>üìã ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Í∂åÏû•</h3>
                    <p style="margin: 1rem 0; line-height: 1.6;">
                        Î≤°ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.<br>
                        S3 Ìè¥ÎçîÏóêÏÑú Î¨∏ÏÑúÎ•º Î°úÎìúÌïòÏó¨ Ï±ÑÌåÖÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî.
                    </p>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                        <button onclick="startInitialization()" style="padding: 0.8rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                            üì• ÏßÄÍ∏à Ï¥àÍ∏∞ÌôîÌïòÍ∏∞
                        </button>
                        <button onclick="dismissInitRecommendation()" style="padding: 0.8rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                            ÎÇòÏ§ëÏóê ÌïòÍ∏∞
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // Ï¥àÍ∏∞Ìôî Í∂åÏû• ÌåùÏóÖÏóêÏÑú Ï¥àÍ∏∞Ìôî ÏãúÏûë
        function startInitialization() {
            dismissInitRecommendation();
            initializeSystem();
        }

        // Ï¥àÍ∏∞Ìôî Í∂åÏû• ÌåùÏóÖ Îã´Í∏∞
        function dismissInitRecommendation() {
            const popup = document.getElementById('initRecommendationPopup');
            if (popup) {
                popup.remove();
            }
        }

        // Ï∂îÏ≤ú ÏßàÎ¨∏ ÌÅ¥Î¶≠Ïãú ÏûêÎèô ÏßàÎ¨∏
        function askSuggestedQuestion(question) {
            console.log('ü§î Ï∂îÏ≤ú ÏßàÎ¨∏ ÌÅ¥Î¶≠:', question);
            
            // ÏûÖÎ†•Ï∞ΩÏóê ÏßàÎ¨∏ ÏÑ§Ï†ï
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.value = question;
                
                // ÏûêÎèôÏúºÎ°ú Ï†ÑÏÜ°
                setTimeout(() => {
                    window.sendMessage();
                }, 100);
            }
        }
        
        // Ï¥àÍ∏∞Ìôî
        function initializeApp() {
            updateSidebarHistory();
            
            // Enter ÌÇ§ Ïù¥Î≤§Ìä∏
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìúÏãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å');
            console.log('sendMessage Ìï®Ïàò ÌôïÏù∏:', typeof window.sendMessage);
            
            initializeApp();
            
            // ÏãúÏä§ÌÖú ÏÉÅÌÉú ÌôïÏù∏ Î∞è ÌïÑÏöîÏãú Ï¥àÍ∏∞Ìôî ÌåùÏóÖ ÌëúÏãú
            checkVectorDBStatus();
            
            // Ï†ÑÏÜ° Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) {
                sendBtn.addEventListener('click', function() {
                    console.log('üîò Ï†ÑÏÜ° Î≤ÑÌäº ÌÅ¥Î¶≠Îê®');
                    window.sendMessage();
                });
                console.log('‚úÖ Ï†ÑÏÜ° Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ùÎê®');
            } else {
                console.error('‚ùå Ï†ÑÏÜ° Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
            }
            
            // ÏóîÌÑ∞ÌÇ§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        console.log('‚å®Ô∏è ÏóîÌÑ∞ÌÇ§ ÎàåÎ¶º');
                        window.sendMessage();
                    }
                });
                console.log('‚úÖ ÏóîÌÑ∞ÌÇ§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ùÎê®');
            } else {
                console.error('‚ùå ÏûÖÎ†•Ï∞ΩÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
            }
        });
    </script>
</body>
</html>
