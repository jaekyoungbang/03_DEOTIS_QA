<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEOTIS RAG QA System - í†µí•© ë²¤ì¹˜ë§ˆí‚¹</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¤–</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #2c3e50;
            margin: 0;
        }
        
        .admin-btn {
            padding: 0.5rem 1rem;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .admin-btn:hover {
            background: #c0392b;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 80px);
            margin: 0;
            padding: 0;
        }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        
        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* ì‚¬ì´ë“œë°” ì»¨í…ì¸  */
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
            background: #2c3e50;
            color: white;
        }
        
        .sidebar-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .new-chat-section {
            margin-bottom: 1rem;
        }
        
        .new-chat-btn {
            width: 100%;
            padding: 1rem;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .new-chat-btn:hover {
            background: #219a52;
        }
        
        .delete-history-btn {
            width: 100%;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }
        
        .delete-history-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }
        
        .delete-history-btn:active {
            transform: translateY(0);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .chat-history-section {
            margin-top: 1.5rem;
        }
        
        .history-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .history-list-sidebar {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .history-item-sidebar {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .history-item-sidebar:hover {
            background: #e3f2fd;
            border-left-color: #3498db;
        }
        
        .history-item-sidebar.active {
            background: #e8f5e8;
            border-left-color: #27ae60;
        }
        
        .history-question {
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
            line-height: 1.3;
        }
        
        .history-meta {
            font-size: 0.75rem;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        
        /* ì‹œìŠ¤í…œ ì •ë³´ (ê°„ì†Œí™”) */
        .system-info {
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #e0e0e0;
        }
        
        .system-info h3 {
            margin: 0 0 1rem 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .info-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .info-badge {
            padding: 0.25rem 0.75rem;
            background: #e8f4f8;
            color: #2c3e50;
            border-radius: 12px;
            font-size: 0.8rem;
            border: 1px solid #3498db;
        }
        
        /* ì±„íŒ… ì…ë ¥ ì˜ì—­ */
        .chat-input-area {
            padding: 1.5rem;
            background: white;
            border-top: 1px solid #e0e0e0;
        }
        
        /* ê²°ê³¼ ê·¸ë¦¬ë“œ ì˜ì—­ */
        .results-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .results-grid-realtime {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .result-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            opacity: 1;
            min-height: 300px;
            font-size: 0.9rem;
            transform: translateY(0);
            transition: all 0.5s ease;
            display: block;
            visibility: visible;
        }
        
        .result-card.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .result-card.loading {
            opacity: 0.7;
        }
        
        .result-card-header {
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-card-title {
            margin: 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .similarity-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .result-card-content {
            padding: 1rem;
        }
        
        .answer-text {
            line-height: 1.6;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .result-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #666;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        
        .result-meta span {
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .result-meta span.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .result-meta span.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .loading-card {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            background: white;
            border-radius: 12px;
            border: 2px dashed #ddd;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }
        
        .low-similarity-card {
            background: #fff3cd !important;
            border: 2px solid #ffeaa7 !important;
            opacity: 1 !important;
            display: block !important;
            visibility: visible !important;
        }
        
        .low-similarity-header {
            background: #ffeaa7;
            color: #856404;
        }
        
        .question-confirm {
            text-align: center;
            padding: 2rem;
        }
        
        .question-confirm h4 {
            margin-bottom: 1rem;
            color: #856404;
        }
        
        .confirm-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        
        .confirm-btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .confirm-btn.yes {
            background: #27ae60;
            color: white;
        }
        
        .confirm-btn.yes:hover {
            background: #219a52;
        }
        
        .confirm-btn.no {
            background: #e74c3c;
            color: white;
        }
        
        .confirm-btn.no:hover {
            background: #c0392b;
        }
        
        .chat-header {
            background: #2c3e50;
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .chat-header h3 {
            margin: 0;
        }
        
        .chat-history-dropdown {
            position: relative;
        }
        
        .history-btn {
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s;
        }
        
        .history-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .history-list {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 300px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .history-list.show {
            display: block;
        }
        
        .history-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            color: #333;
            transition: background 0.3s;
        }
        
        .history-item:hover {
            background: #f8f9fa;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-question {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .history-date {
            font-size: 0.8rem;
            color: #666;
        }
        
        .history-empty {
            padding: 1rem;
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .new-chat-btn {
            padding: 0.5rem 1rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: #3498db;
            color: white;
        }
        
        .message.bot .message-avatar {
            background: #27ae60;
            color: white;
        }
        
        .message-content {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 12px;
            max-width: 80%;
            position: relative;
        }
        
        .message.user .message-content {
            background: #3498db;
            color: white;
        }
        
        .message-meta {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .similarity-options {
            margin-top: 1rem;
            padding: 1rem;
            background: #fff3cd;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }
        
        .similarity-option {
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .similarity-option:hover {
            background: #f8f9fa;
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
            transform: translateY(-1px);
        }
        
        .similarity-option:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .low-similarity-card {
            border-left: 4px solid #f39c12;
        }
        
        .low-similarity-header {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        /* ì±„íŒ… ì…ë ¥ */
        .chat-input-container {
            padding: 1rem 1.5rem;
            border-top: 1px solid #eee;
        }
        
        .chat-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        
        .summarize-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        
        .summarize-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-input {
            display: flex;
            gap: 0.75rem;
        }
        
        .chat-input input {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .chat-input input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .send-btn {
            padding: 1rem 2rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .send-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .send-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ë²¤ì¹˜ë§ˆí‚¹ ê²°ê³¼ */
        .benchmark-results {
            display: none;
            margin-top: 2rem;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }
        
        .result-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border-left: 4px solid transparent;
        }
        
        .result-panel.api {
            border-left-color: #3498db;
        }
        
        .result-panel.local {
            border-left-color: #27ae60;
        }
        
        .panel-header {
            padding: 1rem 1.5rem;
            background: rgba(0,0,0,0.05);
            border-bottom: 1px solid #eee;
        }
        
        .panel-title {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .api .panel-title {
            color: #3498db;
        }
        
        .local .panel-title {
            color: #27ae60;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            padding: 1rem 1.5rem;
        }
        
        .metric {
            text-align: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .metric-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .metric-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        
        .panel-content {
            padding: 1.5rem;
        }
        
        .answer-content {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            line-height: 1.6;
            margin-bottom: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .source-info {
            padding: 1rem;
            background: #e8f4f8;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .source-info h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            color: #2c3e50;
        }
        
        .source-list {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* ê´€ë¦¬ì íŒ¨ë„ */
        .admin-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
        .admin-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }
        
        .admin-actions {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .admin-action-btn {
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
        }
        
        .admin-action-btn:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }
        
        .admin-action-btn.danger:hover {
            border-color: #e74c3c;
            background: #ffebee;
        }

        /* ì´ˆê¸°í™” ë‹¨ê³„ ìŠ¤íƒ€ì¼ */
        .init-step {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 1rem;
            border-left: 4px solid #007bff;
        }

        .init-step i {
            margin-right: 0.8rem;
            width: 20px;
            color: #007bff;
        }

        .init-step i.fa-check-circle {
            color: #28a745 !important;
        }
        
        /* ë¡œë”© ìƒíƒœ */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .process-loading-spinner {
            width: 60px !important;
            height: 60px !important;
            min-width: 60px !important;
            min-height: 60px !important;
            border: 6px solid rgba(102, 126, 234, 0.2) !important;
            border-top: 6px solid #667eea !important;
            border-right: 6px solid #764ba2 !important;
            border-radius: 50% !important;
            animation: spin 1.2s linear infinite !important;
            margin: 20px auto !important;
            display: block !important;
            position: relative !important;
            z-index: 10 !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
            box-sizing: border-box !important;
            flex-shrink: 0 !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* ê¸°ë³¸ ìŠ¤í”¼ë„ˆê°€ ì•ˆë³´ì¼ ë•Œ ëŒ€ì²´ìš© */
        .process-loading-spinner::before {
            content: "â³";
            font-size: 24px !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            animation: bounce 1s infinite !important;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translate(-50%, -50%) translateY(0); }
            40% { transform: translate(-50%, -50%) translateY(-10px); }
            60% { transform: translate(-50%, -50%) translateY(-5px); }
        }
        
        /* ê°•ë ¥í•œ ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ */
        @keyframes spin {
            0% { 
                transform: rotate(0deg) !important; 
                border-top-color: #667eea !important;
            }
            25% { 
                transform: rotate(90deg) !important; 
                border-top-color: #764ba2 !important;
            }
            50% { 
                transform: rotate(180deg) !important; 
                border-top-color: #667eea !important;
            }
            75% { 
                transform: rotate(270deg) !important; 
                border-top-color: #764ba2 !important;
            }
            100% { 
                transform: rotate(360deg) !important; 
                border-top-color: #667eea !important;
            }
        }
        
        /* ë¡œë”© ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ê°•í™” */
        .loading-container {
            text-align: center !important;
            padding: 40px 20px !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
            border: 2px solid rgba(102, 126, 234, 0.3) !important;
            border-radius: 12px !important;
            min-height: 180px !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            position: relative !important;
            z-index: 1 !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05) !important;
        }
        
        /* í”„ë¡œì„¸ìŠ¤ ì¹´ë“œ ë¡œë”© ìƒíƒœ */
        .process-card.loading {
            opacity: 1 !important;
            border-left: 4px solid #007bff !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        }
        
        .process-card-body.loading {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            min-height: 120px !important;
        }
        
        /* í”„ë¡œì„¸ìŠ¤ ì¹´ë“œ ëŒ€ê¸° ìƒíƒœ */
        .process-card.waiting {
            opacity: 0.6 !important;
            border-left: 4px solid #ffa500 !important;
            background: linear-gradient(135deg, #fffbf0 0%, #fff3cd 100%) !important;
        }
        
        .process-card-body.waiting {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            min-height: 120px !important;
            flex-direction: column;
        }
        
        .waiting-icon {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* í”„ë¡œì„¸ìŠ¤ ì¹´ë“œ ì„±ê³µ ìƒíƒœ */
        .process-card.success {
            border-left: 4px solid #28a745 !important;
            background: linear-gradient(135deg, #f8fff9 0%, #e6ffed 100%) !important;
        }
        
        /* í”„ë¡œì„¸ìŠ¤ ì¹´ë“œ ì—ëŸ¬ ìƒíƒœ */
        .process-card.error {
            border-left: 4px solid #dc3545 !important;
            background: linear-gradient(135deg, #fff8f8 0%, #ffeded 100%) !important;
        }
        
        /* ë¡œë”© ì ë“¤ ì• ë‹ˆë©”ì´ì…˜ */
        .loading-dots span {
            animation: blink 1.4s infinite both;
            font-size: 1.2em;
            margin: 0 2px;
        }
        
        .loading-dots span:nth-child(1) { animation-delay: 0s; }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes blink {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .info-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .results-grid-realtime {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chat-options {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .history-list {
                min-width: 250px;
            }
        }
        
        @media (max-width: 480px) {
            .info-cards {
                grid-template-columns: 1fr;
            }
            
            .results-grid-realtime {
                grid-template-columns: 1fr;
                gap: 1rem;
                max-width: 100%;
            }
        }
        
        /* í”„ë¡œì„¸ìŠ¤ ì¹´ë“œ í—¤ë” (ê°€ë¡œ ë°°ì—´) */
        .process-cards-header {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .process-card {
            background: white !important;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #dee2e6 !important;
            overflow: hidden;
            min-height: auto;
            transition: all 0.3s ease;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
        }
        
        /* ì¤‘ë³µ ì œê±°ë¨ - ìœ„ì—ì„œ ì •ì˜í•¨ */
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
        }
        
        .card-content {
            padding: 1rem;
            height: calc(100% - 60px);
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .card-content.waiting {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-style: italic;
        }
        
        .card-content.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #007bff;
        }
        
        .card-loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 0.5rem;
        }
        
        /* ì§ˆë¬¸ í‘œì‹œ ì˜ì—­ */
        .question-display-area {
            padding: 1rem 1.5rem;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .question-text {
            font-size: 1.1rem;
            font-weight: 500;
            color: #2c3e50;
            text-align: center;
        }
        
        /* í•˜ë‹¨ ì…ë ¥ì°½ ê³ ì • */
        .chat-input-area-fixed {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        /* ìœ ì‚¬ë„ ì •ë³´ ìŠ¤íƒ€ì¼ */
        .similarity-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(0,123,255,0.1);
            border-radius: 8px;
            border-left: 3px solid #007bff;
        }
        
        .similarity-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .similarity-item {
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(0,123,255,0.2);
            padding-bottom: 0.5rem;
        }
        
        .similarity-rank {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        
        .similarity-content {
            color: #6c757d;
            font-size: 0.8rem;
            line-height: 1.3;
        }
        
        .card-meta {
            margin-top: 1rem;
            padding: 0.5rem;
            background: rgba(40,167,69,0.1);
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
        
        .card-meta.error {
            background: rgba(220,53,69,0.1);
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: bold;
        }
        
        .status-badge.success {
            color: #28a745;
        }
        
        .status-badge.error {
            color: #dc3545;
        }
        
        .time-badge {
            color: #6c757d;
            font-weight: bold;
        }
        
        /* ë°˜ì‘í˜• ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
        @media (max-width: 1200px) {
            .process-cards-header {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            .process-cards-group {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
        }
        
        @media (max-width: 768px) {
            .process-cards-header {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .card-header {
                font-size: 0.8rem;
                padding: 0.5rem;
            }
        }
        
        /* ì±„íŒ… íˆìŠ¤í† ë¦¬ ì˜ì—­ */
        .chat-history-area {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
        }
        
        /* ì§ˆë¬¸-ë‹µë³€ ê·¸ë£¹ */
        .qa-group {
            margin-bottom: 2rem;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
        }
        
        /* ì‚¬ìš©ì ì§ˆë¬¸ (ì˜¤ë¥¸ìª½ ì •ë ¬) */
        .user-question {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }
        
        .user-question-content {
            max-width: 70%;
            background: #007bff;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            border-bottom-right-radius: 4px;
            font-size: 1rem;
            word-wrap: break-word;
        }
        
        /* 2ê°œ í”„ë¡œì„¸ìŠ¤ ì¹´ë“œ ê·¸ë£¹ (ê°€ë¡œ 1ì¤„) */
        .process-cards-group {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
            opacity: 1 !important;
            visibility: visible !important;
            min-height: 250px; /* ìµœì†Œ ë†’ì´ ë³´ì¥ */
        }
        
        /* ê°œë³„ í”„ë¡œì„¸ìŠ¤ ì¹´ë“œ */
        .process-card {
            background: white !important;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #dee2e6 !important;
            overflow: hidden;
            min-height: auto;
            transition: all 0.3s ease;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
        }
        
        /* ì¤‘ë³µ ì œê±°ë¨ - ìœ„ì—ì„œ ì •ì˜í•¨ */
        
        .process-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
        }
        
        .process-card-body {
            padding: 0.75rem;
            height: calc(100% - 60px);
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .process-card-body.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #007bff;
        }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ - ì¤‘ë³µ ì œê±°ë¨ */
        
        /* ëŒ€ì²´ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ (ì  3ê°œ) */
        .loading-dots {
            display: inline-flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .loading-dots span {
            width: 8px;
            height: 8px;
            background-color: #667eea;
            border-radius: 50%;
            animation: pulse 1.4s ease-in-out infinite;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes pulse {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }
        
        /* ë¡œë”© ì§„í–‰ í…ìŠ¤íŠ¸ */
        .loading-progress {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        /* ë¡œë”© ì‹œê°„ í‘œì‹œ */
        .loading-timer {
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.25rem;
        }
        
        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 1200px) {
            .process-cards-group {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
        }
        
        @media (max-width: 768px) {
            .user-question-content {
                max-width: 85%;
            }
            
            .process-cards-group {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .process-card-header {
                font-size: 0.8rem;
                padding: 0.5rem;
            }
            
            .process-card-body {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>DEOTIS RAG QA System</h1>
            <button class="admin-btn" onclick="showAdminPanel()">
                <i class="fas fa-cog"></i> ì‹œìŠ¤í…œ ê´€ë¦¬
            </button>
        </div>
    </div>
    
    <div class="container">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ’¬ DEOTIS RAG</h2>
            </div>
            
            <div class="sidebar-content">
                <!-- ìƒˆ ì±„íŒ… ë²„íŠ¼ -->
                <div class="new-chat-section">
                    <button class="new-chat-btn" onclick="newChat()">
                        <i class="fas fa-plus"></i>
                        ìƒˆ ì±„íŒ… ì‹œì‘
                    </button>
                    
                    <!-- ì±„íŒ… ëª©ë¡ ì‚­ì œ ë²„íŠ¼ -->
                    <button class="delete-history-btn" onclick="clearChatHistory()" title="ëª¨ë“  ì±„íŒ… ê¸°ë¡ ì‚­ì œ">
                        <i class="fas fa-trash-alt"></i>
                        ì±„íŒ… ê¸°ë¡ ì‚­ì œ
                    </button>
                </div>
                
                <!-- ì‹œìŠ¤í…œ ì •ë³´ -->
                <div class="system-info">
                    <h3>ğŸ¯ 2ê°€ì§€ ë¹„êµ ë¶„ì„</h3>
                    <div class="info-badges">
                        <span class="info-badge">ğŸ  ë¡œì»¬ ê¸°ë³¸</span>
                        <span class="info-badge">ğŸ—ï¸ ë¡œì»¬ ì»¤ìŠ¤í…€</span>
                    </div>
                </div>
                
                <!-- ì±„íŒ… íˆìŠ¤í† ë¦¬ -->
                <div class="chat-history-section">
                    <div class="history-title">ì±„íŒ… ê¸°ë¡</div>
                    <div class="history-list-sidebar" id="historySidebar">
                        <div style="text-align: center; color: #666; font-style: italic; padding: 1rem;">
                            ì±„íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <!-- ì±„íŒ… íˆìŠ¤í† ë¦¬ ì˜ì—­ -->
            <div class="chat-history-area" id="chatHistory">
                <div class="welcome-message">
                    <div style="text-align: center; padding: 2rem; color: #666; background: #f8f9fa; border-radius: 12px; margin: 1rem;">
                        <h3 style="margin-bottom: 1rem; color: #2c3e50;">ğŸ’¬ ì±„íŒ… ì‹œì‘</h3>
                        <p>ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ 2ê°œ í”„ë¡œì„¸ìŠ¤ì—ì„œ ê°ê° ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
                        <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap; margin-top: 1rem;">
                            <span class="info-badge">ğŸ  ì‚¬ë‚´ì„œë²„ vLLM+ê¸°ë³¸</span>
                            <span class="info-badge">ğŸ”§ ì‚¬ë‚´ì„œë²„ vLLM+ì»¤ìŠ¤í…€</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì±„íŒ… ì…ë ¥ì°½ (í•˜ë‹¨ ê³ ì •) -->
            <div class="chat-input-area-fixed">
                <div style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="summarizeCheck" style="margin: 0;" onchange="updateSummarizeMode()">
                        <label for="summarizeCheck" style="font-size: 0.9rem; color: #495057; font-weight: 500; cursor: pointer;">
                            ğŸ“ ìš”ì•½ ëª¨ë“œ <span id="summarizeStatus" style="color: #6c757d; font-size: 0.8rem;">(ìƒì„¸ ë‹µë³€)</span>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label for="localModelSelect" style="font-size: 0.9rem; color: #495057; font-weight: 500;">ğŸ¤– ë¡œì»¬ ëª¨ë¸:</label>
                        <select id="localModelSelect" style="padding: 0.3rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; background: white;">
                            <option value="./models/kanana8b" selected>kanana8b (í˜„ì¬ ì„œë²„ ëª¨ë¸)</option>
                            <option value="Qwen/Qwen3-32B-AWQ">Qwen/Qwen3-32B-AWQ</option>
                            <option value="meta-llama/Llama-2-7b-chat-hf">Llama-2-7b-chat</option>
                            <option value="microsoft/DialoGPT-medium">DialoGPT-medium</option>
                        </select>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: ì—°íšŒë¹„ ë‚©ë¶€)">
                    <button class="send-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        
        <!-- ì±„íŒ… ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€ (ì¹´ë“œ ë ˆì´ì•„ì›ƒ ì‚¬ìš©) -->
        <div id="chatContainer" style="display: none;">
            <div id="chatMessages" style="padding: 1rem;">
                <!-- ì‚¬ìš©í•˜ì§€ ì•ŠìŒ -->
            </div>
        </div>

        <!-- ê¸°ì¡´ ë²¤ì¹˜ë§ˆí‚¹ ê²°ê³¼ (ìˆ¨ê¹€) -->
        <div class="benchmark-results" id="benchmarkResults" style="display: none;">
            <div class="results-grid" id="resultsGrid">
                <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>
    
    <!-- ê´€ë¦¬ì íŒ¨ë„ -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-content">
            <h3>ğŸ”§ ì‹œìŠ¤í…œ ê´€ë¦¬</h3>
            <p>ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° ë¬¸ì„œ ë¡œë“œ ê¸°ëŠ¥</p>
            
            <div class="admin-actions">
                <button class="admin-action-btn danger" onclick="initializeSystem()">
                    <h4>ğŸ”„ ì „ì²´ ì‹œìŠ¤í…œ ì´ˆê¸°í™”</h4>
                    <p>ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  S3ì—ì„œ ë¬¸ì„œë¥¼ ë‹¤ì‹œ ë¡œë“œí•©ë‹ˆë‹¤</p>
                </button>
                
                <button class="admin-action-btn" onclick="reloadDocuments()">
                    <h4>ğŸ“¥ ë¬¸ì„œë§Œ ë‹¤ì‹œ ë¡œë“œ</h4>
                    <p>S3 í´ë”ì—ì„œ ë¬¸ì„œë¥¼ ë‹¤ì‹œ ë¡œë“œí•©ë‹ˆë‹¤ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)</p>
                </button>
            </div>
            
            <div style="margin-top: 1rem; text-align: center;">
                <button onclick="hideAdminPanel()" style="padding: 0.5rem 1rem; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- ì´ˆê¸°í™” ì§„í–‰ íŒì—… -->
    <div class="admin-panel" id="initializationPopup" style="display: none;">
        <div class="admin-content" style="max-width: 600px;">
            <h3>ğŸ”„ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</h3>
            <div id="initializationStatus">
                <div class="init-step" id="step1">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>ëª¨ë“  ë°ì´í„° ì‚­ì œ ì¤‘...</span>
                </div>
                <div class="init-step" id="step2" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>S3 í´ë”ì—ì„œ ë¬¸ì„œ ë¡œë“œ ì¤‘...</span>
                </div>
                <div class="init-step" id="step3" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>ë²¡í„° ì„ë² ë”© ìƒì„± ì¤‘...</span>
                </div>
                <div class="init-step" id="stepComplete" style="display: none;">
                    <i class="fas fa-check-circle" style="color: #28a745;"></i>
                    <span>ì´ˆê¸°í™” ì™„ë£Œ! ì±„íŒ…ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                </div>
            </div>
            
            <div id="initializationResult" style="display: none; margin-top: 1rem; text-align: center;">
                <button onclick="closeInitializationPopup()" style="padding: 0.8rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                    ì±„íŒ… ì‹œì‘í•˜ê¸°
                </button>
            </div>
        </div>
    </div>
    
    <script>
        let currentQuery = '';
        let resultCount = 0;
        // chatSessions ì´ˆê¸°í™” ì‹œ íƒ€ì… ì²´í¬
        let storedSessions = localStorage.getItem('chatSessions');
        let chatSessions = [];
        try {
            if (storedSessions) {
                const parsed = JSON.parse(storedSessions);
                // ë°°ì—´ì¸ì§€ í™•ì¸
                if (Array.isArray(parsed)) {
                    chatSessions = parsed;
                } else if (typeof parsed === 'object' && parsed !== null) {
                    // ê°ì²´ì¸ ê²½ìš° ë°°ì—´ë¡œ ë³€í™˜
                    chatSessions = Object.values(parsed);
                }
            }
        } catch (e) {
            console.error('chatSessions íŒŒì‹± ì˜¤ë¥˜:', e);
            chatSessions = [];
        }
        let currentSessionId = null;
        let similarityData = {};
        let processTimers = {}; // ê° í”„ë¡œì„¸ìŠ¤ë³„ íƒ€ì´ë¨¸ ì €ì¥
        let timerIntervals = {}; // íƒ€ì´ë¨¸ ì¸í„°ë²Œ ID ì €ì¥
        
        // ì±„íŒ… íˆìŠ¤í† ë¦¬ í† ê¸€
        function toggleHistory() {
            const historyList = document.getElementById('historyList');
            historyList.classList.toggle('show');
            
            if (historyList.classList.contains('show')) {
                updateHistoryList();
            }
        }
        
        // íˆìŠ¤í† ë¦¬ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateHistoryList() {
            const historyList = document.getElementById('historyList');
            
            if (chatSessions.length === 0) {
                historyList.innerHTML = '<div class="history-empty">ì±„íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            historyList.innerHTML = chatSessions.map((session, index) => `
                <div class="history-item" onclick="loadChatSession(${index})">
                    <div class="history-question">${session.firstQuestion}</div>
                    <div class="history-date">${new Date(session.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
        }
        
        // ì±„íŒ… ì„¸ì…˜ ë¡œë“œ
        function loadChatSession(index) {
            const session = chatSessions[index];
            currentSessionId = index;
            chatHistory = session.messages;
            
            // ë©”ì‹œì§€ ë³µì›
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            chatHistory.forEach(msg => {
                if (msg.type === 'user') {
                    addMessage('user', msg.content);
                } else if (msg.type === 'benchmark') {
                    addMessage('bot', '4ê°€ì§€ ë°©ì‹ì˜ ë‹µë³€ì„ í™•ì¸í•˜ì„¸ìš”.');
                    displayBenchmarkResults(msg.content);
                }
            });
            
            // íˆìŠ¤í† ë¦¬ ë‹«ê¸°
            document.getElementById('historyList').classList.remove('show');
        }
        
        // ìƒˆ ì±„íŒ…
        function newChat() {
            console.log('ğŸ”„ ìƒˆ ì±„íŒ… ì‹œì‘');
            
            chatHistory = [];
            currentSessionId = null;
            
            // ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ ì´ˆê¸°í™”
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        ğŸ”„ ìƒˆë¡œìš´ ì±„íŒ…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.
                    </div>
                    <div id="autoReloadPrompt" style="display: none; text-align: center; padding: 2rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; margin: 1rem;">
                        <h4 style="color: #856404; margin-bottom: 1rem;">ğŸ“‚ ì‹œìŠ¤í…œ ì´ˆê¸°í™” í•„ìš”</h4>
                        <p style="color: #856404; margin-bottom: 1.5rem;">ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë¬¸ì„œë¥¼ ë‹¤ì‹œ ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
                        <button onclick="autoLoadDocuments()" style="background: #28a745; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                            ğŸ“¥ S3 ë¬¸ì„œ ìë™ ë¡œë“œ
                        </button>
                    </div>
                `;
            }
            
            // ë²¤ì¹˜ë§ˆí¬ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            const benchmarkResults = document.getElementById('benchmarkResults');
            if (benchmarkResults) {
                benchmarkResults.style.display = 'none';
            }
            
            // ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
            const resultsGrid = document.getElementById('resultsGrid');
            if (resultsGrid) {
                resultsGrid.innerHTML = '';
                console.log('âœ… ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™” ì™„ë£Œ');
            }
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™” ë° í¬ì»¤ìŠ¤
            const questionInput = document.getElementById('questionInput');
            if (questionInput) {
                questionInput.value = '';
                questionInput.focus();
            }
            
            console.log('âœ… ìƒˆ ì±„íŒ… ì´ˆê¸°í™” ì™„ë£Œ');
            
            // ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬
            checkSystemStatus();
        }
        
        // ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬ í•¨ìˆ˜
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/document/status');
                const data = await response.json();
                
                // ë²¡í„° DBê°€ ë¹„ì–´ìˆìœ¼ë©´ ìë™ ë¦¬ë¡œë“œ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
                if (data.total_documents === 0) {
                    const autoReloadPrompt = document.getElementById('autoReloadPrompt');
                    if (autoReloadPrompt) {
                        autoReloadPrompt.style.display = 'block';
                        console.log('âš ï¸ ë²¡í„° DB ë¹„ì–´ìˆìŒ - ìë™ ë¦¬ë¡œë“œ í”„ë¡¬í”„íŠ¸ í‘œì‹œ');
                    }
                }
            } catch (error) {
                console.log('ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬ ì‹¤íŒ¨:', error);
            }
        }
        
        // ìë™ ë¬¸ì„œ ë¡œë“œ í•¨ìˆ˜
        async function autoLoadDocuments() {
            const button = event.target;
            const originalText = button.textContent;
            
            try {
                button.textContent = 'ğŸ“¥ ë¡œë”© ì¤‘...';
                button.disabled = true;
                
                const response = await fetch('/api/document/load-s3', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.documents_loaded) {
                    // ì„±ê³µ ì‹œ í”„ë¡¬í”„íŠ¸ ìˆ¨ê¸°ê¸°
                    const autoReloadPrompt = document.getElementById('autoReloadPrompt');
                    if (autoReloadPrompt) {
                        autoReloadPrompt.style.display = 'none';
                    }
                    
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    alert(`âœ… ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ!\nğŸ“„ ${data.documents_loaded}ê°œ ë¬¸ì„œ, ${data.total_chunks}ê°œ ì²­í¬ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    console.log('âœ… ìë™ ë¬¸ì„œ ë¡œë“œ ì„±ê³µ');
                } else {
                    alert('âŒ ë¬¸ì„œ ë¡œë“œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
                
            } catch (error) {
                alert('âŒ ë¬¸ì„œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                console.error('ìë™ ë¬¸ì„œ ë¡œë“œ ì˜¤ë¥˜:', error);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // ì±„íŒ… ê¸°ë¡ ì‚­ì œ í•¨ìˆ˜
        function clearChatHistory() {
            if (confirm('ëª¨ë“  ì±„íŒ… ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì±„íŒ… ì„¸ì…˜ ì‚­ì œ
                localStorage.removeItem('chatSessions');
                chatSessions = [];
                
                // ì‚¬ì´ë“œë°” íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
                updateSidebarHistory();
                
                // í˜„ì¬ ì±„íŒ…ë„ ì´ˆê¸°í™”
                newChat();
                
                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #27ae60;
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    animation: slideIn 0.3s ease;
                `;
                toast.innerHTML = '<i class="fas fa-check"></i> ëª¨ë“  ì±„íŒ… ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
                
                document.body.appendChild(toast);
                
                // 3ì´ˆ í›„ í† ìŠ¤íŠ¸ ì œê±°
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 3000);
            }
        }
        
        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(text) {
            if (text === '&nbsp;') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ìš”ì•½ ëª¨ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSummarizeMode() {
            const checkbox = document.getElementById('summarizeCheck');
            const status = document.getElementById('summarizeStatus');
            
            if (checkbox && status) {
                if (checkbox.checked) {
                    status.textContent = '(ê°„ê²°í•œ ìš”ì•½)';
                    status.style.color = '#28a745';
                    console.log('âœ… ìš”ì•½ ëª¨ë“œ í™œì„±í™”: LLMì´ ê°„ê²°í•œ ìš”ì•½ ì œê³µ');
                } else {
                    status.textContent = '(ìƒì„¸ ë‹µë³€)';
                    status.style.color = '#6c757d';
                    console.log('ğŸ“– ì¼ë°˜ ëª¨ë“œ: ê²€ìƒ‰ëœ ë‚´ìš© ê·¸ëŒ€ë¡œ ì¶œë ¥');
                }
            }
        }
        
        // ì¹´ë“œëª… ì¶”ì¶œ í•¨ìˆ˜ (ì‹¤ì œ MD íŒŒì¼ì˜ ì´ë¯¸ì§€ alt í…ìŠ¤íŠ¸ ê¸°ë°˜)
        function extractCardNameFromAlt(altText) {
            if (!altText) return '';
            
            // ì‹¤ì œ MD íŒŒì¼ì— ìˆëŠ” ì¹´ë“œëª… íŒ¨í„´ ë§¤ì¹­
            const cardPatterns = {
                'ìš°ë¦¬ì¹´ë“œ': ['ìš°ë¦¬ì¹´ë“œ', 'woori'],
                'í•˜ë‚˜ì¹´ë“œ': ['í•˜ë‚˜ì¹´ë“œ', 'hana'], 
                'ë†í˜‘ì¹´ë“œ': ['NHë†í˜‘ì¹´ë“œ', 'ë†í˜‘', 'NH', 'nh'],
                'SCì œì¼ì€í–‰': ['Standard Chartered', 'SCì œì¼ì€í–‰', 'SC'],
                'ê¸°ì—…ì€í–‰': ['IBKê¸°ì—…ì€í–‰', 'IBK', 'ê¸°ì—…ì€í–‰'],
                'êµ­ë¯¼ì¹´ë“œ': ['KBêµ­ë¯¼ì¹´ë“œ', 'KB', 'êµ­ë¯¼'],
                'ëŒ€êµ¬ì€í–‰': ['DGBëŒ€êµ¬ì€í–‰', 'DGB', 'ëŒ€êµ¬'],
                'ë¶€ì‚°ì€í–‰': ['BNKë¶€ì‚°ì€í–‰', 'BNKë¶€ì‚°', 'ë¶€ì‚°'],
                'ê²½ë‚¨ì€í–‰': ['BNKê²½ë‚¨ì€í–‰', 'BNKê²½ë‚¨', 'ê²½ë‚¨'],
                'ì”¨í‹°ì€í–‰': ['citiì€í–‰', 'citi', 'Citi'],
                'ì‹ í•œì¹´ë“œ': ['ì‹ í•œì¹´ë“œ', 'shinhan', 'Shinhan'],
                'BCì¹´ë“œ': ['BC ë°”ë¡œì¹´ë“œ', 'BC', 'bc', 'ë°”ë¡œì¹´ë“œ']
            };
            
            for (const [cardName, patterns] of Object.entries(cardPatterns)) {
                if (patterns.some(pattern => altText.includes(pattern))) {
                    return cardName;
                }
            }
            return altText;
        }
        
        // í…ìŠ¤íŠ¸ í¬ë§·íŒ… í•¨ìˆ˜
        function formatText(text) {
            if (!text) return '';
            
            console.log('ğŸ”§ formatText input:', text.substring(0, 200) + '...');
            
            // 1ë‹¨ê³„: ì´ë¯¸ì§€ ë§ˆí¬ë‹¤ìš´ì„ ë³´í˜¸í•˜ê¸° ìœ„í•´ ì„ì‹œ í”Œë ˆì´ìŠ¤í™€ë”ë¡œ ëŒ€ì²´
            const imageProtectionMap = new Map();
            let imageCounter = 0;
            let formatted = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, src) => {
                const placeholder = `__IMAGE_PLACEHOLDER_${imageCounter}__`;
                imageProtectionMap.set(placeholder, match);
                imageCounter++;
                return placeholder;
            });
            
            // 2ë‹¨ê³„: <think> íƒœê·¸ì™€ ë‚´ìš© ì œê±° (ë‹«ëŠ” íƒœê·¸ê°€ ìˆëŠ” ê²½ìš°)
            formatted = formatted.replace(/<think>[\s\S]*?<\/think>/g, '');
            
            // <think>ë¡œ ì‹œì‘í•˜ëŠ” ë¶€ë¶„ì´ ë‚¨ì•„ìˆìœ¼ë©´ ëê¹Œì§€ ì œê±° (ë‹«ëŠ” íƒœê·¸ê°€ ì—†ëŠ” ê²½ìš° ëŒ€ë¹„)
            formatted = formatted.replace(/<think>[\s\S]*$/g, '');
            
            // **ë‹µë³€:** í˜•íƒœë¡œ ì‹œì‘í•˜ëŠ” í•œêµ­ì–´ ë‹µë³€ ì¶”ì¶œ
            const answerMatch = formatted.match(/\*\*ë‹µë³€:\*\*[\s\S]*$/);
            if (answerMatch) {
                formatted = answerMatch[0];
            }
            
            // ì¤„ë°”ê¿ˆ ì •ê·œí™”
            formatted = formatted.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // 1. ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ê²€ì¶œ ë° ë³€í™˜ (ê°œì„ ëœ ë²„ì „)
            // ë” ì •í™•í•œ ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ê²€ì¶œ: ì—°ì†ëœ | ë¼ì¸ë“¤ì„ í•˜ë‚˜ì˜ í…Œì´ë¸”ë¡œ ì¸ì‹
            const markdownTableRegex = /((\|[^|\n]*)+\|[\s]*\n){2,}/g;
            const markdownTables = formatted.match(markdownTableRegex);
            
            if (markdownTables) {
                console.log('ğŸ”§ Found markdown tables:', markdownTables.length);
                markdownTables.forEach((tableMatch, index) => {
                    console.log(`ğŸ”§ Processing table ${index + 1}:`, tableMatch);
                    const tableHtml = convertMarkdownTableToHTML(tableMatch);
                    if (tableHtml) {
                        console.log(`ğŸ”§ Table ${index + 1} converted to HTML`);
                        formatted = formatted.replace(tableMatch, tableHtml);
                    } else {
                        console.log(`ğŸ”§ Table ${index + 1} failed to convert`);
                    }
                });
            }
            
            // 2. ì¼ë°˜ í…ìŠ¤íŠ¸ í…Œì´ë¸” ê²€ì¶œ (íƒ­ì´ë‚˜ ì—¬ëŸ¬ ê³µë°±ìœ¼ë¡œ êµ¬ë¶„, ë˜ëŠ” ë§ˆí¬ë‹¤ìš´ ì”ì—¬ë¬¼)
            const textTableRegex = /^([^\n]+\t[^\n]*\n)+/gm;
            const textTables = formatted.match(textTableRegex);
            
            // 3. ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ì”ì—¬ë¬¼ ê²€ì¶œ (| ê°€ ìˆì§€ë§Œ ì™„ì „í•œ ë§ˆí¬ë‹¤ìš´ì´ ì•„ë‹Œ ê²½ìš°)
            const partialMarkdownTableRegex = /^[^|\n]*\|[^|\n]*\|[^|\n]*$/gm;
            const partialTables = formatted.match(partialMarkdownTableRegex);
            
            // 4. íŠ¹ë³„ ì¼€ì´ìŠ¤: í•œêµ­ì–´ í…Œì´ë¸” í˜•ì‹ (ì˜ˆ: "ê²°ì œì¼ì    ì¼ì‹œë¶ˆ/í• ë¶€ ì´ìš©ê¸°ê°„    í˜„ê¸ˆì„œë¹„ìŠ¤ ì´ìš©ê¸°ê°„")
            const koreanTablePattern = /^([ê°€-í£\w\s/]+\s{4,}[ê°€-í£\w\s/]+\s{4,}[ê°€-í£\w\s/]+.*\n)+/gm;
            const koreanTables = formatted.match(koreanTablePattern);
            
            if (textTables) {
                textTables.forEach(tableMatch => {
                    const tableHtml = convertTextTableToHTML(tableMatch);
                    if (tableHtml) {
                        formatted = formatted.replace(tableMatch, tableHtml);
                    }
                });
            }
            
            // ë¶€ë¶„ ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ì²˜ë¦¬
            if (partialTables) {
                partialTables.forEach(tableMatch => {
                    const tableHtml = convertPartialMarkdownTableToHTML(tableMatch);
                    if (tableHtml) {
                        formatted = formatted.replace(tableMatch, tableHtml);
                    }
                });
            }
            
            // í•œêµ­ì–´ ê³µë°± ê¸°ë°˜ í…Œì´ë¸” ì²˜ë¦¬
            if (koreanTables) {
                koreanTables.forEach(tableMatch => {
                    const tableHtml = convertKoreanSpaceTableToHTML(tableMatch);
                    if (tableHtml) {
                        formatted = formatted.replace(tableMatch, tableHtml);
                    }
                });
            }
            
            // 5. ì½œë¡ ìœ¼ë¡œ êµ¬ë¶„ëœ í‚¤-ê°’ ìŒ í…Œì´ë¸” (ì˜ˆ: "í•­ëª©: ê°’" í˜•íƒœ)
            const keyValueRegex = /^([^:\n]+:\s*[^\n]+\n){2,}/gm;
            const keyValueTables = formatted.match(keyValueRegex);
            
            if (keyValueTables) {
                keyValueTables.forEach(tableMatch => {
                    const tableHtml = convertKeyValueToHTML(tableMatch);
                    if (tableHtml) {
                        formatted = formatted.replace(tableMatch, tableHtml);
                    }
                });
            }
            
            // ê¹€ëª…ì • ê³ ê°ì˜ ì¹´ë“œ ë³´ìœ  ì—¬ë¶€ì— ë”°ë¥¸ ì´ë¯¸ì§€ ë¶„ë¥˜ í‘œì‹œ
            formatted = formatted.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, altText, imagePath) => {
                // Aspose.Wordsë¡œ ìƒì„±ëœ ì´ë¯¸ì§€ë§Œ ì²˜ë¦¬
                if (imagePath.startsWith('Aspose.Words.')) {
                    // ê¹€ëª…ì • ê³ ê° ë³´ìœ  ì¹´ë“œ í™•ì¸ (ì‹¤ì œ ì´ë¯¸ì§€ alt í…ìŠ¤íŠ¸ì™€ ë§¤ì¹­)
                    const userOwnedCards = ['ìš°ë¦¬ì¹´ë“œ', 'í•˜ë‚˜ì¹´ë“œ', 'ë†í˜‘ì¹´ë“œ'];
                    const cardName = extractCardNameFromAlt(altText);
                    console.log('ğŸ” ì¹´ë“œëª… ì¶”ì¶œ:', altText, 'â†’', cardName);
                    
                    const isOwnedCard = userOwnedCards.some(owned => {
                        // ë” ì •í™•í•œ ë§¤ì¹­ì„ ìœ„í•´ ë‹¤ì–‘í•œ íŒ¨í„´ í™•ì¸
                        if (owned === 'ìš°ë¦¬ì¹´ë“œ' && (altText.includes('ìš°ë¦¬') || cardName.includes('ìš°ë¦¬'))) return true;
                        if (owned === 'í•˜ë‚˜ì¹´ë“œ' && (altText.includes('í•˜ë‚˜') || cardName.includes('í•˜ë‚˜'))) return true;
                        if (owned === 'ë†í˜‘ì¹´ë“œ' && (altText.includes('NH') || altText.includes('ë†í˜‘') || cardName.includes('ë†í˜‘'))) return true;
                        return false;
                    });
                    
                    const cardStatus = isOwnedCard ? 
                        `<div style="background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-top: 5px;">
                            âœ… ë³´ìœ  ì¹´ë“œ
                        </div>` :
                        `<div style="background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-top: 5px;">
                            â­ ë°œê¸‰ ì¶”ì²œ ì¹´ë“œ
                        </div>`;
                    
                    return `<div style="margin: 15px 0; text-align: center; border: ${isOwnedCard ? '2px solid #28a745' : '2px solid #ffc107'}; padding: 10px; border-radius: 12px;">
                        <img src="/images/${imagePath}" 
                             alt="${altText}" 
                             style="max-width: 200px; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                             onerror="console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', '/images/${imagePath}'); this.style.display='none'; this.nextElementSibling.style.display='block';" 
                             onload="console.log('ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', '/images/${imagePath}');" />
                        <div style="display: none; padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
                            âŒ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨<br>
                            ğŸ“· íŒŒì¼: ${imagePath}<br>
                            ğŸ·ï¸ ì„¤ëª…: ${altText}
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9em; color: #333;">
                            ${altText}
                        </div>
                        ${cardStatus}
                    </div>`;
                }
                return match; // ë‹¤ë¥¸ ì´ë¯¸ì§€ëŠ” ì›ë³¸ ìœ ì§€
            });
            
            // ê¸°ë³¸ í…ìŠ¤íŠ¸ í¬ë§·íŒ…
            formatted = formatted
                // í…Œì´ë¸” êµ¬ë¶„ì„  ì œê±° (ë…ë¦½ì ì¸ ë¼ì¸ì˜ ---, ===, ... íŒ¨í„´)
                .replace(/^[\s]*[-=.+_*~:]{3,}[\s]*$/gm, '')
                // ì—°ì†ëœ ë¹ˆ ì¤„ ì •ë¦¬
                .replace(/\n\s*\n\s*\n/g, '\n\n')
                // ì˜ëª»ëœ ë°±ìŠ¬ë˜ì‹œ ì´ìŠ¤ì¼€ì´í”„ ìˆ˜ì •
                .replace(/\\(\d+)\./g, '$1.')
                // ë³¼ë“œ í…ìŠ¤íŠ¸
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // ì´íƒ¤ë¦­ í…ìŠ¤íŠ¸
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // ìˆ«ì ëª©ë¡ ê°œì„  (ë‹¨ê³„ë³„ ì ˆì°¨ ê°•ì¡°)
                .replace(/^\d+\)\s(.+)$/gm, '<div style="margin: 10px 0; padding: 12px 16px; background: #f0f8ff; border-left: 4px solid #2196F3; border-radius: 6px;"><strong style="color: #1976D2;">$&</strong></div>')
                .replace(/^\d+\.\s(.+)$/gm, '<div style="margin: 8px 0; padding: 10px 12px; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 4px;"><strong>$&</strong></div>')
                // ë¶ˆë¦¿ ëª©ë¡ ê°œì„ 
                .replace(/^[-â€¢]\s(.+)$/gm, '<div style="margin: 5px 0; padding-left: 20px; color: #555;">â€¢ $1</div>')
                // ì¤‘ìš” ì„¹ì…˜ í—¤ë” (** ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ í…ìŠ¤íŠ¸)
                .replace(/\*\*([^*]+)\*\*:/g, '<div style="margin: 15px 0 8px 0; font-weight: 700; font-size: 1.1em; color: #2c3e50; border-bottom: 2px solid #e9ecef; padding-bottom: 4px;">$1:</div>')
                // ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜ (í…Œì´ë¸” ì œì™¸)
                .replace(/\n/g, '<br>');
            
            // ë§ˆì§€ë§‰ ë‹¨ê³„: ë³´í˜¸ëœ ì´ë¯¸ì§€ ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ì—¬ ë³µì›
            imageProtectionMap.forEach((originalImage, placeholder) => {
                // ë§ˆí¬ë‹¤ìš´ ì´ë¯¸ì§€ë¥¼ HTMLë¡œ ë³€í™˜
                const htmlImage = originalImage.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, 
                    '<img src="$2" alt="$1" style="max-width: 200px; height: auto; margin: 8px 0; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onerror="console.error(\'ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:\', \'$2\'); this.style.display=\'none\';" onload="console.log(\'ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:\', \'$2\');" />');
                formatted = formatted.replace(placeholder, htmlImage);
            });
            
            console.log('ğŸ”§ formatText output:', formatted.substring(0, 500) + '...');
            return formatted;
        }
        
        // ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸”ì„ HTMLë¡œ ë³€í™˜
        function convertMarkdownTableToHTML(tableText) {
            try {
                const lines = tableText.trim().split('\n').filter(line => line.trim());
                const tableRows = [];
                let headerProcessed = false;
                let maxColumns = 0;
                
                // ë¨¼ì € ìµœëŒ€ ì—´ ìˆ˜ë¥¼ ì°¾ìŒ
                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('|') && line.endsWith('|')) {
                        if (!line.match(/^\|[\s\-:]+\|$/)) {
                            const cells = line.slice(1, -1).split('|');
                            maxColumns = Math.max(maxColumns, cells.length);
                        }
                    }
                }
                
                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('|') && line.endsWith('|')) {
                        // êµ¬ë¶„ì„  ê±´ë„ˆë›°ê¸° - ë” ê°•ë ¥í•œ íŒ¨í„´ (| ------ | í˜•íƒœ ì²˜ë¦¬)
                        const cellsCheck = line.slice(1, -1).split('|');
                        const isAllSeparators = cellsCheck.every(cell => {
                            const trimmed = cell.trim();
                            // ë¹ˆ ì…€ì´ê±°ë‚˜ êµ¬ë¶„ì„  ë¬¸ìë“¤ë¡œë§Œ ì´ë¤„ì§„ ì…€ì¸ì§€ í™•ì¸ (ë” ê°•í™”ëœ íŒ¨í„´)
                            return trimmed === '' || /^[-=:+_*~.\s]{2,}$/.test(trimmed) || /^-{2,}$/.test(trimmed);
                        });
                        
                        if (isAllSeparators) {
                            console.log('ğŸ”§ Skipping table separator line:', line);
                            continue;
                        }
                        
                        // ì…€ ì¶”ì¶œ ë° ë¹ˆ ì…€ ì²˜ë¦¬
                        let cells = line.slice(1, -1).split('|').map(cell => {
                            const trimmed = cell.trim();
                            // êµ¬ë¶„ì„ ë§Œ ìˆëŠ” ì…€ ì²´í¬ (í•œê¸€ í…ìŠ¤íŠ¸ ë³´í˜¸) - ------ íŒ¨í„´ ì²˜ë¦¬
                            if (trimmed.match(/^[-=.+_*~:\s]{2,}$/) && trimmed.length > 0) {
                                return '&nbsp;';
                            }
                            // ------ ê°™ì€ êµ¬ë¶„ì„  íŒ¨í„´ ì²˜ë¦¬  
                            if (/^-{2,}$/.test(trimmed)) {
                                return '&nbsp;';
                            }
                            // ë¹ˆ ì…€ ì²˜ë¦¬
                            if (!trimmed) {
                                return '&nbsp;';
                            }
                            return trimmed;
                        });
                        
                        // ì—´ ìˆ˜ ë§ì¶”ê¸°
                        while (cells.length < maxColumns) {
                            cells.push('&nbsp;');
                        }
                        
                        if (cells.length > 0) {
                            const tag = !headerProcessed ? 'th' : 'td';
                            const rowClass = !headerProcessed ? 'header-row' : '';
                            tableRows.push(`<tr class="${rowClass}">${cells.map(cell => `<${tag}>${cell === '&nbsp;' ? cell : escapeHtml(cell)}</${tag}>`).join('')}</tr>`);
                            if (!headerProcessed) headerProcessed = true;
                        }
                    }
                }
                
                if (tableRows.length > 0) {
                    return createStyledTable(tableRows.join(''));
                }
            } catch (e) {
                console.error('ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ë³€í™˜ ì˜¤ë¥˜:', e);
            }
            return null;
        }
        
        // í…ìŠ¤íŠ¸ í…Œì´ë¸”ì„ HTMLë¡œ ë³€í™˜ (íƒ­ êµ¬ë¶„)
        function convertTextTableToHTML(tableText) {
            const lines = tableText.trim().split('\n').filter(line => line.trim());
            if (lines.length < 2) return null;
            
            const tableRows = [];
            let isFirstRow = true;
            
            for (let line of lines) {
                const cells = line.split('\t').map(cell => cell.trim());
                if (cells.length > 1) {
                    const tag = isFirstRow ? 'th' : 'td';
                    const rowClass = isFirstRow ? 'header-row' : '';
                    tableRows.push(`<tr class="${rowClass}">${cells.map(cell => `<${tag}>${cell || '&nbsp;'}</${tag}>`).join('')}</tr>`);
                    isFirstRow = false;
                }
            }
            
            if (tableRows.length > 0) {
                return createStyledTable(tableRows.join(''));
            }
            return null;
        }
        
        // í‚¤-ê°’ ìŒì„ HTML í…Œì´ë¸”ë¡œ ë³€í™˜
        function convertKeyValueToHTML(kvText) {
            const lines = kvText.trim().split('\n').filter(line => line.trim());
            if (lines.length < 2) return null;
            
            const tableRows = [];
            
            for (let line of lines) {
                const colonIndex = line.indexOf(':');
                if (colonIndex > 0) {
                    const key = line.substring(0, colonIndex).trim();
                    const value = line.substring(colonIndex + 1).trim();
                    tableRows.push(`<tr><td class="key-cell"><strong>${key}</strong></td><td class="value-cell">${value}</td></tr>`);
                }
            }
            
            if (tableRows.length > 0) {
                return createStyledTable(tableRows.join(''), true);
            }
            return null;
        }
        
        // í•œêµ­ì–´ ê³µë°± ê¸°ë°˜ í…Œì´ë¸”ì„ HTMLë¡œ ë³€í™˜
        function convertKoreanSpaceTableToHTML(tableText) {
            try {
                const lines = tableText.trim().split('\n').filter(line => line.trim());
                const tableRows = [];
                
                console.log('ğŸ”§ Processing Korean space table:', tableText.substring(0, 100));
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    // 4ê°œ ì´ìƒì˜ ì—°ì†ëœ ê³µë°±ìœ¼ë¡œ ì»¬ëŸ¼ êµ¬ë¶„
                    const cells = line.split(/\s{4,}/).map(cell => cell.trim()).filter(cell => cell.length > 0);
                    
                    if (cells.length >= 2) {
                        const tag = i === 0 ? 'th' : 'td';
                        const rowClass = i === 0 ? 'header-row' : '';
                        tableRows.push(`<tr class="${rowClass}">${cells.map(cell => `<${tag}>${escapeHtml(cell)}</${tag}>`).join('')}</tr>`);
                    }
                }
                
                if (tableRows.length > 0) {
                    return createStyledTable(tableRows.join(''));
                }
                
            } catch (e) {
                console.error('í•œêµ­ì–´ ê³µë°± í…Œì´ë¸” ë³€í™˜ ì˜¤ë¥˜:', e);
            }
            return null;
        }
        
        // ë¶€ë¶„ ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸”ì„ HTMLë¡œ ë³€í™˜ (| ìˆì§€ë§Œ ì™„ì „í•˜ì§€ ì•Šì€ í…Œì´ë¸”)
        function convertPartialMarkdownTableToHTML(tableText) {
            try {
                const line = tableText.trim();
                console.log('ğŸ”§ Processing partial markdown table:', line);
                
                // | ê¸°í˜¸ë¡œ ë¶„í• 
                const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell.length > 0);
                
                if (cells.length >= 2) {
                    // ë‹¨ì¼ í–‰ í…Œì´ë¸”ë¡œ ì²˜ë¦¬
                    const tableRow = `<tr>${cells.map(cell => `<td>${escapeHtml(cell)}</td>`).join('')}</tr>`;
                    return createStyledTable(tableRow);
                }
                
            } catch (e) {
                console.error('ë¶€ë¶„ ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ë³€í™˜ ì˜¤ë¥˜:', e);
            }
            return null;
        }
        
        // ìŠ¤íƒ€ì¼ì´ ì ìš©ëœ í…Œì´ë¸” ìƒì„±
        function createStyledTable(tableBody, isKeyValue = false) {
            const uniqueId = 'table_' + Math.random().toString(36).substr(2, 9);
            console.log('ğŸ”§ Creating table with ID:', uniqueId);
            console.log('ğŸ”§ Table body:', tableBody);
            
            // CSSë¥¼ ë™ì ìœ¼ë¡œ í—¤ë“œì— ì¶”ê°€
            const style = document.createElement('style');
            const keyValueStyle = isKeyValue ? `
                #${uniqueId} .key-cell { 
                    background-color: #f8f9fa !important; 
                    font-weight: bold !important; 
                    width: 30% !important; 
                    color: #495057 !important;
                }
                #${uniqueId} .value-cell { 
                    background-color: #ffffff !important; 
                }` : '';
                
            style.textContent = `
                #${uniqueId} {
                    width: 100% !important;
                    border-collapse: collapse !important;
                    font-size: 0.85rem !important;
                    border: 2px solid #dee2e6 !important;
                    border-radius: 8px !important;
                    overflow: hidden !important;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
                    table-layout: auto !important;
                    margin: 0 !important;
                }
                
                #${uniqueId} td, #${uniqueId} th { 
                    border: 1px solid #dee2e6 !important; 
                    padding: 8px 6px !important; 
                    text-align: left !important; 
                    vertical-align: top !important;
                    word-wrap: break-word !important;
                    word-break: break-word !important;
                    max-width: none !important;
                    white-space: normal !important;
                }
                
                #${uniqueId} th, #${uniqueId} .header-row td { 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                    color: white !important; 
                    font-weight: bold !important; 
                    text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
                }
                
                #${uniqueId} tr:nth-child(even):not(.header-row) {
                    background-color: #f8f9fa !important;
                }
                
                #${uniqueId} tr:nth-child(odd):not(.header-row) {
                    background-color: #ffffff !important;
                }
                
                #${uniqueId} tr:hover:not(.header-row) {
                    background-color: #e3f2fd !important;
                    transition: background-color 0.2s ease !important;
                }
                
                ${keyValueStyle}
            `;
            
            // í—¤ë“œì— ìŠ¤íƒ€ì¼ ì¶”ê°€
            document.head.appendChild(style);
            
            const finalHtml = `
                <div style="margin: 15px 0; overflow-x: auto; width: 100%; clear: both;">
                    <table id="${uniqueId}">
                        ${tableBody}
                    </table>
                </div>
            `;
            
            console.log('ğŸ”§ Final table HTML:', finalHtml.substring(0, 300) + '...');
            return finalHtml;
        }

        // ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡
        // ì „ì—­ í•¨ìˆ˜ë¡œ ì •ì˜
        window.sendMessage = async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // ì´ì „ ì‘ì—…ì´ ì§„í–‰ ì¤‘ì´ë©´ ê²½ê³  ë©”ì‹œì§€
            const isProcessing = document.querySelector('.process-card.loading, .process-card.waiting');
            if (isProcessing) {
                const userConfirm = confirm('ì´ì „ ì‘ì—…ì´ ì•„ì§ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. \nìƒˆë¡œìš´ ì§ˆë¬¸ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì´ì „ ì‘ì—…ì€ ì·¨ì†Œë©ë‹ˆë‹¤)');
                if (!userConfirm) {
                    return;
                }
                
                // ì´ì „ ì‘ì—… ì·¨ì†Œ
                console.log('ğŸ“‹ ì´ì „ ì‘ì—… ì·¨ì†Œ ë° ìƒˆë¡œìš´ ì§ˆë¬¸ ì‹œì‘');
                // ëª¨ë“  íƒ€ì´ë¨¸ ì¤‘ì§€
                Object.keys(timerIntervals).forEach(timerId => {
                    clearInterval(timerIntervals[timerId]);
                });
                timerIntervals = {};
            }
            
            currentQuery = message;
            resultCount = 0;
            similarityData = {};
            
            // ì§ˆë¬¸ í‘œì‹œ
            displayUserQuestion(message);
            
            input.value = '';
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            
            // DOM ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ë„ë¡ ê¸°ë‹¤ë¦¼ (ì¹´ë“œë“¤ì´ í™•ì‹¤íˆ ë³´ì´ë„ë¡)
            await new Promise(resolve => setTimeout(resolve, 100));
            await new Promise(resolve => requestAnimationFrame(resolve));
            
            try {
                const summarizeCheckbox = document.getElementById('summarizeCheck');
                const summarize = summarizeCheckbox ? summarizeCheckbox.checked : false;
                
                // ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ë©€í‹° ë²¤ì¹˜ë§ˆí‚¹ìœ¼ë¡œ 4ê°œ í”„ë¡œì„¸ìŠ¤ ì²˜ë¦¬
                executeAllModesStream(message, summarize);
                
            } catch (error) {
                console.error('ì „ì²´ ì˜¤ë¥˜:', error);
                displayGlobalError(`ì „ì²´ ì˜¤ë¥˜: ${error.message}`);
            } finally {
                // 35ì´ˆ í›„ ì…ë ¥ ë‹¤ì‹œ í™œì„±í™” (ë¹„ìƒ ìƒí™©ìš©)
                setTimeout(() => {
                    if (input) input.disabled = false;
                    const btn = document.getElementById('sendBtn');
                    if (btn) btn.disabled = false;
                    console.log('íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì¸í•œ ì…ë ¥ í™œì„±í™”');
                }, 35000);
            }
        };
        
        // ê°œë³„ ëª¨ë“œ ì‹¤í–‰ (ê°œë³„ API ì‚¬ìš©)
        async function executeMode(mode, query, summarize, index) {
            try {
                console.log(`ğŸš€ Executing mode: ${mode} with query: "${query}"`);
                
                // ëª¨ë“œë³„ API ì—”ë“œí¬ì¸íŠ¸ ê²°ì •
                let endpoint;
                if (mode === 'chatgpt-basic') {
                    endpoint = '/api/chat/chatgpt-basic';
                } else if (mode === 'chatgpt-custom') {
                    endpoint = '/api/chat/chatgpt-custom';
                } else if (mode === 'local-basic') {
                    endpoint = '/api/chat/local-basic';
                } else if (mode === 'local-custom') {
                    endpoint = '/api/chat/local-custom';
                } else {
                    displayError(mode, 'ì•Œ ìˆ˜ ì—†ëŠ” ëª¨ë“œì…ë‹ˆë‹¤.', index);
                    return;
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: query
                    })
                });
                
                console.log(`ğŸ“¡ Response status for ${mode}: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log(`ğŸ“„ Result for ${mode}:`, result);
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // ìƒˆë¡œìš´ API í˜•ì‹ì— ë§ì¶° ê²°ê³¼ ë³€í™˜
                const formattedResult = {
                    type: 'single',
                    success: result.success,
                    answer: result.answer,
                    similarity_info: result.similarity_info,
                    total_time: result.total_time,
                    process_name: result.process_name
                };
                
                // ì¦‰ì‹œ í‘œì‹œ (ì™„ë£Œëœ ê²ƒë¶€í„° ë°”ë¡œ í‘œì‹œ)
                displayResult(formattedResult, mode, index);
                
            } catch (error) {
                console.error(`âŒ Error executing ${mode}:`, error);
                displayError(mode, error.message, index);
            }
        }
        
        // ìŠ¤íŠ¸ë¦¬ë° APIë¡œ ì‹¤ì‹œê°„ ì²˜ë¦¬ (ë¹„í™œì„±í™”ë¨ - ìˆœì°¨ ë²¤ì¹˜ë§ˆí‚¹ìœ¼ë¡œ ëŒ€ì²´)
        async function executeStreamingQuery(query, summarize) {
            console.error(`âŒ [STREAMING_QUERY] ì´ í•¨ìˆ˜ëŠ” ë¹„í™œì„±í™”ë˜ì–´ì•¼ í•©ë‹ˆë‹¤! ìˆœì°¨ ë²¤ì¹˜ë§ˆí‚¹ì„ ì‚¬ìš©í•˜ì„¸ìš”.`);
            console.error(`âŒ executeStreamingQuery í˜¸ì¶œë¨, executeAllModesë¡œ ëŒ€ì²´`);
            
            // ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ëŒ€ì²´ ì‹¤í–‰
            return executeAllModesStream(query, summarize);
            
            // ì•„ë˜ëŠ” ë¹„í™œì„±í™”ëœ ê¸°ì¡´ ì½”ë“œ
            try {
                console.log(`ğŸš€ Starting streaming query: "${query}"`);
                
                // íƒ€ì„ì•„ì›ƒ ì„¤ì • (60ì´ˆë¡œ ì¦ê°€)
                window.streamTimeoutId = setTimeout(() => {
                    console.error('â±ï¸ Timeout: No process_complete events received within 60 seconds');
                    // ëª¨ë“  ë¡œë”© ì¤‘ì¸ ì¹´ë“œì— íƒ€ì„ì•„ì›ƒ ì—ëŸ¬ í‘œì‹œ
                    const cardsGroup = document.getElementById(window.currentCardsGroupId);
                    if (cardsGroup) {
                        const loadingCards = cardsGroup.querySelectorAll('.process-card.loading');
                        loadingCards.forEach((card) => {
                            const mode = card.id.split('-')[1] + '-' + card.id.split('-')[2];
                            displayError(mode, 'ì‘ë‹µ ì‹œê°„ ì´ˆê³¼ (60ì´ˆ). ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 0);
                        });
                    }
                }, 60000);
                
                console.log('ğŸ”— Making request to /api/chat/stream...');
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: query,
                        use_memory: false,
                        llm_model: 'gpt-4o-mini',
                        summarize: summarize
                    })
                });
                
                console.log(`ğŸ“¡ Response status: ${response.status} ${response.statusText}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ Response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}${errorText ? ' - ' + errorText : ''}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                console.log('ğŸ‰ Stream completed');
                                if (window.streamTimeoutId) {
                                    clearTimeout(window.streamTimeoutId);
                                }
                                continue;
                            }
                            
                            try {
                                const event = JSON.parse(data);
                                console.log('ğŸ”¸ Raw event data:', data);
                                console.log('ğŸ”¹ Parsed event:', event);
                                handleStreamEvent(event);
                            } catch (e) {
                                console.error('Failed to parse event:', e, 'Data:', data);
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Streaming error:', error);
                // ëª¨ë“  í”„ë¡œì„¸ìŠ¤ì— ì˜¤ë¥˜ í‘œì‹œ
                displayGlobalError(error.message);
            }
        }
        
        // ìŠ¤íŠ¸ë¦¼ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleStreamEvent(event) {
            console.log('ğŸ“¥ Stream event:', event);
            console.log('Event type:', event.type);
            console.log('Process ID:', event.process_id);
            console.log('Status:', event.status);
            
            // process_start ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œ (ì´ë¯¸ ì¹´ë“œê°€ í‘œì‹œë˜ì–´ ìˆìŒ)
            if (event.type === 'all_processes_start' || event.type === 'process_start') {
                console.log('âœ… Process start event - already showing loading cards');
                return;
            }
            
            if (event.type === 'process_complete') {
                console.log('âœ… Process complete event received');
                const mode = getProcessMode(event.process_id);
                
                // ì‚¬ë‚´ì„œë²„ vLLM í”„ë¡œì„¸ìŠ¤ë„ ì •ìƒ ì²˜ë¦¬í•˜ë„ë¡ ë³€ê²½
                console.log(`ğŸ“¨ í”„ë¡œì„¸ìŠ¤ ${event.process_id} (${mode}) ì´ë²¤íŠ¸:`, event.type);
                
                // ChatGPT í”„ë¡œì„¸ìŠ¤ë§Œ ì •ìƒ ì²˜ë¦¬
                const result = {
                    success: event.status === 'success',
                    answer: event.answer || (event.rank_answers && event.rank_answers[0] ? event.rank_answers[0].answer : 'ë‹µë³€ ì—†ìŒ'),
                    similarity_info: event.similarity_info || [],
                    total_time: event.total_time || 0,
                    process_name: event.process_name,
                    chunking_type: event.chunking_type  // chunking_type ì¶”ê°€
                };
                console.log('Calling displayResult with:', result, mode);
                displayResult(result, mode, getCardIndex(event.process_id));
                
            } else if (event.type === 'process_error') {
                console.log('âŒ Process error event received');
                console.log('Error details:', event);
                // í”„ë¡œì„¸ìŠ¤ ì˜¤ë¥˜
                const mode = getProcessMode(event.process_id);
                console.log('Error mode:', mode, 'Message:', event.message || event.error);
                displayError(mode, event.message || event.error || 'Unknown error', getCardIndex(event.process_id));
                
                // íƒ€ì„ì•„ì›ƒ í´ë¦¬ì–´ (ì—ëŸ¬ë„ ì™„ë£Œë¡œ ê°„ì£¼)
                if (window.streamTimeoutId) {
                    clearTimeout(window.streamTimeoutId);
                }
            } else {
                console.log('âš ï¸ Unknown event type:', event.type);
                // ë””ë²„ê¹…ì„ ìœ„í•´ ëª¨ë“  ì´ë²¤íŠ¸ ë‚´ìš© í‘œì‹œ
                console.log('Full event:', JSON.stringify(event, null, 2));
            }
        }
        
        // í”„ë¡œì„¸ìŠ¤ IDë¡œ ëª¨ë“œ ê²°ì • ë° ì¹´ë“œ ì¸ë±ìŠ¤ ê³„ì‚°
        function getProcessMode(processId) {
            const modeMap = {
                1: 'chatgpt-basic',   // ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤ 1 â†’ í”„ë¡ íŠ¸ì—”ë“œ ì¹´ë“œ 2
                2: 'chatgpt-custom',  // ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤ 2 â†’ í”„ë¡ íŠ¸ì—”ë“œ ì¹´ë“œ 3  
                3: 'local-basic',     // ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤ 3 â†’ í”„ë¡ íŠ¸ì—”ë“œ ì¹´ë“œ 0
                4: 'local-custom'     // ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤ 4 â†’ í”„ë¡ íŠ¸ì—”ë“œ ì¹´ë“œ 1
            };
            return modeMap[processId] || 'unknown';
        }
        
        // í”„ë¡œì„¸ìŠ¤ IDë¡œ ì¹´ë“œ ì¸ë±ìŠ¤ ê³„ì‚°
        function getCardIndex(processId) {
            const indexMap = {
                3: 0,  // ì‚¬ë‚´ì„œë²„ vLLM + s3ê¸°ë³¸ â†’ ì¹´ë“œ 0  
                4: 1   // ì‚¬ë‚´ì„œë²„ vLLM + s3-chunking â†’ ì¹´ë“œ 1
            };
            return indexMap[processId] || 0;
        }
        
        // ë‹¨ì¼ ì‚¬ìš©ì ì§ˆë¬¸ í‘œì‹œ
        function displaySingleUserQuestion(question) {
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) return;
            
            // ìƒˆë¡œìš´ QA ê·¸ë£¹ ìƒì„±
            const qaGroup = document.createElement('div');
            qaGroup.className = 'qa-group';
            
            // ì‚¬ìš©ì ì§ˆë¬¸ ì¶”ê°€ (ì˜¤ë¥¸ìª½ ì •ë ¬)
            const userQuestion = document.createElement('div');
            userQuestion.className = 'user-question';
            const summarizeCheckbox = document.getElementById('summarizeCheck');
            const isSummarizeMode = summarizeCheckbox ? summarizeCheckbox.checked : false;
            
            userQuestion.innerHTML = `
                <div class="user-question-content">
                    <div style="margin-bottom: 4px;"><strong>me:</strong> ${question}</div>
                    <div style="font-size: 0.75rem; opacity: 0.9;">
                        ${isSummarizeMode ? 
                            '<span style="background: rgba(40, 167, 69, 0.2); color: #28a745; padding: 2px 6px; border-radius: 3px;">ğŸ“ ìš”ì•½ëª¨ë“œ ON</span>' : 
                            '<span style="background: rgba(0, 123, 255, 0.2); color: #007bff; padding: 2px 6px; border-radius: 3px;">ğŸ“– ì¼ë°˜ëª¨ë“œ</span>'
                        }
                        <span style="margin-left: 8px; opacity: 0.7;">${new Date().toLocaleTimeString()}</span>
                    </div>
                </div>
            `;
            qaGroup.appendChild(userQuestion);
            
            // AI ì‘ë‹µ ë¡œë”© ì¹´ë“œ
            const aiResponse = document.createElement('div');
            aiResponse.className = 'ai-response loading';
            aiResponse.id = 'single-response';
            aiResponse.innerHTML = `
                <div class="ai-response-header">
                    ğŸ¤– DEOTIS RAG Agent
                    <span class="model-badge">ChatGPT-4o</span>
                </div>
                <div class="ai-response-content">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">AIê°€ ë¬¸ì„œë¥¼ ê²€ìƒ‰í•˜ê³  ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                    </div>
                </div>
            `;
            
            qaGroup.appendChild(aiResponse);
            chatHistory.appendChild(qaGroup);
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            scrollToBottom();
        }
        
        // ìŠ¤íŠ¸ë¦¬ë° ë©€í‹° ë²¤ì¹˜ë§ˆí‚¹
        async function executeAllModesStream(query, summarize) {
            try {
                console.log(`ğŸš€ Streaming all modes: "${query}"`);
                
                const requestBody = JSON.stringify({
                    query: query,
                    summarize: summarize,
                    local_model: document.getElementById('localModelSelect').value
                });
                
                const response = await fetch('/api/chat/vllm-dual-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: requestBody
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr === '[DONE]') {
                                console.log('ğŸ“¡ ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì‹ í˜¸ ë°›ìŒ');
                                continue;
                            }
                            try {
                                const data = JSON.parse(dataStr);
                                handleStreamEvent(data);
                            } catch (e) {
                                console.error('Stream parsing error:', e);
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Streaming error:', error);
                displayGlobalError(`ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        function handleStreamEvent(data) {
            console.log('ğŸ“¦ Stream event:', data);
            
            switch (data.type) {
                case 'phase_start':
                    console.log(`ğŸ¯ Phase ${data.phase}:`, data.modes);
                    break;
                    
                case 'process_complete':
                    console.log(`ğŸ“Š Process ${data.process_id} (${data.process_name}) ì™„ë£Œ`);
                    const mode = getProcessMode(data.process_id);
                    const result = {
                        success: data.status === 'success',
                        answer: data.answer || 'ë‹µë³€ ì—†ìŒ',
                        similarity_info: data.similarity_info || [],
                        total_time: data.total_time || 0,
                        process_name: data.process_name,
                        chunking_type: data.chunking_type
                    };
                    console.log('ğŸ“‹ Calling displayResult with:', result, mode);
                    displayResult(result, mode, getCardIndex(data.process_id));
                    break;
                    
                case 'result':
                    console.log(`ğŸ“Š ${data.mode} ì™„ë£Œ`);
                    const cardIndex = getCardIndexByMode(data.mode);
                    displayResult(data.result.result, data.mode, cardIndex);
                    break;
                    
                case 'complete':
                case 'all_complete':
                    console.log('ğŸ‰ ëª¨ë“  ëª¨ë“œ ì™„ë£Œ');
                    setTimeout(() => {
                        const input = document.getElementById('messageInput');
                        const btn = document.getElementById('sendBtn');
                        if (input) input.disabled = false;
                        if (btn) btn.disabled = false;
                    }, 500);
                    break;
                    
                case 'error':
                    displayGlobalError(data.message);
                    break;
            }
        }
        
        function getCardIndexByMode(mode) {
            const modeToCardIndex = {
                'local-basic': 0,
                'local-custom': 1,
                'chatgpt-basic': 2, 
                'chatgpt-custom': 3
            };
            return modeToCardIndex[mode] || 0;
        }
        
        // ê¸°ì¡´ ë°°ì¹˜ ë°©ì‹ (ë°±ì—…)
        async function executeAllModes(query, summarize) {
            try {
                console.log(`\ud83d\ude80 Executing all modes with query: "${query}"`);
                
                // ìŠ¤íŠ¸ë¦¬ë° API í˜¸ì¶œë¡œ ë³€ê²½
                const response = await fetch('/api/chat/vllm-dual-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify({
                        query: query,
                        summarize: summarize,
                        local_model: document.getElementById('localModelSelect').value
                    })
                });
                
                console.log(`\ud83d\udce1 Multi-query response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`\ud83d\udcc4 Multi-query result:`, data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // ê° ëª¨ë“œì— ëŒ€í•œ ê²°ê³¼ ì²˜ë¦¬
                if (data.results && Array.isArray(data.results)) {
                    data.results.forEach((modeResult, index) => {
                        const mode = modeResult.mode;
                        const result = modeResult.result;
                        
                        console.log(`\ud83d\udd04 Processing result for ${mode}:`, result);
                        console.log(`[MODE DEBUG] Success: ${modeResult.success}, Error: ${modeResult.error}`);
                        
                        // ê²°ê³¼ í‘œì‹œ
                        displayResult(result, mode, index);
                    });
                    
                    // ì…ë ¥ ë‹¤ì‹œ í™œì„±í™”
                    setTimeout(() => {
                        const input = document.getElementById('messageInput');
                        const btn = document.getElementById('sendBtn');
                        if (input) input.disabled = false;
                        if (btn) btn.disabled = false;
                        console.log('ëª¨ë“  ê²°ê³¼ ì²˜ë¦¬ ì™„ë£Œ - ì…ë ¥ í™œì„±í™”');
                    }, 1000);
                } else {
                    throw new Error('ë¹„ì–´ìˆì§€ ì•Šê±°ë‚˜ ì˜ëª»ëœ ê²°ê³¼ í˜•ì‹');
                }
                
            } catch (error) {
                console.error('Multi-query error:', error);
                displayGlobalError(`\ubaa8ë“  ëª¨ë“œ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // ëª¨ë“œ ì„¤ì • ê°€ì ¸ì˜¤ê¸° (í†µí•©)
        function getModeConfig(mode) {
            const modeConfigs = {
                'local-basic': { 
                    title: 'ì‚¬ë‚´ì„œë²„ vLLM + s3ê¸°ë³¸', 
                    type: 'local',
                    priority: 3,
                    description: 's3í´ë” ë¬¸ì„œ (Ollama LLaMA)'
                },
                'local-custom': { 
                    title: 'ì‚¬ë‚´ì„œë²„ vLLM + s3-chunking', 
                    type: 'local',
                    priority: 4,
                    description: 's3-chunkingí´ë” ë¬¸ì„œ (Ollama+í–¥ìƒ)'
                }
            };
            return modeConfigs[mode] || { title: mode, type: 'unknown', priority: 0, description: '' };
        }

        // ë¡œë”© ì¹´ë“œ ê°€ì ¸ì˜¤ê¸°
        function getLoadingCard(mode, index) {
            return document.getElementById(`loading-${mode}`);
        }

        // ì‚¬ìš©ì ì§ˆë¬¸ê³¼ 4ê°œ í”„ë¡œì„¸ìŠ¤ ì¹´ë“œ ê·¸ë£¹ ìƒì„±
        function displayUserQuestion(question) {
            const chatHistory = document.getElementById('chatHistory');
            console.log('ğŸ” displayUserQuestion í˜¸ì¶œ, chatHistory:', chatHistory);
            
            if (!chatHistory) {
                console.error('âŒ chatHistory ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            // ìƒˆë¡œìš´ QA ê·¸ë£¹ ìƒì„±
            const qaGroup = document.createElement('div');
            qaGroup.className = 'qa-group';
            console.log('âœ… QA ê·¸ë£¹ ìƒì„±:', qaGroup);
            
            // ì‚¬ìš©ì ì§ˆë¬¸ ì¶”ê°€ (ì˜¤ë¥¸ìª½ ì •ë ¬)
            const userQuestion = document.createElement('div');
            userQuestion.className = 'user-question';
            const summarizeCheckbox = document.getElementById('summarizeCheck');
            const isSummarizeMode = summarizeCheckbox ? summarizeCheckbox.checked : false;
            
            userQuestion.innerHTML = `
                <div class="user-question-content">
                    <div style="margin-bottom: 4px;"><strong>me:</strong> ${question}</div>
                    <div style="font-size: 0.75rem; opacity: 0.9;">
                        ${isSummarizeMode ? 
                            '<span style="background: rgba(40, 167, 69, 0.2); color: #28a745; padding: 2px 6px; border-radius: 3px;">ğŸ“ ìš”ì•½ëª¨ë“œ ON</span>' : 
                            '<span style="background: rgba(0, 123, 255, 0.2); color: #007bff; padding: 2px 6px; border-radius: 3px;">ğŸ“– ì¼ë°˜ëª¨ë“œ</span>'
                        }
                        <span style="margin-left: 8px; opacity: 0.7;">${new Date().toLocaleTimeString()}</span>
                    </div>
                </div>
            `;
            qaGroup.appendChild(userQuestion);
            
            // 4ê°œ í”„ë¡œì„¸ìŠ¤ ì¹´ë“œ ê·¸ë£¹ ìƒì„± (ê°€ë¡œ 1ì¤„)
            const processCardsGroup = document.createElement('div');
            processCardsGroup.className = 'process-cards-group';
            processCardsGroup.id = `cards-group-${Date.now()}`; // ê³ ìœ  ID
            
            const groupTimestamp = Date.now(); // ê·¸ë£¹ë³„ë¡œ ë™ì¼í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš©
            // ì‚¬ìš©ì ìš”ì²­ ìˆœì„œ: ğŸ â†’ğŸ”§
            const allProcesses = [
                {key: 'local-basic', name: 'ì‚¬ë‚´ì„œë²„ vLLM + s3ê¸°ë³¸', desc: 'ê¸°ë³¸ì²­í‚¹ì „ëµ(1500ì/250ì¤‘ì²©)', icon: 'ğŸ ', phase: 1, order: 1},
                {key: 'local-custom', name: 'ì‚¬ë‚´ì„œë²„ vLLM + s3-chunking', desc: 'ì»¤ìŠ¤í…€ ì²­í‚¹ì „ëµ(í–¥ìƒëœ ì§€ì‹)', icon: 'ğŸ”§', phase: 2, order: 2}
            ];
            
            const phase1Processes = allProcesses.filter(p => p.phase === 1);
            const phase2Processes = allProcesses.filter(p => p.phase === 2);
            
            // ìˆœì„œëŒ€ë¡œ ì¹´ë“œ ìƒì„±
            allProcesses.forEach(process => {
                const processCard = document.createElement('div');
                const isPhase1 = process.phase === 1;
                
                processCard.className = isPhase1 ? 'process-card loading' : 'process-card waiting';
                processCard.id = `card-${process.key}-${groupTimestamp}`;
                
                console.log(`ğŸ”§ [PHASE ${process.phase}] ì¹´ë“œ ìƒì„±: ${process.key}, ID: ${processCard.id}`);
                
                if (isPhase1) {
                    // Phase 1 ì¹´ë“œ: ì¦‰ì‹œ ë¡œë”© ì‹œì‘
                    processCard.innerHTML = `
                        <div class="process-card-header">
                            ${process.icon} ${process.name}
                        </div>
                        <div class="process-card-body loading">
                            <div class="loading-container">
                                <div class="process-loading-spinner"></div>
                                <div class="loading-progress" style="margin-top: 15px; font-weight: 500; color: #495057;">
                                    â³ AIê°€ ë¬¸ì„œë¥¼ ê²€ìƒ‰ì¤‘ì…ë‹ˆë‹¤...
                                </div>
                                <div class="loading-timer" id="timer-${process.key}-${groupTimestamp}" style="color: #6c757d; font-size: 0.85rem; margin-top: 8px;">0ì´ˆ ê²½ê³¼</div>
                                <div class="loading-dots" style="margin-top: 10px; color: #667eea;">
                                    <span>â—</span><span>â—</span><span>â—</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Phase 2 ì¹´ë“œ: ëŒ€ê¸° ì¤‘
                    processCard.innerHTML = `
                        <div class="process-card-header">
                            ${process.icon} ${process.name}
                        </div>
                        <div class="process-card-body waiting">
                            <div class="waiting-container">
                                <div class="waiting-icon" style="font-size: 2rem; color: #ffa500; text-align: center;">â³</div>
                                <div class="waiting-message" style="margin-top: 15px; font-weight: 500; color: #495057; text-align: center;">
                                    ì´ì „ ì‘ì—… ì¢…ë£Œ ëŒ€ê¸°ì¤‘...
                                </div>
                                <div class="waiting-timer" id="timer-${process.key}-${groupTimestamp}" style="color: #6c757d; font-size: 0.85rem; margin-top: 8px; text-align: center;">ëŒ€ê¸° ì¤‘</div>
                            </div>
                        </div>
                    `;
                }
                
                processCardsGroup.appendChild(processCard);
                console.log(`âœ… ì¹´ë“œ ì¶”ê°€ë¨: ${process.order}ë²ˆ ${process.key}`);
            });
            
            // Phase 1 ì¹´ë“œë“¤ì˜ íƒ€ì´ë¨¸ ì‹œì‘
            phase1Processes.forEach(process => {
                console.log(`â±ï¸ [PHASE 1] íƒ€ì´ë¨¸ ì‹œì‘: ${process.key}`);
                startProcessTimer(process.key, groupTimestamp);
            });
            
            qaGroup.appendChild(processCardsGroup);
            chatHistory.appendChild(qaGroup);
            console.log('ğŸ¯ QA ê·¸ë£¹ì´ chatHistoryì— ì¶”ê°€ë¨');
            
            // DOM ê°•ì œ ë¦¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
            processCardsGroup.offsetHeight;
            
            // í˜„ì¬ ì¹´ë“œ ê·¸ë£¹ IDë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥
            window.currentCardsGroupId = processCardsGroup.id;
            console.log('ğŸ’¾ í˜„ì¬ ì¹´ë“œ ê·¸ë£¹ ID ì €ì¥:', window.currentCardsGroupId);
            
            // ì¹´ë“œë“¤ì´ ì œëŒ€ë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
            setTimeout(() => {
                const cards = processCardsGroup.querySelectorAll('.process-card');
                console.log(`ğŸ” ìƒì„±ëœ ì¹´ë“œ ìˆ˜: ${cards.length}`);
                cards.forEach((card, index) => {
                    const rect = card.getBoundingClientRect();
                    console.log(`ğŸ“ ì¹´ë“œ ${index + 1} í¬ê¸°: ${rect.width}x${rect.height}`);
                    if (rect.height === 0) {
                        console.error(`âŒ ì¹´ë“œ ${index + 1}ì´ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤!`);
                        // ê°•ì œë¡œ ìŠ¤íƒ€ì¼ ì ìš©
                        card.style.display = 'block';
                        card.style.minHeight = '200px';
                        card.style.opacity = '1';
                        card.style.visibility = 'visible';
                    }
                });
            }, 50);
            
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            scrollToBottom();
            
            // ì´ë¯¸ Phase 1 íƒ€ì´ë¨¸ëŠ” ìœ„ì—ì„œ ì‹œì‘ë¨
            // ì¶”ê°€ë¡œ ì‹œì‘í•  íƒ€ì´ë¨¸ ì—†ìŒ
            console.log('ğŸ† displayUserQuestion ì™„ë£Œ');
        }

        // í”„ë¡œì„¸ìŠ¤ íƒ€ì´ë¨¸ ì‹œì‘
        function startProcessTimer(processKey, timestamp) {
            const timerKey = `${processKey}-${timestamp}`;
            const timerId = `timer-${timerKey}`;
            
            processTimers[timerKey] = setInterval(() => {
                const timerElement = document.getElementById(timerId);
                if (timerElement) {
                    const currentTime = parseFloat(timerElement.textContent) || 0;
                    timerElement.textContent = `${(currentTime + 0.1).toFixed(1)}ì´ˆ`;
                }
            }, 100); // 0.1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        }
        
        // í”„ë¡œì„¸ìŠ¤ íƒ€ì´ë¨¸ ì¤‘ì§€
        function stopProcessTimer(processKey, timestamp) {
            const timerKey = `${processKey}-${timestamp}`;
            if (processTimers[timerKey]) {
                clearInterval(processTimers[timerKey]);
                delete processTimers[timerKey];
            }
        }
        
        // ì „ì—­ ì˜¤ë¥˜ ì²˜ë¦¬
        function displayGlobalError(errorMessage) {
            console.error('Global error:', errorMessage);
            // ëª¨ë“  ë¡œë”© ì¤‘ì¸ ì¹´ë“œì— ì˜¤ë¥˜ í‘œì‹œ
            const cardsGroup = document.getElementById(window.currentCardsGroupId);
            if (cardsGroup) {
                const loadingCards = cardsGroup.querySelectorAll('.process-card.loading');
                loadingCards.forEach((card, index) => {
                    const mode = ['local-basic', 'local-custom', 'chatgpt-basic', 'chatgpt-custom'][index];
                    displayError(mode, errorMessage, index);
                });
            }
        }
        
        // ìŠ¤í¬ë¡¤ í•¨ìˆ˜
        function scrollToBottom() {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // ì „ì—­ ì˜¤ë¥˜ í‘œì‹œ í•¨ìˆ˜
        function displayGlobalError(message) {
            const resultsGrid = document.getElementById('resultsGrid');
            if (resultsGrid) {
                resultsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #e74c3c; background: #fff; border-radius: 12px; border: 2px solid #e74c3c;">
                        <h3>âŒ ì˜¤ë¥˜ ë°œìƒ</h3>
                        <p>${message}</p>
                        <button onclick="location.reload()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                `;
            }
            
            // ì…ë ¥ ë‹¤ì‹œ í™œì„±í™”
            setTimeout(() => {
                const input = document.getElementById('messageInput');
                const btn = document.getElementById('sendBtn');
                if (input) input.disabled = false;
                if (btn) btn.disabled = false;
            }, 1000);
        }
        
        // ì˜¤ë¥˜ë¥¼ í•´ë‹¹ ì¹´ë“œì— í‘œì‹œ
        function displayError(mode, errorMessage, index) {
            // í˜„ì¬ ì¹´ë“œ ê·¸ë£¹ì—ì„œ í•´ë‹¹ ì¹´ë“œ ì°¾ê¸°
            const cardsGroup = document.getElementById(window.currentCardsGroupId);
            if (!cardsGroup) {
                console.error('Cards group not found for error:', window.currentCardsGroupId);
                return;
            }
            
            // ëª¨ë“œì— ë”°ë¥¸ ì¹´ë“œ ì¸ë±ìŠ¤ ê²°ì • (ìƒˆë¡œìš´ ìˆœì„œ: ğŸ â†’ğŸ”§)
            const modeIndex = {
                'local-basic': 0,     // 1ë²ˆ: ğŸ  ì‚¬ë‚´ì„œë²„ vLLM + s3ê¸°ë³¸
                'local-custom': 1     // 2ë²ˆ: ğŸ”§ ì‚¬ë‚´ì„œë²„ vLLM + s3-chunking
            };
            
            const cardIndex = modeIndex[mode];
            if (cardIndex === undefined) {
                console.error('Unknown mode for error:', mode);
                return;
            }
            
            const processCard = cardsGroup.children[cardIndex];
            if (!processCard) {
                console.error('Process card not found for error at index:', cardIndex);
                return;
            }
            
            // íƒ€ì´ë¨¸ ì¤‘ì§€
            const cardId = processCard.id;
            const timestamp = cardId.split('-').pop();
            stopProcessTimer(mode, timestamp);
            
            // ë¡œë”© ìƒíƒœ ì œê±° ë° ì˜¤ë¥˜ ìƒíƒœ ì¶”ê°€
            processCard.classList.remove('loading');
            processCard.classList.add('error');
            
            const cardBody = processCard.querySelector('.process-card-body');
            cardBody.classList.remove('loading');
            
            let html = `
                <div style="color: #dc3545; margin-bottom: 1rem;">
                    âŒ ${errorMessage}
                </div>
            `;
            
            // ì‚¬ë‚´ì„œë²„ vLLM ì˜¤ë¥˜ì¸ ê²½ìš° í•´ê²°ë°©ë²• ì¶”ê°€
            if (mode.includes('local')) {
                html += `
                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,193,7,0.1); border-radius: 8px; border-left: 3px solid #ffc107;">
                        <div style="font-weight: bold; color: #f57c00; margin-bottom: 0.5rem;">
                            ğŸ› ï¸ í•´ê²°ë°©ë²•
                        </div>
                        <div style="font-size: 0.8rem; color: #6c757d;">
                            1. ì‚¬ë‚´ì„œë²„ vLLM ìƒíƒœ í™•ì¸: 192.168.0.224:8412<br>
                            2. vLLM ì„œë²„ ì¬ì‹œì‘ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ<br>
                            3. kanana8b ëª¨ë¸ ë¡œë”© ìƒíƒœ í™•ì¸
                        </div>
                    </div>
                `;
            }
            
            html += `
                <div class="process-meta error">
                    <div class="status-badge error">
                        <span>âŒ ì‹¤íŒ¨</span>
                        <span style="color: #6c757d; font-size: 0.8rem; margin-left: 0.5rem;">
                            ğŸ“‚ ${mode.includes('basic') ? 's3ê¸°ë³¸' : 's3-chunking'}
                        </span>
                    </div>
                    <div class="time-badge">
                        â±ï¸ 0.00ì´ˆ
                    </div>
                </div>
            `;
            
            cardBody.innerHTML = html;
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            scrollToBottom();
            
            // ê²°ê³¼ ì¹´ìš´íŠ¸ ì¦ê°€
            resultCount++;
            
            // ëª¨ë“  ê²°ê³¼ ì™„ë£Œì‹œ ì…ë ¥ ë‹¤ì‹œ í™œì„±í™”
            if (resultCount >= 4) {
                setTimeout(() => {
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                }, 1000);
            }
        }
        
        // ì¤‘ë³µ ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜ ì œê±°ë¨
        
        // ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
        function clearResultsArea() {
            document.getElementById('resultsGrid').innerHTML = '';
        }
        
        // ë¡œë”© ì¹´ë“œë“¤ ìƒì„±
        function createLoadingCards() {
            const grid = document.getElementById('resultsGrid');
            const modes = [
                { key: 'local-basic', title: 'ì‚¬ë‚´ì„œë²„ vLLM + ê¸°ë³¸ì²­í‚¹ì „ëµ(1500ì ë‚˜ëˆ„ê¸° 250ì¤‘ì²©)(s3 í´ë”)', icon: 'ğŸ ' },
                { key: 'local-custom', title: 'ì‚¬ë‚´ì„œë²„ vLLM + ì»¤ìŠ¤í…€ ì²­í‚¹ì „ëµ(1500ì ë‚˜ëˆ„ê¸° 250ì¤‘ì²©)(s3-chunking í´ë”)', icon: 'ğŸ”§' }
            ];
            
            modes.forEach((mode, index) => {
                const loadingCard = `
                    <div class="loading-card" id="loading-${mode.key}">
                        <div class="loading-spinner"></div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">${mode.title}</div>
                            <div style="color: #666; font-size: 0.9rem;">ë‹µë³€ ìƒì„± ì¤‘...</div>
                        </div>
                    </div>
                `;
                grid.insertAdjacentHTML('beforeend', loadingCard);
            });
        }
        
        // ê²°ê³¼ë¥¼ í•´ë‹¹ ì¹´ë“œì— í‘œì‹œ
        function displayResult(result, mode, originalIndex) {
            // í˜„ì¬ ì¹´ë“œ ê·¸ë£¹ì—ì„œ í•´ë‹¹ ì¹´ë“œ ì°¾ê¸°
            const cardsGroup = document.getElementById(window.currentCardsGroupId);
            if (!cardsGroup) {
                console.error('Cards group not found:', window.currentCardsGroupId);
                return;
            }
            
            // ëª¨ë“œì— ë”°ë¥¸ ì¹´ë“œ ì¸ë±ìŠ¤ ê²°ì • (ìƒˆë¡œìš´ ìˆœì„œ: ğŸ â†’ğŸ”§)
            const modeIndex = {
                'local-basic': 0,     // 1ë²ˆ: ğŸ  ì‚¬ë‚´ì„œë²„ vLLM + s3ê¸°ë³¸
                'local-custom': 1     // 2ë²ˆ: ğŸ”§ ì‚¬ë‚´ì„œë²„ vLLM + s3-chunking
            };
            
            const cardIndex = modeIndex[mode];
            if (cardIndex === undefined) {
                console.error('Unknown mode:', mode);
                return;
            }
            
            const processCard = cardsGroup.children[cardIndex];
            if (!processCard) {
                console.error('Process card not found for index:', cardIndex);
                return;
            }
            
            // Phase 2 ì¹´ë“œê°€ ì‹œì‘í•  ë•Œ waiting ìƒíƒœì—ì„œ loadingìœ¼ë¡œ ì „í™˜
            if (processCard.classList.contains('waiting')) {
                console.log(`ğŸ”„ [PHASE 2] ${mode} ì‹œì‘ - waitingì—ì„œ loadingìœ¼ë¡œ ì „í™˜`);
                processCard.classList.remove('waiting');
                processCard.classList.add('loading');
                
                const cardBody = processCard.querySelector('.process-card-body');
                cardBody.classList.remove('waiting');
                cardBody.classList.add('loading');
                
                const timestamp = processCard.id.split('-').pop();
                // waiting ë‚´ìš©ì„ loading ë‚´ìš©ìœ¼ë¡œ ì „í™˜ (0ì´ˆë¶€í„° ì‹œì‘)
                cardBody.innerHTML = `
                    <div class="loading-container">
                        <div class="process-loading-spinner"></div>
                        <div class="loading-progress" style="margin-top: 15px; font-weight: 500; color: #495057;">
                            â³ AIê°€ ë¬¸ì„œë¥¼ ê²€ìƒ‰ì¤‘ì…ë‹ˆë‹¤...
                        </div>
                        <div class="loading-timer" id="timer-${mode}-${timestamp}" style="color: #6c757d; font-size: 0.85rem; margin-top: 8px;">0.0ì´ˆ ê²½ê³¼</div>
                        <div class="loading-dots" style="margin-top: 10px; color: #667eea;">
                            <span>â—</span><span>â—</span><span>â—</span>
                        </div>
                    </div>
                `;
                
                // Phase 2 íƒ€ì´ë¨¸ 0ì´ˆë¶€í„° ì‹œì‘
                console.log(`â° [PHASE 2] ${mode} íƒ€ì´ë¨¸ 0ì´ˆë¶€í„° ì‹œì‘`);
                startProcessTimer(mode, timestamp);
            }
            
            // íƒ€ì´ë¨¸ ì¤‘ì§€
            const cardId = processCard.id;
            const timestamp = cardId.split('-').pop();
            stopProcessTimer(mode, timestamp);
            
            // ë¡œë”© ìƒíƒœ ì œê±°
            processCard.classList.remove('loading');
            
            const cardBody = processCard.querySelector('.process-card-body');
            cardBody.classList.remove('loading');
            
            if (result.success) {
                // ì„±ê³µí•œ ê²½ìš°
                processCard.classList.add('success');
                
                let html = `
                    <div style="margin-bottom: 1rem; line-height: 1.6;">
                        ${formatText(result.answer) || 'ë‹µë³€ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}
                    </div>
                `;
                
                // ì¶”ì²œ ì§ˆë¬¸ í‘œì‹œ (ìœ ì‚¬ë„ 80% ë¯¸ë§Œì‹œ)
                if (result.suggested_questions && result.suggested_questions.length > 0) {
                    html += `
                        <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                            <div style="font-weight: 500; margin-bottom: 0.5rem; color: #007bff;">ğŸ’¡ ì´ëŸ° ì§ˆë¬¸ë“¤ì€ ì–´ë– ì‹ ê°€ìš”?</div>
                            ${result.suggested_questions.map(q => `
                                <div style="margin: 0.3rem 0; cursor: pointer; color: #007bff; text-decoration: underline;" onclick="askSuggestedQuestion('${q.replace(/'/g, "\\'")}')">
                                    â€¢ ${q}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // ìœ ì‚¬ë„ ì •ë³´ ì¶”ê°€
                if (result.similarity_info && result.similarity_info.length > 0) {
                    const topScore = result.similarity_info[0].score;
                    html += `
                        <div class="similarity-info">
                            <div class="similarity-title">
                                ğŸ” ìœ ì‚¬ë„ ${topScore} (ìƒìœ„ ${result.similarity_info.length}ê°œ)
                            </div>
                            ${result.similarity_info.map(item => `
                                <div class="similarity-item">
                                    <div class="similarity-rank">
                                        <strong>ìˆœìœ„ ${item.rank}: ${item.score}</strong>
                                        <span style="font-size: 0.8rem; color: #6c757d;">
                                            ğŸ“„ ${item.source || 'Unknown'}
                                        </span>
                                    </div>
                                    <div class="similarity-content">
                                        ${item.content_preview || 'ë‚´ìš© ì—†ìŒ'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // ì²˜ë¦¬ ì‹œê°„ ë° ìƒíƒœ ì •ë³´
                html += `
                    <div class="process-meta">
                        <div class="status-badge success">
                            <span>âœ… ì„±ê³µ</span>
                            <span style="color: #6c757d; font-size: 0.8rem; margin-left: 0.5rem;">
                                ğŸ“‚ ${result.chunking_type === 'basic' ? 's3ê¸°ë³¸' : 's3-chunking'} (${result.chunking_type || 'undefined'})
                            </span>
                        </div>
                        <div class="time-badge">
                            â±ï¸ ${parseFloat(result.response_time || result.total_time || 0).toFixed(3)}ì´ˆ
                        </div>
                    </div>
                `;
                
                cardBody.innerHTML = html;
                
            } else {
                // ì‹¤íŒ¨í•œ ê²½ìš°
                processCard.classList.add('error');
                
                let html = `
                    <div style="color: #dc3545; margin-bottom: 1rem;">
                        âŒ ${result.answer || 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}
                    </div>
                `;
                
                // ì‚¬ë‚´ì„œë²„ vLLM ì˜¤ë¥˜ì¸ ê²½ìš° í•´ê²°ë°©ë²• ì¶”ê°€
                if (mode.includes('local')) {
                    html += `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,193,7,0.1); border-radius: 8px; border-left: 3px solid #ffc107;">
                            <div style="font-weight: bold; color: #f57c00; margin-bottom: 0.5rem;">
                                ğŸ› ï¸ í•´ê²°ë°©ë²•
                            </div>
                            <div style="font-size: 0.8rem; color: #6c757d;">
                                1. í„°ë¯¸ë„ì—ì„œ "ollama serve" ëª…ë ¹ ì‹¤í–‰<br>
                                2. "ollama list"ë¡œ ëª¨ë¸ í™•ì¸<br>
                                3. ëª¨ë¸ ì—†ìœ¼ë©´ "ollama pull llama2" ë¡œ ì„¤ì¹˜
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="process-meta error">
                        <div class="status-badge error">
                            <span>âŒ ì‹¤íŒ¨</span>
                            <span style="color: #6c757d; font-size: 0.8rem; margin-left: 0.5rem;">
                                ğŸ“‚ ${result.chunking_type === 'basic' ? 's3ê¸°ë³¸' : 's3-chunking'} (${result.chunking_type || 'undefined'})
                            </span>
                        </div>
                        <div class="time-badge">
                            â±ï¸ ${parseFloat(result.response_time || result.total_time || 0).toFixed(3)}ì´ˆ
                        </div>
                    </div>
                `;
                
                cardBody.innerHTML = html;
            }
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            scrollToBottom();
            
            // ê²°ê³¼ ì¹´ìš´íŠ¸ ì¦ê°€
            resultCount++;
            
            // ëª¨ë“  ê²°ê³¼ ì™„ë£Œì‹œ ì…ë ¥ ë‹¤ì‹œ í™œì„±í™”
            if (resultCount >= 4) {
                setTimeout(() => {
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                }, 1000);
            }
        }
        
        // ì¤‘ë³µ ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜ ì œê±°ë¨
        
        // ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
        function clearResultsArea() {
            document.getElementById('resultsGrid').innerHTML = '';
        }
        
        // ë¡œë”© ì¹´ë“œë“¤ ìƒì„±
        function createLoadingCards() {
            const grid = document.getElementById('resultsGrid');
            const modes = [
                { key: 'local-basic', title: 'ì‚¬ë‚´ì„œë²„ vLLM + ê¸°ë³¸ì²­í‚¹ì „ëµ(1500ì ë‚˜ëˆ„ê¸° 250ì¤‘ì²©)(s3 í´ë”)', icon: 'ğŸ ' },
                { key: 'local-custom', title: 'ì‚¬ë‚´ì„œë²„ vLLM + ì»¤ìŠ¤í…€ ì²­í‚¹ì „ëµ(1500ì ë‚˜ëˆ„ê¸° 250ì¤‘ì²©)(s3-chunking í´ë”)', icon: 'ğŸ”§' }
            ];
            
            modes.forEach((mode, index) => {
                const loadingCard = `
                    <div class="loading-card" id="loading-${mode.key}">
                        <div class="loading-spinner"></div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">${mode.title}</div>
                            <div style="color: #666; font-size: 0.9rem;">ë‹µë³€ ìƒì„± ì¤‘...</div>
                        </div>
                    </div>
                `;
                grid.insertAdjacentHTML('beforeend', loadingCard);
            });
        }
        
        // ì´ í•¨ìˆ˜ëŠ” ì¹´ë“œ ë ˆì´ì•„ì›ƒì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ìœ„ì˜ displayResult í•¨ìˆ˜ ì‚¬ìš©)
        
        // ì¤‘ë³µëœ ë©”ì‹œì§€ ê´€ë ¨ í•¨ìˆ˜ë“¤ ì œê±°ë¨
        
        // ì´ ì±„íŒ… ë²„ì „ì˜ displayError í•¨ìˆ˜ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ìœ„ì˜ ì¹´ë“œ ë²„ì „ ì‚¬ìš©)
        
        // í˜„ì¬ ì„¸ì…˜ ì €ì¥
        function saveCurrentSession() {
            if (currentQuery) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                
                const newSession = {
                    id: Date.now(),
                    question: currentQuery.length > 40 ? currentQuery.substring(0, 40) + '...' : currentQuery,
                    fullQuestion: currentQuery,
                    timestamp: now.toISOString(),
                    displayTime: timeString,
                    resultCount: resultCount
                };
                
                chatSessions.unshift(newSession);
                
                // ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ ì €ì¥
                if (chatSessions.length > 20) {
                    chatSessions = chatSessions.slice(0, 20);
                }
                
                localStorage.setItem('chatSessions', JSON.stringify(chatSessions));
                updateSidebarHistory();
            }
        }
        
        // ì‚¬ì´ë“œë°” íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
        function updateSidebarHistory() {
            const sidebar = document.getElementById('historySidebar');
            if (!sidebar) return;
            
            // chatSessionsê°€ ë°°ì—´ì¸ì§€ í™•ì¸
            if (!Array.isArray(chatSessions)) {
                console.error('chatSessions is not an array:', chatSessions);
                chatSessions = [];
            }
            
            if (chatSessions.length === 0) {
                sidebar.innerHTML = `
                    <div style="text-align: center; color: #666; font-style: italic; padding: 1rem;">
                        ì±„íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤
                    </div>
                `;
                return;
            }
            
            sidebar.innerHTML = chatSessions.map((session, index) => `
                <div class="history-item-sidebar ${index === 0 ? 'active' : ''}" onclick="loadSession(${index})">
                    <div class="history-question">${session.question}</div>
                    <div class="history-meta">
                        <span>${session.resultCount}ê°œ ê²°ê³¼</span>
                        <span>${new Date(session.timestamp).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }
        
        function loadSession(index) {
            const session = chatSessions[index];
            document.getElementById('messageInput').value = session.fullQuestion;
        }
        
        // ë¡œë”© ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ì¹´ë“œ ë ˆì´ì•„ì›ƒì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
        
        // ê´€ë¦¬ì íŒ¨ë„
        function showAdminPanel() {
            document.getElementById('adminPanel').style.display = 'block';
        }
        
        function hideAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }

        // ì‹œìŠ¤í…œ ì´ˆê¸°í™” í•¨ìˆ˜
        async function initializeSystem() {
            if (!confirm('âš ï¸ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ê³  ë¬¸ì„œê°€ ë‹¤ì‹œ ë¡œë“œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            // ê´€ë¦¬ì íŒ¨ë„ ìˆ¨ê¸°ê³  ì´ˆê¸°í™” íŒì—… í‘œì‹œ
            hideAdminPanel();
            document.getElementById('initializationPopup').style.display = 'block';

            try {
                // 1ë‹¨ê³„: ëª¨ë“  ë°ì´í„° ì‚­ì œ
                document.getElementById('step1').style.display = 'flex';
                await fetch('/api/admin/clear-all', { method: 'DELETE' });

                // 2ë‹¨ê³„: ë¬¸ì„œ ë¡œë“œ
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'flex';

                // 3ë‹¨ê³„: ì„ë² ë”© ìƒì„± (ë¡œë“œì™€ í•¨ê»˜ ì§„í–‰ë¨)
                document.getElementById('step2').style.display = 'none';
                document.getElementById('step3').style.display = 'flex';

                const response = await fetch('/api/admin/reload-documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clear_all: true })
                });

                const result = await response.json();

                // ì™„ë£Œ í‘œì‹œ
                document.getElementById('step3').style.display = 'none';
                document.getElementById('stepComplete').style.display = 'flex';
                document.getElementById('initializationResult').style.display = 'block';

                console.log('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ:', result);

            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                closeInitializationPopup();
            }
        }

        // ë¬¸ì„œë§Œ ë‹¤ì‹œ ë¡œë“œ
        async function reloadDocuments() {
            if (!confirm('ë¬¸ì„œë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            hideAdminPanel();
            
            try {
                const response = await fetch('/api/admin/reload-documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clear_all: false })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    alert(`ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ!\n- ë¡œë“œëœ ë¬¸ì„œ: ${result.documents_loaded}ê°œ\n- ìƒì„±ëœ ì²­í¬: ${result.total_chunks}ê°œ`);
                } else {
                    alert('ë¬¸ì„œ ë¡œë“œ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                alert('ë¬¸ì„œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì´ˆê¸°í™” íŒì—… ë‹«ê¸°
        function closeInitializationPopup() {
            document.getElementById('initializationPopup').style.display = 'none';
            // íŒì—… ìƒíƒœ ì´ˆê¸°í™”
            document.querySelectorAll('.init-step').forEach(step => step.style.display = 'none');
            document.getElementById('initializationResult').style.display = 'none';
        }

        // ë²¡í„°DB ìƒíƒœ í™•ì¸
        async function checkVectorDBStatus() {
            try {
                const response = await fetch('/api/system-status');
                const data = await response.json();

                if (data.status === 'success' && data.system_status) {
                    const vectordb = data.system_status.vectordb;
                    const documents = data.system_status.documents;

                    // ë²¡í„°DBê°€ ë¹„ì–´ìˆê±°ë‚˜ ë¬¸ì„œê°€ ì—†ëŠ” ê²½ìš° ì´ˆê¸°í™” ê¶Œì¥ íŒì—… í‘œì‹œ
                    if (!vectordb.available || vectordb.doc_count === 0 || !documents.available) {
                        setTimeout(showInitializationRecommendation, 1000); // 1ì´ˆ í›„ í‘œì‹œ
                    }
                }
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì´ˆê¸°í™” ê¶Œì¥ íŒì—… í‘œì‹œ
        function showInitializationRecommendation() {
            const popup = document.createElement('div');
            popup.className = 'admin-panel';
            popup.id = 'initRecommendationPopup';
            popup.innerHTML = `
                <div class="admin-content" style="max-width: 500px;">
                    <h3>ğŸ“‹ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ê¶Œì¥</h3>
                    <p style="margin: 1rem 0; line-height: 1.6;">
                        ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.<br>
                        S3 í´ë”ì—ì„œ ë¬¸ì„œë¥¼ ë¡œë“œí•˜ì—¬ ì±„íŒ…ì„ ì‹œì‘í•˜ì„¸ìš”.
                    </p>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                        <button onclick="startInitialization()" style="padding: 0.8rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                            ğŸ“¥ ì§€ê¸ˆ ì´ˆê¸°í™”í•˜ê¸°
                        </button>
                        <button onclick="dismissInitRecommendation()" style="padding: 0.8rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                            ë‚˜ì¤‘ì— í•˜ê¸°
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // ì´ˆê¸°í™” ê¶Œì¥ íŒì—…ì—ì„œ ì´ˆê¸°í™” ì‹œì‘
        function startInitialization() {
            dismissInitRecommendation();
            initializeSystem();
        }

        // ì´ˆê¸°í™” ê¶Œì¥ íŒì—… ë‹«ê¸°
        function dismissInitRecommendation() {
            const popup = document.getElementById('initRecommendationPopup');
            if (popup) {
                popup.remove();
            }
        }

        // ì¶”ì²œ ì§ˆë¬¸ í´ë¦­ì‹œ ìë™ ì§ˆë¬¸
        function askSuggestedQuestion(question) {
            console.log('ğŸ¤” ì¶”ì²œ ì§ˆë¬¸ í´ë¦­:', question);
            
            // ì…ë ¥ì°½ì— ì§ˆë¬¸ ì„¤ì •
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.value = question;
                
                // ìë™ìœ¼ë¡œ ì „ì†¡
                setTimeout(() => {
                    window.sendMessage();
                }, 100);
            }
        }
        
        // ì´ˆê¸°í™”
        function initializeApp() {
            updateSidebarHistory();
            
            // Enter í‚¤ ì´ë²¤íŠ¸
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            console.log('sendMessage í•¨ìˆ˜ í™•ì¸:', typeof window.sendMessage);
            
            initializeApp();
            
            // ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ë° í•„ìš”ì‹œ ì´ˆê¸°í™” íŒì—… í‘œì‹œ
            checkVectorDBStatus();
            
            // ì „ì†¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) {
                sendBtn.addEventListener('click', function() {
                    console.log('ğŸ”˜ ì „ì†¡ ë²„íŠ¼ í´ë¦­ë¨');
                    window.sendMessage();
                });
                console.log('âœ… ì „ì†¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë¨');
            } else {
                console.error('âŒ ì „ì†¡ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            // ì—”í„°í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        console.log('âŒ¨ï¸ ì—”í„°í‚¤ ëˆŒë¦¼');
                        window.sendMessage();
                    }
                });
                console.log('âœ… ì—”í„°í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë¨');
            } else {
                console.error('âŒ ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
        });
    </script>
</body>
</html>
