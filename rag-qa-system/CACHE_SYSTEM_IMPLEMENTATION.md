# 🔧 새로운 캐시 시스템 구현 가이드

## 📋 요구사항 정리

### ✅ 완료된 작업
1. **질문별 검색 횟수 카운팅 시스템** 구현
2. **5회 이상 시 Redis → RDB 이동 로직** 구현  
3. **답변에 검색 경로 표기 기능** 추가
4. **프론트엔드 UI 개선** (검색 경로 표시)

### ❌ 미완료/문제 상황
1. **전체 캐시 초기화 실패** - RDB가 완전히 삭제되지 않음
2. **전체 대화 초기화 누락** - 대화 기록도 함께 삭제되어야 함

## 🔍 현재 문제점

### 1. 전체 캐시 초기화 미작동
```bash
# 현재 상황
전체 캐시 초기화 → 새로고침 → 바로 응답 나옴 (RDB에서)
```

**원인:** `clear_all()` 함수가 실제로 RDB를 완전히 삭제하지 못함

### 2. 대화 기록 초기화 누락
전체 캐시 초기화 시 채팅 대화도 함께 삭제되어야 함

## 🛠️ 수정해야 할 파일들

### 1. `services/hybrid_cache_manager.py`
- `clear_all()` 함수 개선
- RDB 완전 삭제 확인
- 대화 기록 삭제 추가

### 2. `templates/modern_index.html`
- 전체 캐시 초기화 시 대화창 초기화
- 초기화 완료 후 페이지 새로고침

### 3. 추가 확인 사항
- `data/cache/popular_cache.db` 파일 직접 확인
- SQLite 테이블 완전 삭제 검증
- Redis 연결 상태 확인

## 🔨 수정 작업 목록

### Step 1: 전체 캐시 초기화 함수 완전 수정
```python
def clear_all(self):
    """모든 캐시 완전 삭제 (Redis + RDB + 대화기록)"""
    # 1. Redis 완전 삭제
    # 2. RDB 파일 완전 삭제 또는 테이블 DROP
    # 3. 대화 세션 삭제
    # 4. 검색 카운터 완전 초기화
```

### Step 2: 프론트엔드 대화 초기화
```javascript
function clearAllCache() {
    // 1. 서버 캐시 삭제 API 호출
    // 2. 로컬 대화 세션 삭제
    // 3. 대화창 초기화
    // 4. 페이지 새로고침
}
```

### Step 3: 검증 스크립트 작성
```python
def verify_cache_clear():
    """캐시 삭제 검증"""
    # 1. Redis 키 개수 확인
    # 2. RDB 테이블 행 개수 확인  
    # 3. 파일 존재 여부 확인
```

## 📊 새로운 캐시 시스템 동작 원리

### 검색 흐름
```
질문 입력
    ↓
검색 횟수 증가 (전체 카운팅)
    ↓
1. RDB 확인 (5회 이상)
    ├── 있음 → RDB 응답
    └── 없음 → 2단계
    ↓
2. Redis 확인 (1~4회)  
    ├── 있음 → Redis 응답
    │   └── 5회 도달 시 RDB 이동
    └── 없음 → 3단계
    ↓
3. RAG 실시간 검색
    ↓
Redis에 저장 (1회 시작)
```

### 캐시 초기화 흐름
```
전체 캐시 초기화 버튼
    ↓
1. Redis 모든 키 삭제
2. RDB 모든 테이블 DROP/DELETE  
3. 검색 카운터 초기화
4. 대화 세션 삭제
5. 프론트엔드 새로고침
    ↓
완전 초기 상태
```

## 🧪 테스트 시나리오

### 테스트 1: 완전 초기화
```bash
1. 전체 캐시 초기화 실행
2. 새로고침
3. 질문 입력 → RAG 실시간 검색 확인
4. 대화창 완전 초기화 확인
```

### 테스트 2: 5회 검색 흐름
```bash
1. 동일 질문 5회 검색
2. 1~4회: Redis 응답 확인  
3. 5회: RDB 이동 확인
4. 6회: RDB 직접 응답 확인
```

## 💾 파일 구조
```
services/
├── hybrid_cache_manager.py (수정 필요)
├── cache_manager.py
├── redis_cache_manager.py
└── ...

templates/
├── modern_index.html (수정 필요)
└── ...

data/cache/
├── popular_cache.db (삭제 확인 필요)
├── query_cache.db
└── document_validation.db
```

## ⚡ 우선순위 작업

### High Priority
1. **전체 캐시 초기화 완전 수정**
2. **RDB 삭제 검증**
3. **대화 초기화 추가**

### Medium Priority  
1. 프론트엔드 UI 개선
2. 테스트 스크립트 완성
3. 오류 처리 강화

## 🏠 집에서 작업할 것들

1. **`clear_all()` 함수 완전 재작성**
2. **RDB 파일 직접 삭제 로직 추가** 
3. **프론트엔드 대화 초기화 구현**
4. **검증 스크립트 작성 및 테스트**
5. **전체 시스템 통합 테스트**

---

*작업 일시: 2025-08-12*  
*다음 작업: 전체 캐시 초기화 완전 수정*