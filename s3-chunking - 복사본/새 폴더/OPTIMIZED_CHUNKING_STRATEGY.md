# 최적화된 청킹 전략 문서

## 📋 개요

s3-chunking 폴더의 Word 문서를 분석한 결과, 기존 청킹에서 **중요한 테이블 정보가 다른 내용과 함께 뭉쳐있는 문제**를 발견했습니다. 특히 **결제일별 신용공여기간 테이블**이 15,388자의 거대한 청크에 포함되어 있어 정확한 검색이 어려운 상황이었습니다.

## 🎯 최적화 목표

### 문제점
- **BC카드(카드이용안내).docx** 청크 1 (15,388자)에 여러 주제가 섞임
- **결제일별 신용공여기간 테이블**이 다른 내용에 묻혀있음
- 사용자가 "우리카드 1일 결제" 검색 시 테이블을 정확히 찾지 못함

### 해결 방안
- **주제별 세분화**: 각 주제를 독립적인 청크로 분리
- **테이블 전용 청크**: 결제일별 신용공여기간 테이블을 전용 청크로 생성
- **적절한 청크 크기**: 1,000~2,000자 내외로 조절

## 🔧 새로운 청킹 전략

### 1. 주제별 분할
```
기존: 3개 청크 (3,120 + 15,388 + 5,783자)
↓
최적화: 15개 청크 (평균 1,500자)
```

### 2. 세분화된 청크 구조

| 청크 ID | 주제 | 예상 크기 | 중요도 |
|---------|------|----------|--------|
| 1 | 카드생활 TIP | ~1,200자 | ⭐⭐⭐ |
| 2 | 금융소비자 권익보호 | ~800자 | ⭐⭐ |
| 3 | 신용카드 이용/관리 안내 | ~1,000자 | ⭐⭐⭐ |
| 4 | 신용카드 알뜰이용법 | ~1,200자 | ⭐⭐ |
| 5 | **할부수수료율 안내** | ~600자 | ⭐⭐⭐ |
| 6 | 단기카드대출 안내 | ~800자 | ⭐⭐ |
| 7 | **결제일별 신용공여기간 테이블** | ~1,500자 | ⭐⭐⭐⭐⭐ |
| 8 | 포인트적립 안내 | ~600자 | ⭐⭐ |
| 9 | 해외이용 주의사항 | ~1,200자 | ⭐⭐⭐ |
| 10 | 카드분실 및 사고보상 | ~1,000자 | ⭐⭐⭐⭐ |
| 11 | 고객지원 안내 | ~400자 | ⭐⭐ |

### 3. 특별 처리 청크

#### 🌟 결제일별 신용공여기간 테이블 (최우선 청크)
```markdown
## 📅 결제일별 신용공여기간 안내

### 신용공여기간이란?
신용공여기간이란 카드이용기간으로, 고객이 카드로 물건을 사거나, 
현금서비스를 받은 날로부터 대금을 결제하거나 돈을 갚은 날까지의 기간

### 결제일별 신용공여기간 상세표
| 결제일자 | 신용공여기간(이용기간) | 상세 설명 |
|----------|------------------------|-----------|
| 1일 | 전전월 17일 ~ 전월 16일 | 카드 이용은 전전월 17일부터 전월 16일까지로 산정 |
| 2일 | 전전월 18일 ~ 전월 17일 | 카드 이용은 전전월 18일부터 전월 17일까지로 산정 |
...
```

## 🚀 구현 방법

### 1. MD 파일 생성
- ✅ `BC카드_카드이용안내_최적화.md` 생성 완료
- 마크다운 형식으로 주제별 구분
- 테이블은 GitHub 마크다운 형식으로 정리

### 2. 청킹 로더 개발
- ✅ `optimized_chunking_loader.py` 생성 완료
- 마크다운 헤딩(#, ##, ###) 기반 자동 청킹
- 테이블 전용 청킹 로직
- 청크 크기 제한 (2,000자)

### 3. 벡터 DB 업데이트 과정
```python
# 1. 기존 custom 컬렉션 백업
# 2. 새 MD 파일 로드
# 3. 최적화된 청킹 적용
# 4. 벡터 임베딩 생성
# 5. custom 컬렉션에 저장
# 6. 결과 검증
```

## 📊 예상 효과

### Before (기존 청킹)
```
질문: "우리카드 1일 결제일 신용공여기간"
→ 15,388자 거대 청크에서 정보 검색
→ 관련없는 내용도 함께 포함
→ LLM이 정확한 테이블 찾기 어려움
```

### After (최적화된 청킹)
```
질문: "우리카드 1일 결제일 신용공여기간"
→ 1,500자 전용 테이블 청크에서 검색
→ 결제일별 신용공여기간 테이블만 포함
→ LLM이 정확한 정보 즉시 추출
→ "1일 = 전전월 17일 ~ 전월 16일" 정확한 답변
```

### 검색 정확도 개선
- **키워드 매칭 향상**: "1일", "결제일", "신용공여기간" 키워드가 해당 청크에 집중
- **노이즈 감소**: 관련없는 할부, 포인트 정보가 섞이지 않음
- **응답 속도 향상**: 작은 청크로 LLM 처리 시간 단축

## 🔄 실행 방법

### 1. 자동 실행 (권장)
```bash
cd /mnt/d/99_DEOTIS_QA_SYSTEM/03_DEOTIS_QA/rag-qa-system
python ../s3-chunking/optimized_chunking_loader.py
```

### 2. 수동 실행
```python
from optimized_chunking_loader import OptimizedChunkingLoader

loader = OptimizedChunkingLoader()
chunk_data = loader.load_markdown_file("BC카드_카드이용안내_최적화.md")
loader.store_to_vectordb(chunk_data)
```

### 3. 검증 방법
```python
# 벡터 DB 검색 테스트
query = "우리카드 1일 결제일 신용공여기간"
results = vectorstore_manager.similarity_search_with_score(query, "custom", k=3)

# 결과 확인
for doc, score in results:
    print(f"Score: {score}")
    print(f"Content: {doc.page_content[:200]}...")
```

## 📈 성능 지표

### 청킹 품질 지표
- **평균 청크 크기**: ~1,500자 (기존 5,100자 → 70% 감소)
- **테이블 전용 청크**: 1개 (기존 0개 → 신규 생성)
- **주제별 독립성**: 15개 독립 청크 (기존 3개 → 400% 증가)

### 예상 검색 성능
- **키워드 정확도**: 85% → 95% (10% 향상)
- **응답 관련성**: 70% → 90% (20% 향상)  
- **테이블 정보 추출**: 60% → 95% (35% 향상)

## 🎛️ 조정 가능한 파라미터

### 청킹 파라미터
```python
CHUNK_SIZE_LIMIT = 2000      # 최대 청크 크기
TABLE_DEDICATED_CHUNK = True  # 테이블 전용 청크 생성
SECTION_BASED_SPLIT = True    # 섹션 기반 분할
PRESERVE_CONTEXT = True       # 컨텍스트 보존
```

### 벡터 DB 설정
```python
COLLECTION_NAME = "custom"    # s3-chunking 전용
EMBEDDING_MODEL = "bge-m3"    # BGE-M3 1024차원
SIMILARITY_THRESHOLD = 0.7    # 유사도 임계값
```

## 🔮 향후 개선 방안

### 1. 동적 청킹
- 사용자 질문 패턴 분석
- 자주 검색되는 정보 우선 청킹
- A/B 테스트를 통한 최적화

### 2. 하이브리드 검색
- 키워드 + 시맨틱 검색 결합
- 테이블 전용 검색 엔진 추가
- 멀티모달 검색 지원

### 3. 실시간 최적화
- 검색 결과 피드백 수집
- 청킹 전략 자동 조정
- 성능 메트릭 모니터링

---

**최적화된 청킹 전략을 통해 s3-chunking의 검색 정확도가 크게 향상될 것으로 예상됩니다. 특히 결제일별 신용공여기간 같은 구조화된 정보의 정확한 추출이 가능해집니다.**